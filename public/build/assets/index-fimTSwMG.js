import{H as A}from"./app-BX_EKoAH.js";import{v as $}from"./video.es-BHW71Bob.js";class V{constructor(e,t,s){this.core=e,this.sharedState=t,this.config=s,this.lastCommentHitTime=0,this.commentHitThreshold=.5,this.proximityThreshold=2,this.boundTimeUpdateHandler=null}init(e,t){return this.$refs=e,this.$dispatch=t,this.boundTimeUpdateHandler=this.handleTimelineUpdate.bind(this),this}handleTimelineUpdate(){if(!this.sharedState.comments.length)return;const e=this.sharedState.currentTime,t=this.lastCommentHitTime;e>t&&this.detectCommentTimelineHits(t,e),this.lastCommentHitTime=e,this.updateNearbyComments(),this.checkCommentAutoHide()}detectCommentTimelineHits(e,t){this.sharedState.comments.filter(a=>{const n=a.timestamp||0;return n>e&&n<=t}).forEach(a=>{this.showCommentContext(a.commentId)})}updateNearbyComments(){const e=this.sharedState.currentTime;this.sharedState.nearbyComments=this.sharedState.comments.filter(t=>{const s=t.timestamp||0;return Math.abs(s-e)<=this.proximityThreshold})}showCommentContext(e){this.sharedState.activeComments.includes(e)||(this.sharedState.activeComments.push(e),this.setCommentAutoHideTimer(e),this.sharedState.contextDisplay.debugMode&&console.log(`[CommentSystem] Added comment ${e} to active context`))}hideCommentContext(e){const t=this.sharedState.activeComments.indexOf(e);t>-1&&(this.sharedState.activeComments.splice(t,1),this.sharedState.commentTimers[e]&&(clearTimeout(this.sharedState.commentTimers[e]),delete this.sharedState.commentTimers[e]),this.sharedState.contextDisplay.debugMode&&console.log(`[CommentSystem] Removed comment ${e} from active context`))}setCommentAutoHideTimer(e){this.sharedState.commentTimers[e]&&clearTimeout(this.sharedState.commentTimers[e]),this.sharedState.commentTimers[e]=setTimeout(()=>{this.hideCommentContext(e)},this.sharedState.contextDisplay.autoHideDelay)}checkCommentAutoHide(){}handleCommentClick(e,t){t&&t.stopPropagation(),!(!e||typeof e.timestamp!="number")&&(this.core.seekTo(e.timestamp),this.showCommentContext(e.commentId),this.$dispatch("video-annotation:comment-clicked",{comment:e,timestamp:e.timestamp}),this.sharedState.contextDisplay.debugMode&&console.log(`[CommentSystem] Comment clicked: ${e.commentId} at ${e.timestamp}s`))}handleCommentDoubleClick(e,t){var n;if(t&&t.stopPropagation(),!((n=this.config.annotations)!=null&&n.enableProgressBarComments))return;const s=this.sharedState.roundToNearestFrame(e),a=this.sharedState.getFrameNumber(s);this.$dispatch("video-annotation:add-comment",{timestamp:s,currentTime:s,frameNumber:a,frameRate:this.sharedState.frameRate}),this.sharedState.contextDisplay.debugMode&&console.log(`[CommentSystem] Double-click add comment at ${s}s (frame ${a})`)}getCommentBubblePosition(e,t){if(!e.timestamp||!this.sharedState.duration)return{left:0,zIndex:100};const s=e.timestamp/this.sharedState.duration*100,a=Math.max(0,Math.min(100,s)),n=this.sharedState.activeComments.includes(e.commentId),r=Math.abs(e.timestamp-this.sharedState.currentTime);let f=100;return n?f=200:r<=this.proximityThreshold&&(f=150),{left:a,zIndex:f}}calculateCommentOffset(e,t){if(!this.sharedState.comments||this.sharedState.comments.length<=1)return{left:0,top:0};const s=e.timestamp||0,a=this.sharedState.timeToPixel(s),r=24+4;let f=0,c=0;for(let u=0;u<t;u++){const p=this.sharedState.comments[u].timestamp||0,C=this.sharedState.timeToPixel(p),i=Math.abs(a-C);i<r&&(c+=8,c>24&&(f=r-i,c=0))}return{left:f,top:c}}renderCommentMarkers(){if(!(!this.$refs.progressBar||!this.sharedState.comments.length))return this.sharedState.comments.map((e,t)=>{const s=this.getCommentBubblePosition(e,t),a=this.calculateCommentOffset(e,t),n=this.sharedState.activeComments.includes(e.commentId),r=this.sharedState.nearbyComments.some(f=>f.commentId===e.commentId);return{comment:e,index:t,position:s,offset:a,isActive:n,isNearby:r,style:{left:`${s.left}%`,zIndex:s.zIndex,transform:`translate(${a.left}px, ${a.top}px)`}}})}getCommentContextContent(e){const t=this.sharedState.getComment(e);if(!t)return"";const s=this.formatTimestamp(t.timestamp),a=t.name||"Anonymous",n=t.body||"";return`${a} • ${s} - ${n}`}formatTimestamp(e){if(typeof e!="number"||e<0)return"0:00";const t=Math.floor(e/60),s=Math.floor(e%60);return`${t}:${s.toString().padStart(2,"0")}`}clearAllCommentTimers(){Object.values(this.sharedState.commentTimers).forEach(e=>{e&&clearTimeout(e)}),this.sharedState.commentTimers={}}clearActiveComments(){this.clearAllCommentTimers(),this.sharedState.activeComments=[],this.sharedState.contextDisplay.debugMode&&console.log("[CommentSystem] Cleared all active comments")}loadComment(e){const t=this.sharedState.getComment(e);t&&(this.core.seekTo(t.timestamp),this.showCommentContext(e))}addComment(e){this.sharedState.addComment(e),e.commentId&&this.showCommentContext(e.commentId),this.$dispatch("video-annotation:comment-added",{comment:e})}addCommentAtTime(e){const t=this.sharedState.frameRate||30,s=Math.floor(e*t)+1,n={commentId:this.sharedState.comments.length+1,avatar:"https://ui-avatars.com/api/?name=User&background=8b5cf6&color=fff",name:"User",body:`New comment at ${this.formatTimestamp(e)}`,timestamp:e,frameNumber:s,frameRate:t};return this.addComment(n),this.$dispatch("video-annotation:add-comment",{timestamp:e,frameNumber:s,frameRate:t}),console.log("[CommentSystem] Added comment at time:",e,"frame:",s),n}removeComment(e){this.sharedState.removeComment(e),this.$dispatch("video-annotation:comment-removed",{commentId:e})}enableTimeUpdates(){this.boundTimeUpdateHandler&&this.core.player&&this.core.player.on("timeupdate",this.boundTimeUpdateHandler)}disableTimeUpdates(){this.boundTimeUpdateHandler&&this.core.player&&this.core.player.off("timeupdate",this.boundTimeUpdateHandler)}dispose(){this.disableTimeUpdates(),this.clearAllCommentTimers(),this.sharedState.activeComments=[],this.sharedState.nearbyComments=[]}shouldShowTimelineDisplay(e){var n;if(!e||!e.commentId)return!1;const t=this.sharedState.activeComments.includes(e.commentId),s=Math.abs(e.timestamp-this.sharedState.currentTime)<=this.proximityThreshold,a=(n=this.sharedState.recentlyClickedComments)==null?void 0:n.includes(e.commentId);return t||s&&this.sharedState.isPlaying||a}handleTimelineCommentClick(e){!e||!e.commentId||(this.core.seekTo(e.timestamp),this.sharedState.recentlyClickedComments||(this.sharedState.recentlyClickedComments=[]),this.sharedState.recentlyClickedComments.includes(e.commentId)||this.sharedState.recentlyClickedComments.push(e.commentId),this.setCommentAutoHideTimer(e.commentId,this.config.timing.contextAutoHideDelay||5e3),this.$dispatch("video-annotation:show-comment-details",{comment:e,source:"timeline-display"}),this.sharedState.contextDisplay.debugMode&&console.log("[CommentSystem] Timeline comment clicked:",e.commentId))}setCommentAutoHideTimer(e,t=3e3){this.sharedState.commentTimers[e]&&clearTimeout(this.sharedState.commentTimers[e]),this.sharedState.commentTimers[e]=setTimeout(()=>{this.hideIndividualComment(e)},t)}hideIndividualComment(e){if(this.sharedState.recentlyClickedComments){const s=this.sharedState.recentlyClickedComments.indexOf(e);s>-1&&this.sharedState.recentlyClickedComments.splice(s,1)}const t=this.sharedState.activeComments.indexOf(e);t>-1&&this.sharedState.activeComments.splice(t,1),this.sharedState.commentTimers[e]&&(clearTimeout(this.sharedState.commentTimers[e]),delete this.sharedState.commentTimers[e]),this.sharedState.contextDisplay.debugMode&&console.log("[CommentSystem] Hidden individual comment:",e)}getAlpineMethods(){return{handleCommentClick:this.handleCommentClick.bind(this),handleCommentDoubleClick:this.handleCommentDoubleClick.bind(this),handleTimelineCommentClick:this.handleTimelineCommentClick.bind(this),loadComment:this.loadComment.bind(this),addComment:this.addComment.bind(this),removeComment:this.removeComment.bind(this),showCommentContext:this.showCommentContext.bind(this),hideCommentContext:this.hideCommentContext.bind(this),clearActiveComments:this.clearActiveComments.bind(this),shouldShowTimelineDisplay:this.shouldShowTimelineDisplay.bind(this),setCommentAutoHideTimer:this.setCommentAutoHideTimer.bind(this),hideIndividualComment:this.hideIndividualComment.bind(this),renderCommentMarkers:this.renderCommentMarkers.bind(this),getCommentContextContent:this.getCommentContextContent.bind(this),getCommentBubblePosition:this.getCommentBubblePosition.bind(this),calculateCommentOffset:this.calculateCommentOffset.bind(this),formatTimestamp:this.formatTimestamp.bind(this),get activeComments(){return this.sharedState.activeComments},get nearbyComments(){return this.sharedState.nearbyComments},get comments(){return this.sharedState.comments}}}}class F{constructor(e,t,s){var a;this.core=e,this.sharedState=t,this.config=s,this.contextElement=null,this.contextContent="",this.contextPosition={left:0,top:0},this.autoHideEnabled=!0,this.autoHideDelay=((a=s.timing)==null?void 0:a.contextAutoHideDelay)||3e3,this.autoHideTimer=null,this.availableModes=["time","comments","combined"],this.currentMode="combined",this.isAnimating=!1,this.animationDuration=200}init(e,t){return this.$refs=e,this.$dispatch=t,this.createContextElement(),this.setupTimelineHitDetection(),this}createContextElement(){this.contextElement||!this.$refs.videoContainer||(this.contextElement=document.createElement("div"),this.contextElement.className="video-annotation-context-display",this.contextElement.style.cssText=`
            position: absolute;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.4;
            max-width: 300px;
            word-wrap: break-word;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity ${this.animationDuration}ms ease, transform ${this.animationDuration}ms ease;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        `,this.$refs.videoContainer.appendChild(this.contextElement),this.sharedState.contextDisplay.debugMode&&console.log("[ContextDisplay] Created context element"))}show(e,t,s={}){if(!this.sharedState.contextDisplay.enabled||!this.contextElement)return;const{mode:a=this.currentMode,autoHide:n=this.autoHideEnabled,immediate:r=!1}=s;this.updateContent(e,a),this.updatePosition(t),r&&(this.contextElement.style.transition="none"),this.contextElement.style.opacity="1",this.contextElement.style.transform="translateY(0)",r&&setTimeout(()=>{this.contextElement&&(this.contextElement.style.transition=`opacity ${this.animationDuration}ms ease, transform ${this.animationDuration}ms ease`)},0),this.sharedState.contextDisplay.visible=!0,n&&this.setAutoHideTimer(),this.$dispatch("video-annotation:context-shown",{content:e,position:t,mode:a}),this.sharedState.contextDisplay.debugMode&&console.log(`[ContextDisplay] Shown with mode: ${a}`)}hide(e=!1){this.contextElement&&(this.clearAutoHideTimer(),e?(this.contextElement.style.transition="none",this.contextElement.style.opacity="0",this.contextElement.style.transform="translateY(10px)",setTimeout(()=>{this.contextElement&&(this.contextElement.style.transition=`opacity ${this.animationDuration}ms ease, transform ${this.animationDuration}ms ease`)},0)):(this.contextElement.style.opacity="0",this.contextElement.style.transform="translateY(10px)"),this.sharedState.contextDisplay.visible=!1,this.$dispatch("video-annotation:context-hidden"),this.sharedState.contextDisplay.debugMode&&console.log("[ContextDisplay] Hidden"))}updateContent(e,t=this.currentMode){if(!this.contextElement)return;this.contextContent=e,this.currentMode=t;let s="";switch(t){case"time":s=this.formatTimeContent(e);break;case"comments":s=this.formatCommentsContent(e);break;case"combined":s=this.formatCombinedContent(e);break;default:s=e}this.contextElement.innerHTML=s,this.sharedState.contextDisplay.content=s,this.sharedState.contextDisplay.mode=t}updatePosition(e){if(!this.contextElement||!e)return;const{left:t,top:s}=e,a=this.$refs.videoContainer.getBoundingClientRect(),n=this.contextElement.getBoundingClientRect();let r=t,f=s-n.height-10;r+n.width>a.width&&(r=a.width-n.width-10),r<10&&(r=10),f<10&&(f=s+30),this.contextElement.style.left=`${r}px`,this.contextElement.style.top=`${f}px`,this.sharedState.contextDisplay.position={left:r,top:f}}formatTimeContent(e){if(typeof e=="object"&&e.time!==void 0){const t=this.formatTimestamp(e.time),s=this.sharedState.getFrameNumber(e.time);return`
                <div class="context-time">
                    <div class="context-timestamp">${t}</div>
                    <div class="context-frame">Frame ${s}</div>
                </div>
            `}return e}formatCommentsContent(e){return Array.isArray(e)?e.map(t=>this.formatSingleComment(t)).join(""):typeof e=="object"&&e.commentId?this.formatSingleComment(e):e}formatSingleComment(e){const t=this.formatTimestamp(e.timestamp),s=e.name||"Anonymous",a=e.body||"",n=e.avatar||"";return`
            <div class="context-comment" data-comment-id="${e.commentId}">
                <div class="context-comment-header">
                    ${n?`<img src="${n}" class="context-comment-avatar" alt="${s}" />`:""}
                    <span class="context-comment-author">${s}</span>
                    <span class="context-comment-time">${t}</span>
                </div>
                <div class="context-comment-body">${a}</div>
            </div>
        `}formatCombinedContent(e){if(typeof e=="object"&&(e.time!==void 0||e.comments)){let t="";return e.time!==void 0&&(t+=this.formatTimeContent({time:e.time})),e.comments&&e.comments.length>0&&(t&&(t+='<hr class="context-divider" />'),t+=this.formatCommentsContent(e.comments)),t}return e}showTimeContext(e=null,t=null){const a={time:e!==null?e:this.sharedState.currentTime};this.show(a,t,{mode:"time"})}showCommentsContext(e,t=null){!Array.isArray(e)||e.length===0||this.show(e,t,{mode:"comments"})}showCombinedContext(e=null,t=null,s=null){const a=e!==null?e:this.sharedState.currentTime,n=t||this.getActiveComments(),r={time:a,comments:n};this.show(r,s,{mode:"combined"})}getActiveComments(){return this.sharedState.activeComments.map(e=>this.sharedState.getComment(e)).filter(e=>e!==void 0)}setAutoHideTimer(){this.clearAutoHideTimer(),this.autoHideEnabled&&(this.autoHideTimer=setTimeout(()=>{this.hide()},this.autoHideDelay))}clearAutoHideTimer(){this.autoHideTimer&&(clearTimeout(this.autoHideTimer),this.autoHideTimer=null)}enable(){this.sharedState.contextDisplay.enabled=!0,this.sharedState.contextDisplay.debugMode&&console.log("[ContextDisplay] Enabled")}disable(){this.sharedState.contextDisplay.enabled=!1,this.hide(!0),this.sharedState.contextDisplay.debugMode&&console.log("[ContextDisplay] Disabled")}toggle(){this.sharedState.contextDisplay.enabled?this.disable():this.enable()}setMode(e){this.availableModes.includes(e)&&(this.currentMode=e,this.sharedState.contextDisplay.mode=e,this.sharedState.contextDisplay.debugMode&&console.log(`[ContextDisplay] Mode set to: ${e}`))}formatTimestamp(e){if(typeof e!="number"||e<0)return"0:00";const t=Math.floor(e/60),s=Math.floor(e%60);return`${t}:${s.toString().padStart(2,"0")}`}getStatus(){return{enabled:this.sharedState.contextDisplay.enabled,visible:this.sharedState.contextDisplay.visible,mode:this.currentMode,autoHide:this.autoHideEnabled,hasContent:this.contextContent.length>0}}dispose(){this.clearAutoHideTimer(),this.contextElement&&this.contextElement.parentNode&&(this.contextElement.parentNode.removeChild(this.contextElement),this.contextElement=null),this.sharedState.contextDisplay.visible=!1,this.sharedState.contextDisplay.content="",this.sharedState.contextDisplay.debugMode&&console.log("[ContextDisplay] Disposed")}getDisplayContent(){const e=this.sharedState.currentTime,t=2,s=this.sharedState.comments.filter(n=>n.timestamp?Math.abs(n.timestamp-e)<=t:!1),a={primary:this.formatTimestamp(e),secondary:null,showCommentCount:!1,comment:null,isVisible:!1};if(s.length>0){const n=s[0],r=n.name||"Anonymous",f=this.formatTimestamp(n.timestamp),c=n.body||"";return{...a,secondary:`${r} • ${f} - ${c}`,comment:n,showCommentCount:s.length>1,commentCount:s.length,isVisible:!0}}return a}getRecentlyActiveComments(){return this.sharedState.commentDisplayTimers?Object.keys(this.sharedState.commentDisplayTimers).map(t=>this.sharedState.comments.find(s=>s.commentId==t)).filter(t=>t).sort((t,s)=>s.timestamp-t.timestamp):[]}setCommentAutoHideTimer(e){this.sharedState.commentDisplayTimers||(this.sharedState.commentDisplayTimers={}),this.sharedState.commentDisplayTimers[e]&&clearTimeout(this.sharedState.commentDisplayTimers[e]),this.sharedState.commentDisplayTimers[e]=setTimeout(()=>{this.hideCommentFromSecondaryContext(e),typeof document<"u"&&document.dispatchEvent(new CustomEvent("video-context-updated",{detail:{action:"comment-auto-hidden",commentId:e}})),console.log("[ContextDisplay] Auto-hid comment:",e)},3e3),console.log("[ContextDisplay] Set auto-hide timer for comment:",e)}setupTimelineHitDetection(){this.core.player&&this.core.player.on("timeupdate",()=>{this.updateTimelineHitDetection()}),typeof document<"u"&&document.addEventListener("video-time-updated",e=>{this.updateTimelineHitDetection()})}updateTimelineHitDetection(){const e=this.sharedState.currentTime,t=2,s=this.sharedState.comments.filter(a=>a.timestamp?Math.abs(a.timestamp-e)<=t:!1);s.length>0?(s.forEach(a=>{this.sharedState.commentDisplayTimers||(this.sharedState.commentDisplayTimers={}),this.sharedState.commentDisplayTimers[a.commentId]&&clearTimeout(this.sharedState.commentDisplayTimers[a.commentId]),this.sharedState.commentDisplayTimers[a.commentId]=setTimeout(()=>{this.hideCommentFromSecondaryContext(a.commentId)},3e3)}),this.sharedState.contextDisplay.nearbyComments=s.map(a=>({comment:a,distance:Math.abs(a.timestamp-e)}))):this.sharedState.contextDisplay.nearbyComments=[]}hideCommentFromSecondaryContext(e){this.sharedState.contextDisplay.nearbyComments&&(this.sharedState.contextDisplay.nearbyComments=this.sharedState.contextDisplay.nearbyComments.filter(t=>t.comment.commentId!==e)),this.sharedState.commentDisplayTimers&&this.sharedState.commentDisplayTimers[e]&&(clearTimeout(this.sharedState.commentDisplayTimers[e]),delete this.sharedState.commentDisplayTimers[e])}getAlpineMethods(){return{showContext:this.show.bind(this),hideContext:this.hide.bind(this),showTimeContext:this.showTimeContext.bind(this),showCommentsContext:this.showCommentsContext.bind(this),showCombinedContext:this.showCombinedContext.bind(this),getDisplayContent:this.getDisplayContent.bind(this),enableContext:this.enable.bind(this),disableContext:this.disable.bind(this),toggleContext:this.toggle.bind(this),setContextMode:this.setMode.bind(this),clearContextAutoHide:this.clearAutoHideTimer.bind(this),getContextStatus:this.getStatus.bind(this),formatTimestamp:this.formatTimestamp.bind(this),get contextVisible(){return this.sharedState.contextDisplay.visible},get contextEnabled(){return this.sharedState.contextDisplay.enabled},get contextMode(){return this.currentMode},get contextContent(){return this.contextContent}}}}class L{constructor(e,t,s){this.core=e,this.sharedState=t,this.config=s,this.eventListeners=new Map,this.globalEventListeners=new Map,this.keyboardShortcuts=new Map,this.keyboardEnabled=!0,this.lastPointerType=null,this.pointerTimeout=null,this.contextMenuActive=!1,this.contextMenuPosition={x:0,y:0},this.lastClickTime=0,this.doubleClickDelay=300,this.clickCount=0,this.clickTimer=null}init(e,t){return this.$refs=e,this.$dispatch=t,this.setupKeyboardShortcuts(),this.setupGlobalEventListeners(),this.setupVideoContainerEvents(),this}setupKeyboardShortcuts(){var t;const e={Space:()=>this.core.togglePlayPause(),ArrowLeft:()=>this.seekRelative(-5),ArrowRight:()=>this.seekRelative(5),ArrowUp:()=>this.adjustVolume(.1),ArrowDown:()=>this.adjustVolume(-.1),KeyF:()=>this.core.toggleFullscreen(),KeyM:()=>this.core.toggleMute(),Comma:()=>this.seekFrame(-1),Period:()=>this.seekFrame(1),Home:()=>this.core.seekTo(0),End:()=>this.core.seekTo(this.sharedState.duration),Digit1:()=>this.core.seekTo(this.sharedState.duration*.1),Digit2:()=>this.core.seekTo(this.sharedState.duration*.2),Digit3:()=>this.core.seekTo(this.sharedState.duration*.3),Digit4:()=>this.core.seekTo(this.sharedState.duration*.4),Digit5:()=>this.core.seekTo(this.sharedState.duration*.5),Digit6:()=>this.core.seekTo(this.sharedState.duration*.6),Digit7:()=>this.core.seekTo(this.sharedState.duration*.7),Digit8:()=>this.core.seekTo(this.sharedState.duration*.8),Digit9:()=>this.core.seekTo(this.sharedState.duration*.9),Digit0:()=>this.core.seekTo(0)};(t=this.config.keyboard)!=null&&t.shortcuts&&Object.assign(e,this.config.keyboard.shortcuts),Object.entries(e).forEach(([s,a])=>{this.keyboardShortcuts.set(s,a)}),this.sharedState.contextDisplay.debugMode&&console.log(`[EventHandler] Registered ${this.keyboardShortcuts.size} keyboard shortcuts`)}setupGlobalEventListeners(){this.addGlobalEventListener("keydown",this.handleKeydown.bind(this)),this.addGlobalEventListener("keyup",this.handleKeyup.bind(this)),this.addGlobalEventListener("resize",this.handleWindowResize.bind(this),window),this.addGlobalEventListener("blur",this.handleWindowBlur.bind(this),window),this.addGlobalEventListener("visibilitychange",this.handleVisibilityChange.bind(this),document),this.addGlobalEventListener("mousedown",this.handleGlobalPointerEvent.bind(this),document),this.addGlobalEventListener("touchstart",this.handleGlobalPointerEvent.bind(this),document,{passive:!0})}setupVideoContainerEvents(){if(!this.$refs.videoContainer)return;const e=this.$refs.videoContainer;this.addEventListener(e,"click",this.handleContainerClick.bind(this)),this.addEventListener(e,"dblclick",this.handleContainerDoubleClick.bind(this)),this.addEventListener(e,"contextmenu",this.handleContextMenu.bind(this)),this.addEventListener(e,"mouseenter",this.handleContainerMouseEnter.bind(this)),this.addEventListener(e,"mouseleave",this.handleContainerMouseLeave.bind(this)),this.addEventListener(e,"mousemove",this.handleContainerMouseMove.bind(this)),this.addEventListener(e,"focus",this.handleContainerFocus.bind(this)),this.addEventListener(e,"blur",this.handleContainerBlur.bind(this)),e.hasAttribute("tabindex")||e.setAttribute("tabindex","0"),this.sharedState.contextDisplay.debugMode&&console.log("[EventHandler] Video container events setup complete")}handleKeydown(e){if(!this.keyboardEnabled||this.shouldIgnoreKeyboard(e))return;const t=e.code||e.key,s=this.keyboardShortcuts.get(t);if(s){e.preventDefault(),e.stopPropagation();try{s(e),this.$dispatch("video-annotation:keyboard-shortcut",{key:t,event:e}),this.sharedState.contextDisplay.debugMode&&console.log(`[EventHandler] Keyboard shortcut executed: ${t}`)}catch(a){console.error(`[EventHandler] Error executing keyboard shortcut ${t}:`,a)}}}handleKeyup(e){this.$dispatch("video-annotation:keyup",{event:e})}handleContainerClick(e){this.$refs.videoContainer&&document.activeElement!==this.$refs.videoContainer&&this.$refs.videoContainer.focus(),this.trackClick(e),this.updatePointerType("mouse"),this.$dispatch("video-annotation:container-click",{event:e}),this.sharedState.contextDisplay.debugMode&&console.log("[EventHandler] Container clicked")}handleContainerDoubleClick(e){e.preventDefault(),this.clickTimer&&(clearTimeout(this.clickTimer),this.clickTimer=null),this.$dispatch("video-annotation:container-doubleclick",{event:e}),this.sharedState.contextDisplay.debugMode&&console.log("[EventHandler] Container double-clicked")}handleContextMenu(e){var t;if(!((t=this.config.ui)!=null&&t.enableContextMenu)){e.preventDefault();return}e.preventDefault(),this.contextMenuActive=!0,this.contextMenuPosition={x:e.clientX,y:e.clientY},this.$dispatch("video-annotation:context-menu",{x:e.clientX,y:e.clientY,event:e}),this.sharedState.contextDisplay.debugMode&&console.log("[EventHandler] Context menu requested")}handleContainerMouseEnter(e){this.updatePointerType("mouse"),this.$dispatch("video-annotation:mouse-enter",{event:e})}handleContainerMouseLeave(e){this.$dispatch("video-annotation:mouse-leave",{event:e})}handleContainerMouseMove(e){this.updatePointerType("mouse"),this.contextMenuActive&&(this.contextMenuActive=!1),this.$dispatch("video-annotation:mouse-move",{event:e})}handleContainerFocus(e){this.$dispatch("video-annotation:focus",{event:e}),this.sharedState.contextDisplay.debugMode&&console.log("[EventHandler] Container focused")}handleContainerBlur(e){this.$dispatch("video-annotation:blur",{event:e}),this.sharedState.contextDisplay.debugMode&&console.log("[EventHandler] Container blurred")}handleGlobalPointerEvent(e){const t=e.type.includes("touch")?"touch":"mouse";this.updatePointerType(t)}handleWindowResize(e){this.$refs.progressBar&&(this.sharedState.progressBarWidth=this.$refs.progressBar.getBoundingClientRect().width),this.$dispatch("video-annotation:window-resize",{event:e}),this.sharedState.contextDisplay.debugMode&&console.log("[EventHandler] Window resized")}handleWindowBlur(e){var t;(t=this.config.behavior)!=null&&t.pauseOnBlur&&this.sharedState.isPlaying&&this.core.togglePlayPause(),this.$dispatch("video-annotation:window-blur",{event:e})}handleVisibilityChange(e){var t;document.hidden&&(t=this.config.behavior)!=null&&t.pauseOnHidden&&this.sharedState.isPlaying&&this.core.togglePlayPause(),this.$dispatch("video-annotation:visibility-change",{hidden:document.hidden,event:e})}trackClick(e){const t=Date.now();t-this.lastClickTime<this.doubleClickDelay?this.clickCount++:this.clickCount=1,this.lastClickTime=t,this.clickTimer&&clearTimeout(this.clickTimer),this.clickTimer=setTimeout(()=>{this.clickCount===1&&this.$dispatch("video-annotation:single-click",{event:e}),this.clickCount=0,this.clickTimer=null},this.doubleClickDelay)}updatePointerType(e){this.lastPointerType!==e&&(this.lastPointerType=e,this.sharedState.touchInterface.activePointer=e,this.pointerTimeout&&clearTimeout(this.pointerTimeout),this.pointerTimeout=setTimeout(()=>{this.sharedState.touchInterface.activePointer=null,this.lastPointerType=null},5e3))}seekRelative(e){const t=Math.max(0,Math.min(this.sharedState.duration,this.sharedState.currentTime+e));this.core.seekTo(t)}seekFrame(e){const t=1/this.sharedState.frameRate,s=e*t;this.seekRelative(s),e>0?this.sharedState.frameNavigationDirection="forward":e<0&&(this.sharedState.frameNavigationDirection="backward"),setTimeout(()=>{this.sharedState.frameNavigationDirection=null},500)}stepForward(){this.seekFrame(1)}stepBackward(){this.seekFrame(-1)}adjustVolume(e){const t=Math.max(0,Math.min(1,this.sharedState.volume+e));this.core.setVolume(t)}shouldIgnoreKeyboard(e){const t=document.activeElement;return!!(t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.contentEditable==="true")||e.ctrlKey||e.altKey||e.metaKey)}addEventListener(e,t,s,a={}){e.addEventListener(t,s,a),this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push({type:t,handler:s,options:a})}addGlobalEventListener(e,t,s=document,a={}){if(!s||typeof s.addEventListener!="function"){console.error("[EventHandler] Invalid target for addEventListener:",s);return}try{s.addEventListener(e,t,a),this.globalEventListeners.has(s)||this.globalEventListeners.set(s,[]),this.globalEventListeners.get(s).push({type:e,handler:t,options:a})}catch(n){console.error(`[EventHandler] Failed to add event listener for ${e}:`,n)}}removeAllEventListeners(){for(const[e,t]of this.eventListeners)t.forEach(({type:s,handler:a,options:n})=>{e.removeEventListener(s,a,n)});this.eventListeners.clear();for(const[e,t]of this.globalEventListeners)t.forEach(({type:s,handler:a,options:n})=>{e.removeEventListener(s,a,n)});this.globalEventListeners.clear()}enableKeyboard(){this.keyboardEnabled=!0,this.sharedState.contextDisplay.debugMode&&console.log("[EventHandler] Keyboard shortcuts enabled")}disableKeyboard(){this.keyboardEnabled=!1,this.sharedState.contextDisplay.debugMode&&console.log("[EventHandler] Keyboard shortcuts disabled")}addKeyboardShortcut(e,t){this.keyboardShortcuts.set(e,t),this.sharedState.contextDisplay.debugMode&&console.log(`[EventHandler] Added keyboard shortcut: ${e}`)}removeKeyboardShortcut(e){this.keyboardShortcuts.delete(e),this.sharedState.contextDisplay.debugMode&&console.log(`[EventHandler] Removed keyboard shortcut: ${e}`)}dispose(){this.removeAllEventListeners(),this.clickTimer&&(clearTimeout(this.clickTimer),this.clickTimer=null),this.pointerTimeout&&(clearTimeout(this.pointerTimeout),this.pointerTimeout=null),this.keyboardShortcuts.clear(),this.sharedState.contextDisplay.debugMode&&console.log("[EventHandler] Disposed")}getAlpineMethods(){return{enableKeyboard:this.enableKeyboard.bind(this),disableKeyboard:this.disableKeyboard.bind(this),addKeyboardShortcut:this.addKeyboardShortcut.bind(this),removeKeyboardShortcut:this.removeKeyboardShortcut.bind(this),seekRelative:this.seekRelative.bind(this),seekFrame:this.seekFrame.bind(this),stepForward:this.stepForward.bind(this),stepBackward:this.stepBackward.bind(this),adjustVolume:this.adjustVolume.bind(this),updatePointerType:this.updatePointerType.bind(this),get keyboardEnabled(){return this.keyboardEnabled},get lastPointerType(){return this.lastPointerType},get contextMenuActive(){return this.contextMenuActive}}}}class H{constructor(e,t,s){this.core=e,this.sharedState=t,this.config=s,this.isDragging=!1,this.wasPlayingBeforeDrag=!1,this.dragStartX=0,this.dragCurrentTime=0,this.showSeekCircle=!1,this.boundHandleDragMove=null,this.boundEndDrag=null}init(e,t){return this.$refs=e,this.$dispatch=t,this}handleProgressBarPointer(e,t="click"){var u,S,p;if(!this.$refs.progressBar||!this.sharedState.duration)return;const s=this.$refs.progressBar.getBoundingClientRect(),r=((e.type.includes("touch")||e.pointerType==="touch")&&((S=(u=e.touches)==null?void 0:u[0])==null?void 0:S.clientX)||e.clientX)-s.left,f=Math.max(0,Math.min(1,r/s.width)),c=f*this.sharedState.duration;if(this.core&&this.core.seekTo&&this.core.seekTo(c),this.sharedState.hoverX=r,this.dragCurrentTime=c,t==="doubleclick"&&(p=this.config.annotations)!=null&&p.enableProgressBarComments){const C=this.core.roundToNearestFrame?this.core.roundToNearestFrame(c):c,i=this.core.getFrameNumber?this.core.getFrameNumber(C):Math.floor(C*30);this.$dispatch("video-annotation:add-comment",{timestamp:C,currentTime:C,frameNumber:i,frameRate:this.core.getFrameRate?this.core.getFrameRate():30})}return this.$dispatch("video-annotation:seek",{timestamp:c,percentage:f,action:t}),!0}handleProgressBarClick(e,t="click"){return this.handleProgressBarPointer(e,t)}handleProgressBarDragStart(e){if(!this.handlePointerStart(e,"progressbar-drag"))return;this.wasPlayingBeforeDrag=this.sharedState.isPlaying,this.isDragging=!0,this.showSeekCircle=!0,this.sharedState.showProgressBar=!0,this.sharedState.progressBarTimeout&&(clearTimeout(this.sharedState.progressBarTimeout),this.sharedState.progressBarTimeout=null);const t=this.$refs.progressBar;if(!t)return;const s=t.getBoundingClientRect(),a=e.type.includes("touch"),n=a?e.touches[0].clientX:e.clientX;this.dragStartX=n-s.left;const r=this.dragStartX/s.width;this.dragCurrentTime=r*this.sharedState.duration;const f=a?"touchmove":"mousemove",c=a?"touchend":"mouseup";this.boundHandleDragMove=this.handleProgressBarDragMove.bind(this),this.boundEndDrag=this.handleProgressBarDragEnd.bind(this),document.addEventListener(f,this.boundHandleDragMove,{passive:!1}),document.addEventListener(c,this.boundEndDrag)}handleProgressBarDragMove(e){if(!this.isDragging)return;this.handlePointerMove(e);const t=this.$refs.progressBar;if(!t)return;const s=t.getBoundingClientRect();let r=(e.type.includes("touch")?e.touches[0].clientX:e.clientX)-s.left;r=Math.max(0,Math.min(r,s.width)),this.sharedState.hoverX=r;const f=r/s.width;this.dragCurrentTime=f*this.sharedState.duration}handleProgressBarDragEnd(e){if(!this.isDragging)return;this.handlePointerEnd(e,"progressbar-drag"),this.dragCurrentTime>=0&&this.dragCurrentTime<=this.sharedState.duration&&this.core.seekTo(this.dragCurrentTime),this.wasPlayingBeforeDrag&&this.core.player&&this.core.player.play(),this.isDragging=!1,this.showSeekCircle=!1,this.dragCurrentTime=0;const t=e.type.includes("touch")?"touchmove":"mousemove",s=e.type.includes("touch")?"touchend":"mouseup";this.boundHandleDragMove&&(document.removeEventListener(t,this.boundHandleDragMove),this.boundHandleDragMove=null),this.boundEndDrag&&(document.removeEventListener(s,this.boundEndDrag),this.boundEndDrag=null)}handleProgressBarHover(e){if(!this.$refs.progressBar||this.isDragging)return;const t=this.$refs.progressBar.getBoundingClientRect();this.sharedState.hoverX=e.clientX-t.left;const a=this.sharedState.hoverX/t.width*this.sharedState.duration;this.sharedState.hoverTime=a}handleProgressBarLeave(){this.isDragging||(this.sharedState.showHoverAdd=!1)}handlePointerStart(e,t){return e.type.includes("touch")&&e.preventDefault(),!0}handlePointerMove(e){e.type.includes("touch")&&e.preventDefault()}handlePointerEnd(e,t){return!0}getProgressPercentage(){return this.sharedState.duration?this.sharedState.currentTime/this.sharedState.duration*100:0}getBufferedPercentage(){return this.sharedState.bufferedPercentage||0}pixelToTime(e){if(!this.$refs.progressBar||!this.sharedState.duration)return 0;const t=this.$refs.progressBar.getBoundingClientRect();return Math.max(0,Math.min(1,e/t.width))*this.sharedState.duration}timeToPixel(e){if(!this.$refs.progressBar||!this.sharedState.duration)return 0;const t=this.$refs.progressBar.getBoundingClientRect();return e/this.sharedState.duration*t.width}updateProgressBarWidth(){this.$refs.progressBar&&(this.sharedState.progressBarWidth=this.$refs.progressBar.getBoundingClientRect().width)}get publicAPI(){return{handleProgressBarClick:this.handleProgressBarClick.bind(this),handleProgressBarDragStart:this.handleProgressBarDragStart.bind(this),handleProgressBarHover:this.handleProgressBarHover.bind(this),handleProgressBarLeave:this.handleProgressBarLeave.bind(this),getProgressPercentage:this.getProgressPercentage.bind(this),getBufferedPercentage:this.getBufferedPercentage.bind(this),pixelToTime:this.pixelToTime.bind(this),timeToPixel:this.timeToPixel.bind(this),updateProgressBarWidth:this.updateProgressBarWidth.bind(this),isDragging:()=>this.isDragging,dragCurrentTime:()=>this.dragCurrentTime}}}class I{constructor(e,t,s){this.core=e,this.sharedState=t,this.config=s,this.creationInProgress=!1,this.creationStartTime=null,this.tempRegion=null,this.editingRegion=null,this.resizeHandle=null,this.resizeStartX=0,this.resizeOriginalTime=0,this.hoveredRegion=null,this.selectedRegion=null}init(e,t){return this.$refs=e,this.$dispatch=t,this}startRegionCreation(){var e;(e=this.config.annotations)!=null&&e.enableVideoAnnotations&&(this.creationInProgress=!0,this.creationStartTime=this.sharedState.currentTime,this.sharedState.touchInterface.mode="REGION_CREATE",this.tempRegion={id:`temp-${Date.now()}`,startTime:this.creationStartTime,endTime:this.creationStartTime,title:"",description:"",temporary:!0},this.sharedState.isPlaying&&this.core.togglePlayPause(),this.$dispatch("video-annotation:region-creation-started",{startTime:this.creationStartTime}),this.sharedState.contextDisplay.debugMode&&console.log(`[RegionManagement] Started region creation at ${this.creationStartTime}s`))}startRegionCreationAtTime(e){var t;if((t=this.config.annotations)!=null&&t.enableVideoAnnotations)return this.creationInProgress=!0,this.creationStartTime=e,this.sharedState.touchInterface.mode="REGION_CREATE",this.tempRegion={id:`temp-${Date.now()}`,startTime:this.creationStartTime,endTime:this.creationStartTime,title:"",description:"",temporary:!0},this.core.seekTo(e),this.sharedState.isPlaying&&this.core.togglePlayPause(),this.$dispatch("video-annotation:region-creation-started",{startTime:this.creationStartTime}),this.sharedState.contextDisplay.debugMode&&console.log(`[RegionManagement] Started region creation at ${this.creationStartTime}s`),this.tempRegion}startRegionCreationAtCurrentFrame(){var f;if(!((f=this.config.annotations)!=null&&f.enableVideoAnnotations))return;const e=this.sharedState.currentTime,t=this.sharedState.roundToNearestFrame?this.sharedState.roundToNearestFrame(e):e,s=this.sharedState.getFrameNumber?this.sharedState.getFrameNumber(t):Math.floor(t*(this.sharedState.frameRate||30));if(this.creationInProgress=!0,this.creationStartTime=t,this.sharedState.touchInterface.mode="REGION_CREATE",this.sharedState.isCreatingRegion=!0,this.sharedState.showRegionToolbar=!0,this.$refs&&this.$refs.regionBar){const u=this.$refs.regionBar.getBoundingClientRect(),S=t/this.sharedState.duration*100,p=S/100*u.width,i=Math.min(this.sharedState.duration,t+10),o=i/this.sharedState.duration*100,h=o/100*u.width;this.sharedState.regionCreationStart={x:p,time:t,percentage:S},this.sharedState.regionCreationEnd={x:h,time:i,percentage:o}}const n=Math.min(this.sharedState.duration,t+10),r=this.sharedState.getFrameNumber?this.sharedState.getFrameNumber(n):Math.floor(n*(this.sharedState.frameRate||30));return this.tempRegion={id:`temp-${Date.now()}`,startTime:this.creationStartTime,endTime:n,startFrame:s,endFrame:r,title:"",description:"",temporary:!0},this.core.seekTo(t),this.sharedState.isPlaying&&this.core.togglePlayPause(),this.$dispatch("video-annotation:region-creation-started",{startTime:this.creationStartTime,frameNumber:s,frameRate:this.sharedState.frameRate}),this.sharedState.contextDisplay.debugMode&&console.log(`[RegionManagement] Started region creation at frame ${s} (${t}s)`),this.tempRegion}updateRegionCreation(e){if(!this.creationInProgress||!this.tempRegion)return;const t=this.creationStartTime;e>t?this.tempRegion.endTime=e:(this.tempRegion.startTime=e,this.tempRegion.endTime=t),this.$dispatch("video-annotation:region-preview-updated",{region:{...this.tempRegion}})}finishRegionCreation(){if(!this.creationInProgress||!this.tempRegion)return;const e={id:`region-${Date.now()}`,startTime:this.tempRegion.startTime,endTime:this.tempRegion.endTime,startFrame:this.sharedState.getFrameNumber(this.tempRegion.startTime),endFrame:this.sharedState.getFrameNumber(this.tempRegion.endTime),title:`Region ${this.sharedState.regions.length+1}`,description:"",color:this.getNextRegionColor(),temporary:!1};return this.sharedState.addRegion(e),this.creationInProgress=!1,this.creationStartTime=null,this.tempRegion=null,this.sharedState.touchInterface.mode="NORMAL",this.$dispatch("video-annotation:region-created",{region:e}),this.sharedState.contextDisplay.debugMode&&console.log(`[RegionManagement] Created region: ${e.id} (${e.startTime}s - ${e.endTime}s)`),e}cancelRegionCreation(){this.creationInProgress&&(this.creationInProgress=!1,this.creationStartTime=null,this.tempRegion=null,this.sharedState.touchInterface.mode="NORMAL",this.$dispatch("video-annotation:region-creation-cancelled"),this.sharedState.contextDisplay.debugMode&&console.log("[RegionManagement] Cancelled region creation"))}selectRegion(e){const t=this.sharedState.getRegion(e);t&&(this.selectedRegion=t,this.sharedState.activeRegion=t,this.$dispatch("video-annotation:region-selected",{region:t}),this.sharedState.contextDisplay.debugMode&&console.log(`[RegionManagement] Selected region: ${e}`))}deselectRegion(){this.selectedRegion=null,this.sharedState.activeRegion=null,this.$dispatch("video-annotation:region-deselected")}startRegionEdit(e,t=null){const s=this.sharedState.getRegion(e);s&&(this.editingRegion=s,this.resizeHandle=t,this.sharedState.touchInterface.mode="REGION_EDIT",this.$dispatch("video-annotation:region-edit-started",{region:s,handle:this.resizeHandle}),this.sharedState.contextDisplay.debugMode&&console.log(`[RegionManagement] Started editing region: ${e} (handle: ${t})`))}updateRegionEdit(e){if(!this.editingRegion)return;const t=this.editingRegion;if(this.resizeHandle==="start")e<t.endTime&&(t.startTime=e,t.startFrame=this.sharedState.getFrameNumber(e));else if(this.resizeHandle==="end")e>t.startTime&&(t.endTime=e,t.endFrame=this.sharedState.getFrameNumber(e));else{const s=t.endTime-t.startTime;t.startTime=e,t.endTime=e+s,t.startFrame=this.sharedState.getFrameNumber(t.startTime),t.endFrame=this.sharedState.getFrameNumber(t.endTime)}this.$dispatch("video-annotation:region-updated",{region:t})}finishRegionEdit(){if(!this.editingRegion)return;const e=this.editingRegion;this.editingRegion=null,this.resizeHandle=null,this.sharedState.touchInterface.mode="NORMAL",this.$dispatch("video-annotation:region-edit-finished",{region:e}),this.sharedState.contextDisplay.debugMode&&console.log(`[RegionManagement] Finished editing region: ${e.id}`)}deleteRegion(e){var s,a;this.sharedState.getRegion(e)&&(this.sharedState.removeRegion(e),((s=this.editingRegion)==null?void 0:s.id)===e&&(this.editingRegion=null,this.resizeHandle=null,this.sharedState.touchInterface.mode="NORMAL"),((a=this.selectedRegion)==null?void 0:a.id)===e&&(this.selectedRegion=null),this.$dispatch("video-annotation:region-deleted",{regionId:e}),this.sharedState.contextDisplay.debugMode&&console.log(`[RegionManagement] Deleted region: ${e}`))}toggleRegionVisibility(e){this.sharedState.hiddenRegions.has(e)?this.sharedState.hiddenRegions.delete(e):this.sharedState.hiddenRegions.add(e),this.$dispatch("video-annotation:region-visibility-toggled",{regionId:e,hidden:this.sharedState.hiddenRegions.has(e)})}getRegionPosition(e){if(!e||!this.sharedState.duration)return{left:0,width:0};const t=e.startTime/this.sharedState.duration*100,a=e.endTime/this.sharedState.duration*100-t;return{left:Math.max(0,Math.min(100,t)),width:Math.max(0,Math.min(100-t,a))}}getVisibleRegions(){return this.sharedState.regions.filter(e=>!this.sharedState.hiddenRegions.has(e.id)).map(e=>{var t,s,a,n;return{...e,position:this.getRegionPosition(e),isActive:((t=this.sharedState.activeRegion)==null?void 0:t.id)===e.id,isSelected:((s=this.selectedRegion)==null?void 0:s.id)===e.id,isEditing:((a=this.editingRegion)==null?void 0:a.id)===e.id,isHovered:((n=this.hoveredRegion)==null?void 0:n.id)===e.id}})}getCurrentRegions(){return this.sharedState.getActiveRegions()}getNextRegionColor(){const e=["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#84cc16","#f97316"];return e[this.sharedState.regions.length%e.length]}handleRegionHover(e,t){const s=this.sharedState.getRegion(e);s&&(this.hoveredRegion=s,this.sharedState.showRegionTooltip=e,this.$dispatch("video-annotation:region-hovered",{region:s,event:t}))}handleRegionHoverEnd(e){var t;((t=this.hoveredRegion)==null?void 0:t.id)===e&&(this.hoveredRegion=null),this.sharedState.showRegionTooltip===e&&(this.sharedState.showRegionTooltip=null),this.$dispatch("video-annotation:region-hover-ended",{regionId:e})}handleRegionClick(e,t){t&&t.stopPropagation();const s=this.sharedState.getRegion(e);s&&(this.selectRegion(e),this.core.seekTo(s.startTime),this.$dispatch("video-annotation:region-clicked",{region:s}))}updateRegionMetadata(e,t){const s=this.sharedState.getRegion(e);s&&(Object.assign(s,t),this.$dispatch("video-annotation:region-metadata-updated",{region:s}))}exportRegions(){return this.sharedState.regions.map(e=>({id:e.id,startTime:e.startTime,endTime:e.endTime,startFrame:e.startFrame,endFrame:e.endFrame,title:e.title,description:e.description,color:e.color}))}importRegions(e){Array.isArray(e)&&(e.forEach(t=>{const s={...t,id:t.id||`region-${Date.now()}-${Math.random()}`};this.sharedState.addRegion(s)}),this.$dispatch("video-annotation:regions-imported",{count:e.length}))}dispose(){this.cancelRegionCreation(),this.editingRegion=null,this.selectedRegion=null,this.hoveredRegion=null,this.sharedState.showRegionTooltip=null}getAlpineMethods(){return{startRegionCreation:this.startRegionCreation.bind(this),startRegionCreationAtTime:this.startRegionCreationAtTime.bind(this),startRegionCreationAtCurrentFrame:this.startRegionCreationAtCurrentFrame.bind(this),updateRegionCreation:this.updateRegionCreation.bind(this),finishRegionCreation:this.finishRegionCreation.bind(this),cancelRegionCreation:this.cancelRegionCreation.bind(this),selectRegion:this.selectRegion.bind(this),deselectRegion:this.deselectRegion.bind(this),startRegionEdit:this.startRegionEdit.bind(this),updateRegionEdit:this.updateRegionEdit.bind(this),finishRegionEdit:this.finishRegionEdit.bind(this),deleteRegion:this.deleteRegion.bind(this),toggleRegionVisibility:this.toggleRegionVisibility.bind(this),updateRegionMetadata:this.updateRegionMetadata.bind(this),handleRegionClick:this.handleRegionClick.bind(this),handleRegionHover:this.handleRegionHover.bind(this),handleRegionHoverEnd:this.handleRegionHoverEnd.bind(this),getVisibleRegions:this.getVisibleRegions.bind(this),getCurrentRegions:this.getCurrentRegions.bind(this),getRegionPosition:this.getRegionPosition.bind(this),exportRegions:this.exportRegions.bind(this),importRegions:this.importRegions.bind(this),get regions(){return this.sharedState.regions},get activeRegion(){return this.sharedState.activeRegion},get regionCreationActive(){return this.creationInProgress},get tempRegion(){return this.tempRegion},get editingRegion(){return this.editingRegion},get selectedRegion(){return this.selectedRegion}}}}class N{constructor(e,t=[],s=[]){var a,n,r,f;this.config=e,this.videoLoaded=!1,this.duration=0,this.currentTime=0,this.isPlaying=!1,this.volume=1,this.isMuted=!1,this.isFullscreen=!1,this.bufferedPercentage=0,this.qualitySources=[],this.currentResolution=null,this.currentResolutionSrc=null,this.progressBarMode=((a=e.ui)==null?void 0:a.progressBarMode)||"always",this.showProgressBar=this.progressBarMode==="always",this.progressBarTimeout=null,this.progressBarWidth=0,this.isDragging=!1,this.hoverX=0,this.hoverTime=0,this.showHoverAdd=!1,this.wasPlayingBeforeDrag=!1,this.dragStartX=0,this.dragCurrentTime=0,this.showSeekCircle=!1,this.touchInterface={mode:"NORMAL",isEnabled:!0,enabled:!0,hammer:null,gestureInProgress:!1,lastTapTime:0,tapCount:0,activePointer:null,contextMenuVisible:!1,unifiedTimelineVisible:!1,actionModalVisible:!1},this.pointerState={isDown:!1,startTime:0,startPos:{x:0,y:0},currentPos:{x:0,y:0},hasMoved:!1,longPressTriggered:!1,ghostClickPrevention:!1,activePointer:null},this.showTooltip=!1,this.tooltipTimeout=null,this.tooltipPosition={left:0,top:0},this.arrowPosition="center",this.comments=t||[],this.activeComments=[],this.commentTimers={},this.nearbyComments=[],this.recentlyClickedComments=[],this.commentDisplayTimers={},this.regions=s||[],localStorage.getItem("videoAnnotationDebug")==="true"&&console.log("[SharedState] Initialized with regions:",this.regions.length,this.regions),this.activeRegion=null,this.regionCreationActive=!1,this.regionStartTime=null,this.regionEndTime=null,this.showRegionTooltip=null,this.hiddenRegions=new Set,this.showSpeedMenu=!1,this.showSpeedModal=!1,this.showVolumeModal=!1,this.showVolumeSlider=!1,this.showSettingsMenu=!1,this.showResolutionMenu=!1,this.mobileControlsExpanded=!1,this.showContextMenu=!1,this.contextMenuX=0,this.contextMenuY=0,this.contextMenuTime=0,this.contextDisplay={mode:"time",visible:!1,autoHide:!0,autoHideDelay:((n=e.timing)==null?void 0:n.contextAutoHideDelay)||3e3,timeout:null,debugMode:((r=e.debug)==null?void 0:r.contextSystem)||!1,nearbyComments:[],currentDisplayComment:null,enabled:!0,position:{left:0,top:0},content:""},this.frameRate=((f=e==null?void 0:e.video)==null?void 0:f.frameRate)||30,this.currentFrameNumber=0,this.frameNavigationDirection=null,this.showFrameHelpers=!0,this.showPlayPauseOverlay=!1,this.eventListeners=new Map,this.globalEventListeners=new Map}get currentFrameState(){if(!this.duration)return{frameNumber:1,totalFrames:1,percentage:0};const e=Math.ceil(this.duration*this.frameRate),t=Math.floor(this.currentTime*this.frameRate)+1,s=(t-1)/e*100;return{frameNumber:Math.max(1,Math.min(t,e)),totalFrames:e,percentage:Math.max(0,Math.min(100,s))}}get frameAlignedProgressPercentage(){return this.currentFrameState.percentage}get isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}roundToNearestFrame(e){const t=1/this.frameRate;return Math.round(e/t)*t}getFrameNumber(e){return Math.floor(e*this.frameRate)+1}timeToPixel(e){return!this.duration||!this.progressBarWidth?0:e/this.duration*this.progressBarWidth}pixelToTime(e){return!this.duration||!this.progressBarWidth?0:Math.max(0,Math.min(1,e/this.progressBarWidth))*this.duration}addComment(e){!e||typeof e.timestamp!="number"||(this.comments.push(e),this.sortCommentsByTimestamp())}removeComment(e){this.comments=this.comments.filter(t=>t.commentId!==e),this.activeComments=this.activeComments.filter(t=>t!==e),this.commentTimers[e]&&(clearTimeout(this.commentTimers[e]),delete this.commentTimers[e])}sortCommentsByTimestamp(){this.comments.sort((e,t)=>(e.timestamp||0)-(t.timestamp||0))}getComment(e){return this.comments.find(t=>t.commentId===e)}getCommentsInRange(e,t){return this.comments.filter(s=>s.timestamp>=e&&s.timestamp<=t)}addRegion(e){!e||typeof e.startTime!="number"||typeof e.endTime!="number"||(this.regions.push(e),this.sortRegionsByStartTime())}removeRegion(e){var t;this.regions=this.regions.filter(s=>s.id!==e),this.hiddenRegions.delete(e),((t=this.activeRegion)==null?void 0:t.id)===e&&(this.activeRegion=null)}sortRegionsByStartTime(){this.regions.sort((e,t)=>(e.startTime||0)-(t.startTime||0))}getRegion(e){return this.regions.find(t=>t.id===e)}getActiveRegions(){return this.regions.filter(e=>this.currentTime>=e.startTime&&this.currentTime<=e.endTime)}clearAllTimeouts(){this.progressBarTimeout&&(clearTimeout(this.progressBarTimeout),this.progressBarTimeout=null),this.tooltipTimeout&&(clearTimeout(this.tooltipTimeout),this.tooltipTimeout=null),this.contextDisplay.timeout&&(clearTimeout(this.contextDisplay.timeout),this.contextDisplay.timeout=null),Object.values(this.commentTimers).forEach(e=>{e&&clearTimeout(e)}),this.commentTimers={},this.commentDisplayTimers&&(Object.values(this.commentDisplayTimers).forEach(e=>{e&&clearTimeout(e)}),this.commentDisplayTimers={})}reset(){this.clearAllTimeouts(),this.videoLoaded=!1,this.duration=0,this.currentTime=0,this.isPlaying=!1,this.bufferedPercentage=0,this.isDragging=!1,this.hoverX=0,this.hoverTime=0,this.showHoverAdd=!1,this.showSeekCircle=!1,this.touchInterface.mode="NORMAL",this.touchInterface.gestureInProgress=!1,this.touchInterface.activePointer=null,this.showTooltip=!1,this.activeComments=[],this.nearbyComments=[],this.activeRegion=null,this.regionCreationActive=!1,this.contextDisplay.visible=!1,this.contextDisplay.currentDisplayComment=null,this.contextDisplay.nearbyComments=[]}toJSON(){return{videoLoaded:this.videoLoaded,duration:this.duration,currentTime:this.currentTime,isPlaying:this.isPlaying,volume:this.volume,isMuted:this.isMuted,isFullscreen:this.isFullscreen,bufferedPercentage:this.bufferedPercentage,progressBarMode:this.progressBarMode,showProgressBar:this.showProgressBar,isDragging:this.isDragging,touchInterface:{...this.touchInterface},comments:this.comments.length,activeComments:this.activeComments.length,regions:this.regions.length,contextDisplay:{...this.contextDisplay},frameState:this.currentFrameState}}}class O{constructor(e,t,s){this.core=e,this.sharedState=t,this.config=s,this.hammer=null,this.gestureInProgress=!1,this.lastTapTime=0,this.tapCount=0,this.doubleTapDelay=300,this.activePointers=new Map,this.lastTouchTime=0,this.volumeGestureActive=!1,this.initialVolume=1,this.volumeGestureStartY=0,this.seekGestureActive=!1,this.seekGestureStartX=0,this.seekGestureStartTime=0,this.brightnessGestureActive=!1,this.minSwipeDistance=50,this.minSwipeVelocity=.3,this.volumeGestureSensitivity=300,this.seekGestureSensitivity=120}init(e,t){return this.$refs=e,this.$dispatch=t,this.$refs.videoContainer&&(this.setupHammer(),this.setupTouchEventListeners()),this}setupHammer(){if(!this.$refs.videoContainer||this.hammer)return;const e=this.$refs.videoContainer;this.hammer=new A(e),this.hammer.get("pan").set({direction:A.DIRECTION_ALL,threshold:10,pointers:1}),this.hammer.get("swipe").set({direction:A.DIRECTION_ALL,threshold:this.minSwipeDistance,velocity:this.minSwipeVelocity}),this.hammer.get("tap").set({taps:1,interval:this.doubleTapDelay,threshold:10}),this.hammer.get("doubletap").set({taps:2,interval:this.doubleTapDelay,threshold:10}),this.setupGestureHandlers(),this.sharedState.contextDisplay.debugMode&&console.log("[TouchInterface] Hammer.js initialized")}setupGestureHandlers(){this.hammer&&(this.hammer.on("tap",e=>{this.handleTap(e)&&(e.preventDefault(),e.srcEvent.preventDefault())}),this.hammer.on("doubletap",e=>{this.handleDoubleTap(e)&&(e.preventDefault(),e.srcEvent.preventDefault())}),this.hammer.on("panstart",e=>{this.handlePanStart(e)&&(e.preventDefault(),e.srcEvent.preventDefault())}),this.hammer.on("panmove",e=>{this.handlePanMove(e)&&(e.preventDefault(),e.srcEvent.preventDefault())}),this.hammer.on("panend",e=>{this.handlePanEnd(e)&&(e.preventDefault(),e.srcEvent.preventDefault())}),this.hammer.on("swipeleft",e=>{this.handleSwipeLeft(e)&&(e.preventDefault(),e.srcEvent.preventDefault())}),this.hammer.on("swiperight",e=>{this.handleSwipeRight(e)&&(e.preventDefault(),e.srcEvent.preventDefault())}),this.hammer.on("swipeup",e=>{this.handleSwipeUp(e)&&(e.preventDefault(),e.srcEvent.preventDefault())}),this.hammer.on("swipedown",e=>{this.handleSwipeDown(e)&&(e.preventDefault(),e.srcEvent.preventDefault())}))}setupTouchEventListeners(){if(!this.$refs.videoContainer)return;const e=this.$refs.videoContainer;e.addEventListener("touchstart",t=>{this.handleTouchStart(t)},{passive:!1}),e.addEventListener("touchend",t=>{this.handleTouchEnd(t)},{passive:!1})}handleTap(e){var t;return this.sharedState.touchInterface.mode!=="NORMAL"?!1:(this.core.togglePlayPause(),(t=this.config.annotations)!=null&&t.enableHapticFeedback&&navigator.vibrate&&navigator.vibrate(50),this.$dispatch("video-annotation:tap",{event:e,currentTime:this.sharedState.currentTime}),this.sharedState.contextDisplay.debugMode&&console.log("[TouchInterface] Single tap - play/pause toggle"),!0)}handleDoubleTap(e){var t;return this.sharedState.touchInterface.mode!=="NORMAL"?!1:(this.core.toggleFullscreen(),(t=this.config.annotations)!=null&&t.enableHapticFeedback&&navigator.vibrate&&navigator.vibrate([50,50,50]),this.$dispatch("video-annotation:doubletap",{event:e,currentTime:this.sharedState.currentTime}),this.sharedState.contextDisplay.debugMode&&console.log("[TouchInterface] Double tap - fullscreen toggle"),!0)}handlePanStart(e){if(this.sharedState.touchInterface.mode!=="NORMAL")return!1;const{center:t}=e,s=this.$refs.videoContainer.getBoundingClientRect(),a=t.x-s.left;t.y-s.top;const n=s.width;return a<n*.3?this.brightnessGestureActive=!0:a>n*.7?(this.volumeGestureActive=!0,this.initialVolume=this.sharedState.volume,this.volumeGestureStartY=t.y):(this.seekGestureActive=!0,this.seekGestureStartX=t.x,this.seekGestureStartTime=this.sharedState.currentTime),this.gestureInProgress=!0,this.sharedState.contextDisplay.debugMode&&console.log("[TouchInterface] Pan start - gesture type determined"),!0}handlePanMove(e){if(!this.gestureInProgress)return!1;const{center:t,deltaX:s,deltaY:a}=e;return this.volumeGestureActive?this.handleVolumeGesture(t.y):this.seekGestureActive?this.handleSeekGesture(s):this.brightnessGestureActive,!0}handlePanEnd(e){return this.gestureInProgress?(this.volumeGestureActive=!1,this.seekGestureActive=!1,this.brightnessGestureActive=!1,this.gestureInProgress=!1,this.sharedState.contextDisplay.debugMode&&console.log("[TouchInterface] Pan end - gestures reset"),!0):!1}handleVolumeGesture(e){const s=(this.volumeGestureStartY-e)/this.volumeGestureSensitivity,a=Math.max(0,Math.min(1,this.initialVolume+s));this.core.setVolume(a),this.$dispatch("video-annotation:volume-gesture",{volume:a,delta:s})}handleSeekGesture(e){const t=e/this.seekGestureSensitivity,s=Math.max(0,Math.min(this.sharedState.duration,this.seekGestureStartTime+t));this.core.seekTo(s),this.$dispatch("video-annotation:seek-gesture",{time:s,delta:t})}handleSwipeLeft(e){var a;if(this.sharedState.touchInterface.mode!=="NORMAL")return!1;const t=((a=this.config.controls)==null?void 0:a.seekAmount)||10,s=Math.max(0,this.sharedState.currentTime-t);return this.core.seekTo(s),this.$dispatch("video-annotation:swipe-left",{seekAmount:t,newTime:s}),this.sharedState.contextDisplay.debugMode&&console.log(`[TouchInterface] Swipe left - seek backward ${t}s`),!0}handleSwipeRight(e){var a;if(this.sharedState.touchInterface.mode!=="NORMAL")return!1;const t=((a=this.config.controls)==null?void 0:a.seekAmount)||10,s=Math.min(this.sharedState.duration,this.sharedState.currentTime+t);return this.core.seekTo(s),this.$dispatch("video-annotation:swipe-right",{seekAmount:t,newTime:s}),this.sharedState.contextDisplay.debugMode&&console.log(`[TouchInterface] Swipe right - seek forward ${t}s`),!0}handleSwipeUp(e){if(this.sharedState.touchInterface.mode!=="NORMAL")return!1;const t=Math.min(1,this.sharedState.volume+.1);return this.core.setVolume(t),this.$dispatch("video-annotation:swipe-up",{volume:t}),this.sharedState.contextDisplay.debugMode&&console.log("[TouchInterface] Swipe up - volume increase"),!0}handleSwipeDown(e){if(this.sharedState.touchInterface.mode!=="NORMAL")return!1;const t=Math.max(0,this.sharedState.volume-.1);return this.core.setVolume(t),this.$dispatch("video-annotation:swipe-down",{volume:t}),this.sharedState.contextDisplay.debugMode&&console.log("[TouchInterface] Swipe down - volume decrease"),!0}handleTouchStart(e){this.sharedState.touchInterface.activePointer="touch",this.lastTouchTime=Date.now(),Array.from(e.touches).forEach(t=>{this.activePointers.set(t.identifier,{x:t.clientX,y:t.clientY,timestamp:this.lastTouchTime})}),this.sharedState.contextDisplay.debugMode&&console.log(`[TouchInterface] Touch start - ${this.activePointers.size} active pointers`)}handleTouchEnd(e){Array.from(e.changedTouches).forEach(t=>{this.activePointers.delete(t.identifier)}),this.activePointers.size===0&&(this.sharedState.touchInterface.activePointer=null),this.sharedState.contextDisplay.debugMode&&console.log(`[TouchInterface] Touch end - ${this.activePointers.size} active pointers`)}enable(){this.sharedState.touchInterface.isEnabled=!0,this.hammer&&this.hammer.set({enable:!0}),this.sharedState.contextDisplay.debugMode&&console.log("[TouchInterface] Touch interface enabled")}disable(){this.sharedState.touchInterface.isEnabled=!1,this.hammer&&this.hammer.set({enable:!1}),this.gestureInProgress=!1,this.volumeGestureActive=!1,this.seekGestureActive=!1,this.brightnessGestureActive=!1,this.sharedState.contextDisplay.debugMode&&console.log("[TouchInterface] Touch interface disabled")}isTouchDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0}getStatus(){return{enabled:this.sharedState.touchInterface.isEnabled,mode:this.sharedState.touchInterface.mode,activePointer:this.sharedState.touchInterface.activePointer,gestureInProgress:this.gestureInProgress,activePointers:this.activePointers.size,isTouchDevice:this.isTouchDevice()}}dispose(){this.hammer&&(this.hammer.destroy(),this.hammer=null),this.activePointers.clear(),this.gestureInProgress=!1,this.volumeGestureActive=!1,this.seekGestureActive=!1,this.brightnessGestureActive=!1,this.sharedState.contextDisplay.debugMode&&console.log("[TouchInterface] Disposed")}handlePointerStart(e,t="default"){var a,n,r,f;const s=e.pointerType||(e.touches?"touch":"mouse");return this.sharedState.touchInterface.activePointer=s,this.sharedState.pointerState||(this.sharedState.pointerState={}),this.sharedState.pointerState.isDown=!0,this.sharedState.pointerState.startTime=Date.now(),this.sharedState.pointerState.startPos={x:e.clientX||((n=(a=e.touches)==null?void 0:a[0])==null?void 0:n.clientX)||0,y:e.clientY||((f=(r=e.touches)==null?void 0:r[0])==null?void 0:f.clientY)||0},this.sharedState.pointerState.currentPos={...this.sharedState.pointerState.startPos},this.sharedState.pointerState.hasMoved=!1,this.sharedState.pointerState.longPressTriggered=!1,this.sharedState.pointerState.activePointer=s,this.sharedState.contextDisplay.debugMode&&console.log(`[TouchInterface] Pointer start - ${s} on ${t}`),!0}handlePointerEnd(e,t="default"){return this.sharedState.pointerState&&(this.sharedState.pointerState.isDown=!1,this.sharedState.pointerState.hasMoved=!1,this.sharedState.pointerState.longPressTriggered=!1),setTimeout(()=>{this.sharedState.touchInterface&&(this.sharedState.touchInterface.activePointer=null)},100),this.sharedState.contextDisplay.debugMode&&console.log(`[TouchInterface] Pointer end on ${t}`),!0}getAlpineMethods(){return{enableTouchInterface:this.enable.bind(this),disableTouchInterface:this.disable.bind(this),handleTap:this.handleTap.bind(this),handleDoubleTap:this.handleDoubleTap.bind(this),handlePointerStart:this.handlePointerStart.bind(this),handlePointerEnd:this.handlePointerEnd.bind(this),getTouchInterfaceStatus:this.getStatus.bind(this),isTouchDevice:this.isTouchDevice.bind(this),get touchInterfaceEnabled(){return this.sharedState.touchInterface.isEnabled},get touchInterfaceMode(){return this.sharedState.touchInterface.mode},get gestureInProgress(){return this.gestureInProgress},get activePointer(){return this.sharedState.touchInterface.activePointer}}}}class z{constructor(e,t){this.config=e,this.sharedState=t,this.player=null,this.videoElement=null,this.qualitySources=[],this.lastTimeUpdateDispatch=0,this.lastBufferedUpdateDispatch=0,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOSSafari=this.isSafari&&/iPhone|iPad|iPod/i.test(navigator.userAgent)}init(e){return this.videoElement=e,this.detectQualitySources(),this.setupVideoJS(),this.setupPlayerEventListeners(),this}detectBrowser(){return{isSafari:this.isSafari,isIOSSafari:this.isIOSSafari}}detectQualitySources(){if(this.videoElement){const e=this.videoElement.getAttribute("data-quality-sources");if(e)try{this.qualitySources=JSON.parse(e),localStorage.getItem("videoAnnotationDebug")==="true"&&console.log("[VideoCore] Loaded",this.qualitySources.length,"quality sources")}catch(t){console.warn("[VideoCore] Failed to parse quality sources:",t),this.qualitySources=[]}}}setupVideoJS(){if(!this.videoElement){console.error("[VideoCore] No video element for VideoJS setup");return}if(this.videoElement.classList.contains("vjs-v8"))return;const e={controls:!1,autoplay:!1,preload:"metadata",responsive:!0,fluid:!0,playsinline:!0,html5:{vhs:{overrideNative:!this.isIOSSafari}}};this.player=$(this.videoElement,e),this.applyVideoJSFluidClasses()}setupPlayerEventListeners(){this.player&&this.player.ready(()=>{console.log("[VideoCore] Player ready"),this.sharedState.videoLoaded=!0,this.loadInitialSource(),this.player.on("loadedmetadata",()=>{const e=this.player.duration()||0;if(console.log("[VideoCore] Metadata loaded, duration:",e),this.sharedState.duration=e,this.updateAspectRatio(),typeof window<"u"){const t=new CustomEvent("video-duration-changed",{detail:{duration:e}});document.dispatchEvent(t)}this.sharedState.duration>0&&console.log("[VideoCore] Video ready for playback")}),this.player.on("loadstart",()=>{console.log("[VideoCore] Video load started")}),this.player.on("canplay",()=>{var t,s;console.log("[VideoCore] Video can start playing");const e=(s=(t=this.config)==null?void 0:t.video)==null?void 0:s.frameRate;e&&this.sharedState&&(this.sharedState.frameRate=e,console.log(`[VideoCore] Frame rate set to ${e}fps from config`))}),this.player.on("error",e=>{console.error("[VideoCore] Video error:",e)}),this.player.on("timeupdate",()=>{var t;const e=this.player.currentTime()||0;if(this.sharedState.currentTime=e,this.sharedState.currentFrameNumber=Math.floor(e*this.sharedState.frameRate)+1,this.updateBuffered(),typeof window<"u"&&this.sharedState.duration>0){const s=Date.now();if(!this.lastTimeUpdateDispatch||s-this.lastTimeUpdateDispatch>100){this.lastTimeUpdateDispatch=s;const a=new CustomEvent("video-time-updated",{detail:{currentTime:e,duration:this.sharedState.duration,progressPercentage:e/this.sharedState.duration*100}});document.dispatchEvent(a)}}if(this.sharedState.duration>0){const s=e/this.sharedState.duration*100;(t=this.sharedState.contextDisplay)!=null&&t.debugMode&&console.log(`[VideoCore] Time: ${e.toFixed(2)}s, Duration: ${this.sharedState.duration.toFixed(2)}s, Progress: ${s.toFixed(1)}%`)}}),this.player.on("play",()=>{var e;if(this.sharedState.isPlaying=!0,this.handleProgressBarAutoHide(),(e=this.config.callbacks)!=null&&e.onPlay&&this.config.callbacks.onPlay(),typeof window<"u"){const t=new CustomEvent("video-play-state-changed",{detail:{isPlaying:!0}});document.dispatchEvent(t)}}),this.player.on("pause",()=>{var e;if(this.sharedState.isPlaying=!1,(e=this.config.callbacks)!=null&&e.onPause&&this.config.callbacks.onPause(),typeof window<"u"){const t=new CustomEvent("video-play-state-changed",{detail:{isPlaying:!1}});document.dispatchEvent(t)}}),this.player.on("volumechange",()=>{var e;if(this.sharedState.volume=this.player.volume(),this.sharedState.isMuted=this.player.muted(),(e=this.config.callbacks)!=null&&e.onVolumeChange&&this.config.callbacks.onVolumeChange(this.sharedState.volume,this.sharedState.isMuted),typeof document<"u"){const t=new CustomEvent("video-volume-changed",{detail:{volume:this.sharedState.volume,isMuted:this.sharedState.isMuted}});document.dispatchEvent(t)}}),this.player.on("fullscreenchange",()=>{var e;this.sharedState.isFullscreen=this.player.isFullscreen(),(e=this.config.callbacks)!=null&&e.onFullscreenChange&&this.config.callbacks.onFullscreenChange(this.sharedState.isFullscreen)})})}loadInitialSource(){if(!this.player||this.qualitySources.length===0){console.log("[VideoCore] No quality sources to load");return}const e=this.qualitySources.find(t=>t.selected)||this.qualitySources.find(t=>t.quality==="1080"||t.label==="1080p")||this.qualitySources[0];console.log("[VideoCore] Loading initial source:",e),e&&(this.player.src({src:e.src,type:e.type||"video/mp4"}),this.sharedState.currentResolution=e,this.sharedState.currentResolutionSrc=e.src,this.sharedState.qualitySources=this.qualitySources,typeof window<"u"&&setTimeout(()=>{const t=new CustomEvent("quality-sources-updated",{detail:{qualitySources:this.qualitySources}});document.dispatchEvent(t)},100))}changeResolution(e){if(!this.player||!e)return;console.log("[VideoCore] Changing resolution to:",e);const t=this.player.currentTime(),s=!this.player.paused();if(this.player.src({src:e.src,type:e.type||"video/mp4"}),this.player.one("loadedmetadata",()=>{this.player.currentTime(t),s&&this.player.play()}),this.sharedState.currentResolution=e,this.sharedState.currentResolutionSrc=e.src,this.qualitySources=this.qualitySources.map(a=>({...a,selected:a.src===e.src})),this.sharedState.qualitySources=this.qualitySources,typeof window<"u"&&window.dispatchEvent(new CustomEvent("resolution-changed",{detail:{source:e,currentResolutionSrc:e.src}})),typeof window<"u"){const a=new CustomEvent("quality-sources-updated",{detail:{qualitySources:this.qualitySources}});document.dispatchEvent(a)}}updateBuffered(){if(this.player&&this.sharedState.duration>0){const e=this.player.buffered();if(e.length>0){const t=e.end(e.length-1),s=t/this.sharedState.duration*100;if(this.sharedState.bufferedPercentage=s,typeof window<"u"){const a=Date.now();if(!this.lastBufferedUpdateDispatch||a-this.lastBufferedUpdateDispatch>500){this.lastBufferedUpdateDispatch=a;const n=new CustomEvent("video-buffered-updated",{detail:{bufferedPercentage:s,bufferedEnd:t,duration:this.sharedState.duration}});document.dispatchEvent(n)}}}}}handleProgressBarAutoHide(){this.sharedState.progressBarMode==="auto-hide"&&(this.sharedState.showProgressBar=!0,this.sharedState.progressBarTimeout&&clearTimeout(this.sharedState.progressBarTimeout),this.sharedState.progressBarTimeout=setTimeout(()=>{this.sharedState.isPlaying&&!this.sharedState.isDragging&&(this.sharedState.showProgressBar=!1)},this.config.timing.progressBarAutoHideDelay))}applyVideoJSFluidClasses(){var s;const e=(s=this.player)==null?void 0:s.el();if(!e)return;["vjs-16-9","vjs-4-3","vjs-9-16"].forEach(a=>e.classList.remove(a)),e.classList.contains("vjs-fluid")||e.classList.add("vjs-fluid")}updateAspectRatio(){if(!this.player)return;const e=this.player.videoWidth(),t=this.player.videoHeight();if(e&&t){const s=e/t,a=this.player.el(),n=[{ratio:16/9,class:"vjs-16-9",tolerance:.1},{ratio:4/3,class:"vjs-4-3",tolerance:.1},{ratio:9/16,class:"vjs-9-16",tolerance:.1}];let r=null;for(const{ratio:f,class:c,tolerance:u}of n)if(Math.abs(s-f)<=u){r=c;break}r&&a.classList.add(r)}}togglePlayPause(){this.player&&(this.sharedState.isPlaying?this.player.pause():this.player.play())}seekTo(e){var t;this.player&&typeof e=="number"&&e>=0&&(this.player.currentTime(e),(t=this.config.callbacks)!=null&&t.onSeek&&this.config.callbacks.onSeek(e))}setVolume(e){this.player&&typeof e=="number"&&this.player.volume(Math.max(0,Math.min(1,e)))}toggleMute(){this.player&&this.player.muted(!this.player.muted())}toggleFullscreen(){this.player&&(this.player.isFullscreen()?this.player.exitFullscreen():this.player.requestFullscreen())}getFrameRate(){var e,t;return((t=(e=this.config)==null?void 0:e.video)==null?void 0:t.frameRate)||30}roundToNearestFrame(e){const s=1/this.getFrameRate();return Math.round(e/s)*s}getFrameNumber(e){const t=this.getFrameRate();return Math.floor(e*t)+1}dispose(){this.player&&typeof this.player.dispose=="function"&&(this.player.dispose(),this.player=null)}get publicAPI(){return{togglePlayPause:this.togglePlayPause.bind(this),seekTo:this.seekTo.bind(this),setVolume:this.setVolume.bind(this),toggleMute:this.toggleMute.bind(this),toggleFullscreen:this.toggleFullscreen.bind(this),getFrameRate:this.getFrameRate.bind(this),roundToNearestFrame:this.roundToNearestFrame.bind(this),getFrameNumber:this.getFrameNumber.bind(this),player:this.player}}}const l={isEnabled:()=>localStorage.getItem("videoAnnotationDebug")==="true",log:(R,e,...t)=>{l.isEnabled()&&console.log(`[${R}]`,e,...t)},warn:(R,e,...t)=>{l.isEnabled()&&console.warn(`[${R}]`,e,...t)},error:(R,e,...t)=>{l.isEnabled()&&console.error(`[${R}]`,e,...t)}};function B(R,e){const t=Object.assign({},R);return k(R)&&k(e)&&Object.keys(e).forEach(s=>{k(e[s])?s in R?t[s]=B(R[s],e[s]):Object.assign(t,{[s]:e[s]}):Object.assign(t,{[s]:e[s]})}),t}function k(R){return R&&typeof R=="object"&&!Array.isArray(R)}function q(R=null,e=[],t=[]){const s={features:{enableAnnotations:!0,enableComments:!0,enableProgressBarAnnotations:!0,enableVideoAnnotations:!0,enableResolutionSelector:!0,enableVolumeControls:!0,enableFullscreenButton:!0,enableSettingsMenu:!0},ui:{progressBarMode:"always",showControls:!0,helpTooltipLimit:3,theme:"auto",enableContextMenu:!0},annotations:{showCommentsOnProgressBar:!0,enableProgressBarComments:!0,enableVideoComments:!0,enableContextMenu:!0,enableHapticFeedback:!0},timing:{progressBarAutoHideDelay:2e3,progressBarHoverHideDelay:1e3,contextAutoHideDelay:3e3,longPressDuration:500,playPauseOverlayDuration:800,helpTooltipDuration:3e3},controls:{seekAmount:10,volumeStep:.1,enableKeyboard:!0},behavior:{pauseOnBlur:!1,pauseOnHidden:!0,autoHideControls:!1},keyboard:{shortcuts:{}},callbacks:{onPlay:null,onPause:null,onSeek:null,onVolumeChange:null,onResolutionChange:null,onFullscreenChange:null,onCommentAdded:null,onCommentRemoved:null,onRegionCreated:null,onRegionDeleted:null},debug:{contextSystem:!1,touchInterface:!1,regions:!1}},a=R?B(s,R):s,n=new N(a,e,t);let r=null,f=null,c=null,u=null,S=null,p=null,C=null;return{get player(){return r==null?void 0:r.player},get videoElement(){return r==null?void 0:r.videoElement},get videoLoaded(){return n.videoLoaded},get durationFromState(){return n.duration},get currentTimeFromState(){return n.currentTime},get isPlayingFromState(){return n.isPlaying},get volume(){return n.volume},get isMuted(){return n.isMuted},get isFullscreen(){return n.isFullscreen},get bufferedPercentage(){return n.bufferedPercentage},get progressBarMode(){return n.progressBarMode},get showProgressBar(){return n.showProgressBar},get progressBarWidth(){return n.progressBarWidth},get isDragging(){return n.isDragging},get hoverX(){return n.hoverX},get hoverTime(){return n.hoverTime},get showHoverAdd(){return n.showHoverAdd},get showSeekCircle(){return n.showSeekCircle},get touchInterfaceMode(){return n.touchInterface.mode},get touchInterfaceEnabled(){return n.touchInterface.isEnabled},get activePointer(){return n.touchInterface.activePointer},get gestureInProgress(){return n.touchInterface.gestureInProgress},get isMobile(){return n.isMobile},get comments(){return n.comments},get activeComments(){return n.activeComments},get nearbyComments(){return n.nearbyComments},get regions(){var i;return l.log("VideoAnnotation","Getting regions:",((i=n.regions)==null?void 0:i.length)||0),n.regions},get activeRegion(){return n.activeRegion},get regionCreationActive(){return n.regionCreationActive},get hiddenRegions(){return n.hiddenRegions},get contextVisible(){var i;return((i=n.contextDisplay)==null?void 0:i.visible)||!1},get contextEnabled(){var i;return((i=n.contextDisplay)==null?void 0:i.enabled)||!1},get contextMode(){var i;return((i=n.contextDisplay)==null?void 0:i.mode)||"time"},get contextContent(){var i;return((i=n.contextDisplay)==null?void 0:i.content)||null},get contextDisplay(){var i,o,h,d,m,g;return{visible:((i=n.contextDisplay)==null?void 0:i.visible)||!1,enabled:((o=n.contextDisplay)==null?void 0:o.enabled)||!1,mode:((h=n.contextDisplay)==null?void 0:h.mode)||"time",content:((d=n.contextDisplay)==null?void 0:d.content)||null,nearbyComments:((m=n.contextDisplay)==null?void 0:m.nearbyComments)||[],autoHideTimer:((g=n.contextDisplay)==null?void 0:g.autoHideTimer)||null}},get frameRate(){return n.frameRate},get currentFrameState(){return n.currentFrameState},get config(){return a},get showTooltip(){return!n.contextDisplay.enabled&&n.showTooltip},get showPlayPauseOverlay(){return n.showPlayPauseOverlay||!1},get frameNavigationDirection(){return n.frameNavigationDirection||null},get showFrameHelpers(){return n.showFrameHelpers!==!1},get currentFrameNumber(){return n.currentFrameNumber||0},showResolutionMenu:!0,showSettingsMenu:!1,showVolumeModal:!1,showVolumeSlider:!1,showSpeedMenu:!1,showSpeedModal:!1,isPlaying:!1,videoLoaded:!1,currentTime:0,duration:0,bufferedPercentage:0,volume:1,isMuted:!1,testMenuToggle(){l.log("VideoAnnotation","Testing menu toggle..."),l.log("VideoAnnotation","Quality sources:",this.qualitySources),l.log("VideoAnnotation","Quality sources length:",this.qualitySources.length),l.log("VideoAnnotation","Current resolution:",this.currentResolution),l.log("VideoAnnotation","Config enableResolutionSelector:",this.config.features.enableResolutionSelector),this.showResolutionMenu=!this.showResolutionMenu,l.log("VideoAnnotation","showResolutionMenu is now:",this.showResolutionMenu)},toggleResolutionMenu(){l.log("VideoAnnotation","Toggling resolution menu, current state:",this.showResolutionMenu),this.showResolutionMenu=!this.showResolutionMenu,l.log("VideoAnnotation","Resolution menu is now:",this.showResolutionMenu)},toggleSettingsMenu(){l.log("VideoAnnotation","Toggling settings menu, current state:",this.showSettingsMenu),this.showSettingsMenu=!this.showSettingsMenu,l.log("VideoAnnotation","Settings menu is now:",this.showSettingsMenu)},toggleVolumeModal(){l.log("VideoAnnotation","Toggling volume modal, current state:",this.showVolumeModal),this.showVolumeModal=!this.showVolumeModal,l.log("VideoAnnotation","Volume modal is now:",this.showVolumeModal)},closeAllMenus(){l.log("VideoAnnotation","Closing all menus"),this.showResolutionMenu=!1,this.showSettingsMenu=!1,this.showVolumeModal=!1,this.showVolumeSlider=!1,this.showSpeedMenu=!1,this.showSpeedModal=!1},toggleCommentsOnProgressBar(){l.log("VideoAnnotation","Toggling comments on progress bar"),n&&(n.showCommentsOnProgressBar=!n.showCommentsOnProgressBar,l.log("VideoAnnotation","Show comments on progress bar:",n.showCommentsOnProgressBar))},toggleProgressBarMode(){if(l.log("VideoAnnotation","Toggling progress bar mode"),n){const i=n.progressBarMode;n.progressBarMode=i==="always"?"auto-hide":"always",n.showProgressBar=n.progressBarMode==="always",l.log("VideoAnnotation","Progress bar mode:",n.progressBarMode)}},qualitySources:[],get qualitySourcesFromState(){return n.qualitySources||[]},get currentResolution(){return n.currentResolution||null},get currentResolutionSrc(){return n.currentResolutionSrc||null},get playbackRate(){return n.playbackRate||1},get showCommentsOnProgressBar(){return n.showCommentsOnProgressBar!==!1},get showRegionBar(){return n.showRegionBar!==!1},get regionBarWidth(){return n.regionBarWidth||0},get isCreatingRegion(){return n.isCreatingRegion||!1},get regionCreationStart(){return n.regionCreationStart||null},get regionCreationEnd(){return n.regionCreationEnd||null},get showRegionToolbar(){return n.showRegionToolbar||!1},get showRegionTooltip(){return n.showRegionTooltip||null},get mobileControlsExpanded(){return n.mobileControlsExpanded||!1},get windowWidth(){return n.windowWidth||window.innerWidth},get dragCurrentTime(){return n.dragCurrentTime||0},get wasPlayingBeforeDrag(){return n.wasPlayingBeforeDrag||!1},get touchInterface(){var i,o,h,d,m;return{enabled:((i=n.touchInterface)==null?void 0:i.enabled)||!1,mode:((o=n.touchInterface)==null?void 0:o.mode)||"NORMAL",contextMenuVisible:((h=n.touchInterface)==null?void 0:h.contextMenuVisible)||!1,unifiedTimelineVisible:((d=n.touchInterface)==null?void 0:d.unifiedTimelineVisible)||!1,actionModalVisible:((m=n.touchInterface)==null?void 0:m.actionModalVisible)||!1}},showContextMenu:!1,contextMenuX:0,contextMenuY:0,contextMenuTime:0,isCreatingRegion:!1,regionCreationStart:null,regionCreationEnd:null,showRegionToolbar:!1,isResizingRegion:!1,resizeRegionId:null,resizeHandle:null,resizeStartX:0,resizeOriginalStartTime:0,resizeOriginalEndTime:0,isDraggingRegionCreation:!1,get pointerState(){var i,o,h,d,m,g,b,T;return{isDown:((i=n.pointerState)==null?void 0:i.isDown)||!1,startTime:((o=n.pointerState)==null?void 0:o.startTime)||0,startPos:((h=n.pointerState)==null?void 0:h.startPos)||{x:0,y:0},currentPos:((d=n.pointerState)==null?void 0:d.currentPos)||{x:0,y:0},hasMoved:((m=n.pointerState)==null?void 0:m.hasMoved)||!1,longPressTriggered:((g=n.pointerState)==null?void 0:g.longPressTriggered)||!1,ghostClickPrevention:((b=n.pointerState)==null?void 0:b.ghostClickPrevention)||!1,activePointer:((T=n.pointerState)==null?void 0:T.activePointer)||null}},get eventHandler(){return(C==null?void 0:C.getAlpineMethods())||{}},get progressPercentage(){return f?f.getProgressPercentage():this.duration&&this.duration>0?this.currentTime/this.duration*100:0},get bufferedProgress(){return f?f.getBufferedPercentage():this.bufferedPercentage},get frameAlignedProgressPercentage(){return this.duration>0?this.currentTime/this.duration*100:0},get isSafari(){return(r==null?void 0:r.isSafari)||!1},init(){var o;(!n.comments||n.comments.length===0)&&(n.comments=e||[]),this.detectBrowser(),n.windowWidth=window.innerWidth,n.showFrameHelpers=!0,n.showCommentsOnProgressBar=((o=a.annotations)==null?void 0:o.showCommentsOnProgressBar)!==!1,n.showRegionBar=!0,this.showResolutionMenu=!1,this.showSettingsMenu=!1,this.showVolumeModal=!1,this.showVolumeSlider=!1,this.showSpeedMenu=!1,this.showSpeedModal=!1,n.showContextMenu=!1,this.showContextMenu=!1;const i=()=>{n.windowWidth=window.innerWidth,f&&this.updateProgressBarWidth()};window.addEventListener("resize",i),this.$nextTick(()=>{var h,d;try{const m=this.$refs.videoPlayer||this.$refs.video||this.$el.querySelector("video")||this.$el.querySelector('[x-ref="videoPlayer"]');if(!m){console.error("[VideoAnnotation] Video element not found. Available refs:",Object.keys(this.$refs||{}));return}const g={progressBar:this.$refs.progressBar,toolBar:this.$refs.toolBar||this.$refs["tool-bar-container"]},b=Object.entries(g).filter(([T,v])=>!v).map(([T])=>T);b.length>0&&console.warn("[VideoAnnotation] Missing DOM refs:",b,"Available refs:",Object.keys(this.$refs||{})),r=new z(a,n),f=new H(r,n,a),c=new V(r,n,a),u=new I(r,n,a),S=new O(r,n,a),p=new F(r,n,a),C=new L(r,n,a),m?((h=a.debug)!=null&&h.contextSystem&&(l.log("VideoAnnotation","Initializing VideoCore with element:",m),l.log("VideoAnnotation","Video element src:",m.src||"No src"),l.log("VideoAnnotation","Video element sources:",m.querySelectorAll("source").length)),r.init(m)):console.error("[VideoAnnotation] VideoCore initialization failed - no video element"),this.initializeModulesWithErrorHandling(m),this.setupModuleCommunication(),this.$nextTick(()=>{this.updateProgressBarWidth()}),(d=a.debug)!=null&&d.contextSystem&&(l.log("VideoAnnotation","Initialized with modular architecture"),l.log("VideoAnnotation","Modules:",{videoCore:!!r,progressBar:!!f,commentSystem:!!c,regionManagement:!!u,touchInterface:!!S,contextDisplay:!!p,eventHandler:!!C}))}catch(m){console.error("[VideoAnnotation] Initialization error:",m),console.error("[VideoAnnotation] Available $refs:",Object.keys(this.$refs||{})),console.error("[VideoAnnotation] $el:",this.$el)}})},initializeModulesWithErrorHandling(i){[{name:"progressBar",instance:f,initArgs:[this.$refs,this.$dispatch]},{name:"commentSystem",instance:c,initArgs:[this.$refs,this.$dispatch]},{name:"regionManagement",instance:u,initArgs:[this.$refs,this.$dispatch]},{name:"touchInterface",instance:S,initArgs:[this.$refs,this.$dispatch]},{name:"contextDisplay",instance:p,initArgs:[this.$refs,this.$dispatch]},{name:"eventHandler",instance:C,initArgs:[this.$refs,this.$dispatch]}].forEach(({name:h,instance:d,initArgs:m})=>{try{d&&typeof d.init=="function"?(d.init(...m),h==="commentSystem"&&typeof d.enableTimeUpdates=="function"&&d.enableTimeUpdates()):console.warn(`[VideoAnnotation] ${h} module not available or missing init method`)}catch(g){console.error(`[VideoAnnotation] Failed to initialize ${h} module:`,g)}})},setupModuleCommunication(){if(!this.$el||typeof this.$el.addEventListener!="function"){console.error("[VideoAnnotation] $el is not a valid DOM element or missing addEventListener");return}try{this.$el.addEventListener("video-annotation:seek",i=>{var o;try{((o=i.detail)==null?void 0:o.timestamp)!==void 0&&r&&r.seekTo(i.detail.timestamp)}catch(h){console.error("[VideoAnnotation] Error handling seek event:",h)}}),this.$el.addEventListener("video-annotation:add-comment",i=>{var o;try{(o=a.callbacks)!=null&&o.onCommentAdded&&a.callbacks.onCommentAdded(i.detail)}catch(h){console.error("[VideoAnnotation] Error handling add-comment event:",h)}}),this.$el.addEventListener("video-annotation:region-created",i=>{var o;try{(o=a.callbacks)!=null&&o.onRegionCreated&&a.callbacks.onRegionCreated(i.detail)}catch(h){console.error("[VideoAnnotation] Error handling region-created event:",h)}}),this.$el.addEventListener("video-annotation:view-comment",i=>{var o;try{(o=a.callbacks)!=null&&o.onCommentViewed&&a.callbacks.onCommentViewed(i.detail)}catch(h){console.error("[VideoAnnotation] Error handling view-comment event:",h)}}),this.$el.addEventListener("video-annotation:seek-comment",i=>{var o,h;try{((o=i.detail)==null?void 0:o.timestamp)!==void 0&&r&&r.seekTo(i.detail.timestamp),(h=i.detail)!=null&&h.commentId&&c&&c.showCommentContext(i.detail.commentId)}catch(d){console.error("[VideoAnnotation] Error handling seek-comment event:",d)}})}catch(i){console.error("[VideoAnnotation] Error setting up module communication:",i)}document.addEventListener("quality-sources-updated",i=>{this.qualitySources=i.detail.qualitySources||[]}),document.addEventListener("video-play-state-changed",i=>{this.isPlaying=i.detail.isPlaying||!1}),document.addEventListener("video-duration-changed",i=>{this.duration=i.detail.duration||0,this.duration>0&&(this.videoLoaded=!0,l.log("VideoAnnotation","Video loaded and ready for annotations - Duration:",this.duration,"VideoLoaded:",this.videoLoaded))}),document.addEventListener("video-time-updated",i=>{this.currentTime=i.detail.currentTime||0}),document.addEventListener("video-buffered-updated",i=>{this.bufferedPercentage=i.detail.bufferedPercentage||0}),document.addEventListener("video-volume-changed",i=>{this.volume=i.detail.volume||0,this.isMuted=i.detail.isMuted||!1,l.log("VideoAnnotation","Volume changed:",this.volume,"Muted:",this.isMuted)})},updateProgressBarWidth(){f&&f.updateProgressBarWidth()},cleanup(){var i;c&&c.dispose(),u&&u.dispose(),S&&S.dispose(),p&&p.dispose(),C&&C.dispose(),r&&r.dispose(),n.reset(),(i=a.debug)!=null&&i.contextSystem&&l.log("VideoAnnotation","Cleaned up resources")},togglePlayPause(){return r==null?void 0:r.togglePlayPause()},togglePlay(){return r==null?void 0:r.togglePlayPause()},seekTo(i){return r==null?void 0:r.seekTo(i)},setVolume(i){return r==null?void 0:r.setVolume(i)},toggleMute(){return r==null?void 0:r.toggleMute()},toggleFullscreen(){return r==null?void 0:r.toggleFullscreen()},stepForward(){if(r!=null&&r.player&&(n==null?void 0:n.duration)>0){const i=r.player.currentTime()||0,h=1/(n.frameRate||30),d=Math.min(i+h,n.duration);r.seekTo(d),n.frameNavigationDirection="forward",setTimeout(()=>{n.frameNavigationDirection=null},500)}},stepBackward(){if(r!=null&&r.player&&n){const i=r.player.currentTime()||0,h=1/(n.frameRate||30),d=Math.max(i-h,0);r.seekTo(d),n.frameNavigationDirection="backward",setTimeout(()=>{n.frameNavigationDirection=null},500)}},changeResolution(i){l.log("VideoAnnotation","Changing resolution to:",i),r!=null&&r.changeResolution&&(r.changeResolution(i),this.qualitySources=this.qualitySources.map(o=>({...o,selected:o.src===i.src})),n&&(n.qualitySources=this.qualitySources,n.currentResolution=i,n.currentResolutionSrc=i.src))},handleProgressBarClick(i,o="click"){return f==null?void 0:f.handleProgressBarClick(i,o)},handleProgressBarDragStart(i){return f==null?void 0:f.handleProgressBarDragStart(i)},handleProgressBarHover(i){return f==null?void 0:f.handleProgressBarHover(i)},handleProgressBarLeave(){return f==null?void 0:f.handleProgressBarLeave()},handleCommentClick(i,o){return c==null?void 0:c.handleCommentClick(i,o)},loadComment(i){return c==null?void 0:c.loadComment(i)},addComment(i){return c==null?void 0:c.addComment(i)},removeComment(i){return c==null?void 0:c.removeComment(i)},renderCommentMarkers(){return(c==null?void 0:c.renderCommentMarkers())||[]},getCommentBubblePosition(i,o){return(c==null?void 0:c.getCommentBubblePosition(i,o))||{left:0,zIndex:100}},calculateCommentOffset(i,o){return(c==null?void 0:c.calculateCommentOffset(i,o))||{left:0,top:0}},showCommentContext(i){return c==null?void 0:c.showCommentContext(i)},hideCommentContext(i){return c==null?void 0:c.hideCommentContext(i)},clearActiveComments(){return c==null?void 0:c.clearActiveComments()},startRegionCreation(){return u==null?void 0:u.startRegionCreation()},finishRegionCreation(){return u==null?void 0:u.finishRegionCreation()},cancelRegionCreation(){return u==null?void 0:u.cancelRegionCreation()},selectRegion(i){return u==null?void 0:u.selectRegion(i)},deleteRegion(i){return u==null?void 0:u.deleteRegion(i)},handleRegionClick(i,o){return u==null?void 0:u.handleRegionClick(i,o)},getVisibleRegions(){if(u)return u.getVisibleRegions();const i=n.regions||[],o=this.duration||n.duration||100;return i.filter(h=>!n.hiddenRegions.has(h.id)).map(h=>{var b;const d=h.startTime/o*100,g=h.endTime/o*100-d;return{...h,position:{left:Math.max(0,Math.min(100,d)),width:Math.max(0,Math.min(100-d,g))},isActive:((b=n.activeRegion)==null?void 0:b.id)===h.id,isSelected:!1,isEditing:!1,isHovered:!1}})},getRegionPosition(i){return(u==null?void 0:u.getRegionPosition(i))||{left:0,width:0}},enableTouchInterface(){return S==null?void 0:S.enable()},disableTouchInterface(){return S==null?void 0:S.disable()},isTouchDevice(){return(S==null?void 0:S.isTouchDevice())||!1},showContext(i,o,h){return p==null?void 0:p.show(i,o,h)},hideContext(i=!1){return p==null?void 0:p.hide(i)},showTimeContext(i,o){return p==null?void 0:p.showTimeContext(i,o)},showCommentsContext(i,o){return p==null?void 0:p.showCommentsContext(i,o)},showCombinedContext(i,o,h){return p==null?void 0:p.showCombinedContext(i,o,h)},setContextMode(i){return p==null?void 0:p.setMode(i)},enableContext(){return p==null?void 0:p.enable()},disableContext(){return p==null?void 0:p.disable()},clearContextAutoHide(){return p==null?void 0:p.clearAutoHideTimer()},enableKeyboard(){return C==null?void 0:C.enableKeyboard()},disableKeyboard(){return C==null?void 0:C.disableKeyboard()},addKeyboardShortcut(i,o){return C==null?void 0:C.addKeyboardShortcut(i,o)},seekRelative(i){return C==null?void 0:C.seekRelative(i)},seekFrame(i){return C==null?void 0:C.seekFrame(i)},formatTimestamp(i){return(c==null?void 0:c.formatTimestamp(i))||this.formatTime(i)},formatTime(i){if(!i||i<0)return"0:00";const o=Math.floor(i/60),h=Math.floor(i%60);return`${o}:${h.toString().padStart(2,"0")}`},roundToNearestFrame(i){return n.roundToNearestFrame?n.roundToNearestFrame(i):i},getFrameNumber(i){return n.getFrameNumber?n.getFrameNumber(i):Math.floor(i*(this.frameRate||30))},timeToPixel(i){return n.timeToPixel?n.timeToPixel(i):0},pixelToTime(i){return n.pixelToTime?n.pixelToTime(i):0},toggleFrameHelpers(){n.showFrameHelpers=!n.showFrameHelpers},stepForward(){return(C==null?void 0:C.stepForward())||(r==null?void 0:r.stepForward())},stepBackward(){return(C==null?void 0:C.stepBackward())||(r==null?void 0:r.stepBackward())},getSpeedOptions(){return[{value:.25,label:"0.25x"},{value:.5,label:"0.5x"},{value:.75,label:"0.75x"},{value:1,label:"1x"},{value:1.25,label:"1.25x"},{value:1.5,label:"1.5x"},{value:2,label:"2x"}]},setPlaybackRate(i){return r==null?void 0:r.setPlaybackRate(i)},toggleSpeedMenu(){n.showSpeedMenu=!n.showSpeedMenu},toggleSpeedModal(){n.showSpeedModal=!n.showSpeedModal},toggleVolumeModal(){n.showVolumeModal=!n.showVolumeModal},toggleVolumeSlider(){n.showVolumeSlider=!n.showVolumeSlider},toggleSettingsMenu(){n.showSettingsMenu=!n.showSettingsMenu},toggleResolutionMenu(){n.showResolutionMenu=!n.showResolutionMenu},toggleMobileControls(){n.mobileControlsExpanded=!n.mobileControlsExpanded},getVolumePercentage(){return Math.round((this.volume||0)*100)},detectBrowser(){r||(n.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),n.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),n.isAndroid=/Android/.test(navigator.userAgent),n.isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,n.isChrome=/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor))},showContextMenu(i,o){var h;(h=a.annotations)!=null&&h.enableContextMenu&&(n.showContextMenu=!0,n.contextMenuX=i.clientX||i.pageX||0,n.contextMenuY=i.clientY||i.pageY||0,n.contextMenuTime=o||this.currentTime,i.preventDefault&&i.preventDefault(),i.stopPropagation&&i.stopPropagation())},hideContextMenu(){n.showContextMenu=!1,this.showContextMenu=!1},handleContextMenuAction(i){var h,d;if((d=(h=this.config)==null?void 0:h.mode)!=null&&d.viewOnly&&(i==="add-comment"||i==="create-region")){console.log(`[VideoAnnotation] ${i} disabled in viewOnly mode`),this.hideContextMenu();return}const o=n.contextMenuTime;switch(this.hideContextMenu(),i){case"add-comment":c&&c.addCommentAtTime(o);break;case"create-region":u&&u.startRegionCreationAtTime(o);break;default:console.warn(`Unknown context menu action: ${i}`)}},getContextDisplayContent(){if(!p)return{primary:this.formatTime(this.currentTime),secondary:null,showCommentCount:!1,comment:null};if(p.getDisplayContent){const i=p.getDisplayContent();return i.secondary&&l.log("VideoAnnotation","Showing secondary context:",i.secondary),i}else return{primary:this.formatTime(this.currentTime),secondary:null,showCommentCount:!1,comment:null}},shouldShowTimelineDisplay(i){return!i||!c?!1:c.shouldShowTimelineDisplay?c.shouldShowTimelineDisplay(i):!1},get commentSystem(){return c},handleTimelineCommentClick(i){c&&i&&c.handleTimelineCommentClick(i)},handleCommentClick(i,o){o&&(o.timestamp!==void 0&&r&&r.seekTo(o.timestamp),this.$dispatch("flying-comment-show",{commentId:o.commentId,name:o.name,timestamp:o.timestamp,body:o.body}),l.log("VideoAnnotation","Flying comment shown:",o.name))},initRegionToolbarDrag(i){if(u)return u.initRegionToolbarDrag?u.initRegionToolbarDrag(i):null},startRegionCreationAtCurrentFrame(){var i,o;if((o=(i=this.config)==null?void 0:i.mode)!=null&&o.viewOnly){l.log("VideoAnnotation","Region creation disabled in viewOnly mode");return}if(l.log("VideoAnnotation","startRegionCreationAtCurrentFrame button clicked"),l.log("VideoAnnotation","regionManagement available:",!!u),u&&u.startRegionCreationAtCurrentFrame){l.log("VideoAnnotation","Calling regionManagement.startRegionCreationAtCurrentFrame");const h=u.startRegionCreationAtCurrentFrame();this.isCreatingRegion=!0,this.showRegionToolbar=!0;const d=this.currentTime||0,m=this.roundToNearestFrame?this.roundToNearestFrame(d):d,g=this.$refs.regionBar;if(g&&this.duration>0){const b=g.getBoundingClientRect(),T=m/this.duration*100,v=T/100*b.width,w=Math.min(this.duration,m+10),x=w/this.duration*100,M=x/100*b.width;this.regionCreationStart={x:v,time:m,percentage:T},this.regionCreationEnd={x:M,time:w,percentage:x},l.log("VideoAnnotation","Set visual region state:",{isCreatingRegion:this.isCreatingRegion,showRegionToolbar:this.showRegionToolbar,time:m,x:v})}return h}else{l.log("VideoAnnotation","Using fallback region creation");const h=this.currentTime||0,d=this.roundToNearestFrame?this.roundToNearestFrame(h):h;this.isCreatingRegion=!0,this.showRegionToolbar=!0;const m=this.$refs.regionBar;if(m){const g=m.getBoundingClientRect(),b=d/this.duration*100,T=b/100*g.width,y=Math.min(this.duration,d+10),w=y/this.duration*100,x=w/100*g.width;this.regionCreationStart={x:T,time:d,percentage:b},this.regionCreationEnd={x,time:y,percentage:w},n.isCreatingRegion=!0,n.showRegionToolbar=!0,n.regionCreationStart=this.regionCreationStart,n.regionCreationEnd=this.regionCreationEnd,this.isPlaying&&r&&r.togglePlayPause(),r&&r.seekTo(d),l.log("VideoAnnotation","Started region creation at frame:",d)}}},onProgressBarMouseEnterWithContext(i){if(p)return p.onProgressBarMouseEnter?p.onProgressBarMouseEnter(i):null},onProgressBarMouseMoveWithContext(i){if(p)return p.onProgressBarMouseMove?p.onProgressBarMouseMove(i):null},onProgressBarMouseLeaveWithContext(){if(p)return p.onProgressBarMouseLeave?p.onProgressBarMouseLeave():null},handleProgressBarPointer(i,o){if(f)return f.handleProgressBarPointer?f.handleProgressBarPointer(i,o):null},handleVideoClick(i){return r?r.handleVideoClick?r.handleVideoClick(i):this.togglePlayPause():this.togglePlayPause()},handleVideoHover(i){return S&&S.handleVideoHover?S.handleVideoHover(i):null},handleVideoLeave(i){return S&&S.handleVideoLeave?S.handleVideoLeave(i):null},hideCommentTooltip(){return c&&c.hideCommentTooltip?c.hideCommentTooltip():(n.showTooltip=!1,null)},showCommentTooltip(i){return c&&c.showCommentTooltip?c.showCommentTooltip(i):null},handleVideoDoubleClick(i){return r?r.handleVideoDoubleClick?r.handleVideoDoubleClick(i):this.toggleFullscreen():this.toggleFullscreen()},handleVideoRightClick(i){var m,g;if(!((m=a.annotations)!=null&&m.enableContextMenu))return;i.preventDefault&&i.preventDefault(),i.stopPropagation&&i.stopPropagation(),this.isPlaying&&r&&r.togglePlayPause();const o=this.currentTime||0,h=i.clientX||i.pageX||0,d=i.clientY||i.pageY||0;return n.showContextMenu=!0,n.contextMenuX=h,n.contextMenuY=d,n.contextMenuTime=o,this.showContextMenu=!0,this.contextMenuX=h,this.contextMenuY=d,this.contextMenuTime=o,l.log("VideoAnnotation","Context menu shown at time:",o),l.log("VideoAnnotation","Context menu position:",h,d),l.log("VideoAnnotation","Enable context menu config:",(g=a.annotations)==null?void 0:g.enableContextMenu),S&&S.handleVideoRightClick?S.handleVideoRightClick(i):!1},handlePointerStart(i,o="default"){var h,d,m,g;return S&&S.handlePointerStart?S.handlePointerStart(i,o):(n.pointerState||(n.pointerState={}),n.pointerState.isDown=!0,n.pointerState.startTime=Date.now(),n.pointerState.startPos={x:i.clientX||((d=(h=i.touches)==null?void 0:h[0])==null?void 0:d.clientX)||0,y:i.clientY||((g=(m=i.touches)==null?void 0:m[0])==null?void 0:g.clientY)||0},n.pointerState.currentPos={...n.pointerState.startPos},n.pointerState.hasMoved=!1,n.pointerState.longPressTriggered=!1,n.pointerState.activePointer=i.pointerType||(i.touches?"touch":"mouse"),!0)},handlePointerEnd(i,o="default"){return S&&S.handlePointerEnd?S.handlePointerEnd(i,o):(n.pointerState&&(n.pointerState.isDown=!1,n.pointerState.hasMoved=!1,n.pointerState.longPressTriggered=!1,setTimeout(()=>{n.pointerState&&(n.pointerState.activePointer=null)},100)),!0)},jumpFrames(i){return C!=null&&C.seekFrame?C.seekFrame(i):r!=null&&r.seekFrame?r.seekFrame(i):null},handleProgressBarPointer(i,o="click"){return f&&f.handleProgressBarPointer?f.handleProgressBarPointer(i,o):this.handleProgressBarClick(i,o)},addCommentAtCurrentFrame(){var i,o;if((o=(i=this.config)==null?void 0:i.mode)!=null&&o.viewOnly){l.log("VideoAnnotation","Comment creation disabled in viewOnly mode");return}if(c)return c.addCommentAtTime?c.addCommentAtTime(this.currentTime):null;this.$dispatch("video-annotation:add-comment",{timestamp:this.currentTime,frame:this.getFrameNumber(this.currentTime)})},startSimpleRegionCreation(){return u?u.startRegionCreation():null},exitRegionCreationMode(){return u?u.cancelRegionCreation():null},confirmRegionCreation(){return u?u.finishRegionCreation():null},setRegionStart(){if(u&&u.setRegionStart)return u.setRegionStart(this.currentTime);n.regionCreationStart={time:this.currentTime,frame:this.getFrameNumber(this.currentTime)}},setRegionEnd(){if(u&&u.setRegionEnd)return u.setRegionEnd(this.currentTime);n.regionCreationEnd={time:this.currentTime,frame:this.getFrameNumber(this.currentTime)}},toggleCommentsOnProgressBar(){n.showCommentsOnProgressBar=!n.showCommentsOnProgressBar,this.$dispatch("video-annotation:comments-visibility-toggled",{visible:n.showCommentsOnProgressBar})},toggleProgressBarMode(){const i=["always-visible","auto-hide"],h=(i.indexOf(n.progressBarMode||"always-visible")+1)%i.length;n.progressBarMode=i[h],n.showProgressBar=n.progressBarMode==="always-visible",this.$dispatch("video-annotation:progress-bar-mode-changed",{mode:n.progressBarMode})},changeResolution(i){if(r&&r.changeResolution)return r.changeResolution(i);n.currentResolution=i,n.currentResolutionSrc=i.src,this.$dispatch("video-annotation:resolution-changed",{resolution:i})},hideTouchContextMenu(){S&&S.hideContextMenu(),n.touchInterface.contextMenuVisible=!1},handleTouchStart(i){return S&&S.handleTouchStart?S.handleTouchStart(i):(n.touchInterface.activePointer="touch",!0)},handleTouchEnd(i){return S&&S.handleTouchEnd?S.handleTouchEnd(i):(setTimeout(()=>{n.touchInterface&&(n.touchInterface.activePointer=null)},100),!0)},addCommentFromContextMenu(){const i=this.currentTime||0;this.hideContextMenu(),c&&c.addCommentAtTime?c.addCommentAtTime(i):this.$dispatch("video-annotation:add-comment",{timestamp:i,frame:this.getFrameNumber(i)})},startRegionCreation(i){var b,T,v,y;if(l.log("VideoAnnotation","startRegionCreation called with event:",i.type),!((b=a.features)!=null&&b.enableAnnotations)){l.log("VideoAnnotation","Video annotations not enabled"),l.log("VideoAnnotation","config.features.enableAnnotations:",(T=a.features)==null?void 0:T.enableAnnotations);return}const o=this.$refs.regionBar;if(l.log("VideoAnnotation","regionBar element:",o),!o){l.log("VideoAnnotation","No regionBar ref found");return}const h=o.getBoundingClientRect(),d=(i.clientX||((y=(v=i.touches)==null?void 0:v[0])==null?void 0:y.clientX)||0)-h.left,m=Math.max(0,Math.min(100,d/h.width*100)),g=m/100*this.duration;l.log("VideoAnnotation","Click position:",{x:d,percentage:m,timestamp:g}),this.isCreatingRegion=!0,this.regionCreationStart={x:d,time:g,percentage:m},this.regionCreationEnd={...this.regionCreationStart},this.showRegionToolbar=!0,n.isCreatingRegion=!0,n.regionCreationStart=this.regionCreationStart,n.regionCreationEnd=this.regionCreationEnd,n.showRegionToolbar=!0,this.isPlaying&&r&&r.togglePlayPause(),r&&r.seekTo(g),l.log("VideoAnnotation","Region creation started:",{isCreatingRegion:this.isCreatingRegion,showRegionToolbar:this.showRegionToolbar,regionCreationStart:this.regionCreationStart})},updateRegionCreation(i){var P,E;if(!this.isCreatingRegion||!this.regionCreationStart)return;const o=this.$refs.regionBar;if(!o)return;const h=o.getBoundingClientRect(),d=(i.clientX||((E=(P=i.touches)==null?void 0:P[0])==null?void 0:E.clientX)||0)-h.left,g=Math.max(0,Math.min(100,d/h.width*100))/100*this.duration,b=this.regionCreationStart.time,v=1/(this.frameRate||30),y=b+v,w=Math.max(y,Math.min(this.duration,g)),x=w/this.duration*100,M=x/100*h.width;this.regionCreationEnd={x:M,time:w,percentage:x},n.regionCreationEnd=this.regionCreationEnd,r&&r.seekTo(w),l.log("VideoAnnotation","Region updated (constrained):",{rawTime:g,constrainedTime:w,startTime:b,width:Math.abs(this.regionCreationEnd.x-this.regionCreationStart.x)})},finishRegionCreation(i){if(!this.isCreatingRegion||!this.regionCreationStart||!this.regionCreationEnd)return;const o=Math.min(this.regionCreationStart.time,this.regionCreationEnd.time),h=Math.max(this.regionCreationStart.time,this.regionCreationEnd.time),d=h-o;l.log("VideoAnnotation","Finishing region creation - duration:",d);let m=o,g=h;if(d<.1){this.frameRate;const b=10;m=Math.max(0,o-b/2),g=Math.min(this.duration,o+b/2),g>this.duration&&(g=this.duration,m=Math.max(0,g-b)),l.log("VideoAnnotation","Single click detected - creating default region:",m,"-",g)}g-m>.1&&(u&&u.startRegionCreationAtTime?(u.startRegionCreationAtTime(m),u.updateRegionCreation&&u.updateRegionCreation(g),u.finishRegionCreation&&u.finishRegionCreation()):this.$dispatch("video-annotation:region-created",{startTime:m,endTime:g,startFrame:this.getFrameNumber(m),endFrame:this.getFrameNumber(g)}),l.log("VideoAnnotation","Created region:",m,"-",g)),this.cancelRegionCreation()},cancelRegionCreation(){this.isCreatingRegion=!1,this.regionCreationStart=null,this.regionCreationEnd=null,this.showRegionToolbar=!1,n.isCreatingRegion=!1,n.regionCreationStart=null,n.regionCreationEnd=null,n.showRegionToolbar=!1,u&&u.cancelRegionCreation&&u.cancelRegionCreation(),l.log("VideoAnnotation","Cancelled region creation")},confirmRegionCreation(){l.log("VideoAnnotation","Enter key pressed - confirming region creation"),this.finishRegionCreation()},expandRegionEnd(){if(!this.isCreatingRegion||!this.regionCreationStart||!this.regionCreationEnd)return;const o=1/(this.frameRate||30),h=Math.min(this.duration,this.regionCreationEnd.time+o);if(h>=this.duration)return;const d=this.$refs.regionBar;if(d){const m=d.getBoundingClientRect(),g=h/this.duration*100,b=g/100*m.width;this.regionCreationEnd={x:b,time:h,percentage:g},n.regionCreationEnd=this.regionCreationEnd,r&&r.seekTo(h),l.log("VideoAnnotation","Expanded region end to:",h)}},shrinkRegionEnd(){if(!this.isCreatingRegion||!this.regionCreationStart||!this.regionCreationEnd)return;const o=1/(this.frameRate||30),h=Math.max(this.regionCreationStart.time+o,this.regionCreationEnd.time-o);if(h<=this.regionCreationStart.time)return;const d=this.$refs.regionBar;if(d){const m=d.getBoundingClientRect(),g=h/this.duration*100,b=g/100*m.width;this.regionCreationEnd={x:b,time:h,percentage:g},n.regionCreationEnd=this.regionCreationEnd,r&&r.seekTo(h),l.log("VideoAnnotation","Shrunk region end to:",h)}},expandRegionStart(){if(!this.isCreatingRegion||!this.regionCreationStart||!this.regionCreationEnd)return;const o=1/(this.frameRate||30),h=Math.max(0,this.regionCreationStart.time-o);if(h<=0)return;const d=this.$refs.regionBar;if(d){const m=d.getBoundingClientRect(),g=h/this.duration*100,b=g/100*m.width;this.regionCreationStart={x:b,time:h,percentage:g},n.regionCreationStart=this.regionCreationStart,r&&r.seekTo(h),l.log("VideoAnnotation","Expanded region start to:",h)}},shrinkRegionStart(){if(!this.isCreatingRegion||!this.regionCreationStart||!this.regionCreationEnd)return;const o=1/(this.frameRate||30),h=Math.min(this.regionCreationEnd.time-o,this.regionCreationStart.time+o);if(h>=this.regionCreationEnd.time)return;const d=this.$refs.regionBar;if(d){const m=d.getBoundingClientRect(),g=h/this.duration*100,b=g/100*m.width;this.regionCreationStart={x:b,time:h,percentage:g},n.regionCreationStart=this.regionCreationStart,r&&r.seekTo(h),l.log("VideoAnnotation","Shrunk region start to:",h)}},initRegionToolbarDrag(i){if(!i)return;let o=!1,h=0,d=0,m=0,g=0;const b=y=>{var M,P,E,D;const w=y.clientX||((P=(M=y.touches)==null?void 0:M[0])==null?void 0:P.clientX)||0,x=y.clientY||((D=(E=y.touches)==null?void 0:E[0])==null?void 0:D.clientY)||0;h=w-m,d=x-g,o=!0,i.style.cursor="grabbing"},T=y=>{var M,P,E,D;if(!o)return;y.preventDefault();const w=y.clientX||((P=(M=y.touches)==null?void 0:M[0])==null?void 0:P.clientX)||0,x=y.clientY||((D=(E=y.touches)==null?void 0:E[0])==null?void 0:D.clientY)||0;m=w-h,g=x-d,i.style.transform=`translate(calc(-50% + ${m}px), ${g}px)`},v=()=>{o=!1,i.style.cursor="move"};return i.addEventListener("mousedown",b),document.addEventListener("mousemove",T),document.addEventListener("mouseup",v),i.addEventListener("touchstart",b),document.addEventListener("touchmove",T),document.addEventListener("touchend",v),i},goToPreviousFrame(){this.isCreatingRegion?this.shrinkRegionEnd():this.stepBackward()},goToNextFrame(){this.isCreatingRegion?this.expandRegionEnd():this.stepForward()},jumpFrames(i){if(this.isCreatingRegion)for(let o=0;o<Math.abs(i);o++)i>0?this.expandRegionEnd():this.shrinkRegionEnd();else{if(!(r!=null&&r.player)||!this.duration)return;const o=r.player.currentTime()||0,d=1/(this.frameRate||30),m=i*d,g=Math.max(0,Math.min(this.duration,o+m));r.seekTo(g),n.frameNavigationDirection=i>0?"forward":"backward",setTimeout(()=>{n.frameNavigationDirection=null},500)}},startRegionDrag(i){if(l.log("VideoAnnotation","Starting region creation drag"),!this.isCreatingRegion||!this.regionCreationStart){console.warn("[VideoAnnotation] Not in region creation mode");return}i.preventDefault&&i.preventDefault(),i.stopPropagation&&i.stopPropagation(),this.isDraggingRegionCreation=!0,this.isPlaying&&r&&r.togglePlayPause();const o=d=>{this.updateRegionDrag(d)},h=d=>{this.finishRegionDrag(d),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",h),document.removeEventListener("touchmove",o),document.removeEventListener("touchend",h)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",h),document.addEventListener("touchmove",o),document.addEventListener("touchend",h),l.log("VideoAnnotation","Region creation drag started")},updateRegionDrag(i){var w,x;if(!this.isDraggingRegionCreation||!this.isCreatingRegion||!this.regionCreationStart)return;const o=i.clientX||((x=(w=i.touches)==null?void 0:w[0])==null?void 0:x.clientX)||0,h=this.$refs.regionBar;if(!h)return;const d=h.getBoundingClientRect(),m=o-d.left,b=Math.max(0,Math.min(100,m/d.width*100))/100*this.duration,T=Math.min(this.duration,Math.max(this.regionCreationStart.time+.1,b)),v=T/this.duration*100,y=v/100*d.width;this.regionCreationEnd={x:y,time:T,percentage:v},n.regionCreationEnd=this.regionCreationEnd,r&&r.seekTo(T),l.log("VideoAnnotation","Region drag updated:",{mouseX:o,relativeX:m,newEndTime:T,duration:T-this.regionCreationStart.time})},finishRegionDrag(i){this.isDraggingRegionCreation&&(l.log("VideoAnnotation","Finishing region creation drag"),this.isDraggingRegionCreation=!1,l.log("VideoAnnotation","Region creation drag finished"))},startRegionResize(i,o,h){var b,T;if(l.log("VideoAnnotation","Starting region resize:",o,h),!o||!h){console.warn("[VideoAnnotation] Missing regionId or handle for resize");return}i.preventDefault&&i.preventDefault(),i.stopPropagation&&i.stopPropagation();const d=u?u.sharedState.getRegion(o):n.regions.find(v=>v.id===o);if(!d){console.warn("[VideoAnnotation] Region not found for resize:",o);return}this.isResizingRegion=!0,this.resizeRegionId=o,this.resizeHandle=h,this.resizeStartX=i.clientX||((T=(b=i.touches)==null?void 0:b[0])==null?void 0:T.clientX)||0,this.resizeOriginalStartTime=d.startTime,this.resizeOriginalEndTime=d.endTime,this.isPlaying&&r&&r.togglePlayPause();const m=v=>{this.updateRegionResize(v)},g=v=>{this.finishRegionResize(v),document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",g),document.removeEventListener("touchmove",m),document.removeEventListener("touchend",g)};document.addEventListener("mousemove",m),document.addEventListener("mouseup",g),document.addEventListener("touchmove",m),document.addEventListener("touchend",g),l.log("VideoAnnotation","Region resize started:",{regionId:o,handle:h,originalStart:this.resizeOriginalStartTime,originalEnd:this.resizeOriginalEndTime})},updateRegionResize(i){var x,M;if(!this.isResizingRegion||!this.resizeRegionId||!this.resizeHandle)return;const h=(i.clientX||((M=(x=i.touches)==null?void 0:x[0])==null?void 0:M.clientX)||0)-this.resizeStartX,d=this.$refs.regionBar;if(!d)return;const m=d.getBoundingClientRect(),b=h/m.width*100/100*this.duration,T=u?u.sharedState.getRegion(this.resizeRegionId):n.regions.find(P=>P.id===this.resizeRegionId);if(!T)return;let v=this.resizeOriginalStartTime,y=this.resizeOriginalEndTime;this.resizeHandle==="start"?(v=this.resizeOriginalStartTime+b,v=Math.max(0,v),v=Math.min(T.endTime-.1,v)):this.resizeHandle==="end"&&(y=this.resizeOriginalEndTime+b,y=Math.min(this.duration,y),y=Math.max(T.startTime+.1,y)),T.startTime=v,T.endTime=y,this.getFrameNumber&&(T.startFrame=this.getFrameNumber(v),T.endFrame=this.getFrameNumber(y));const w=this.resizeHandle==="start"?v:y;r&&r.seekTo(w),l.log("VideoAnnotation","Region resize updated:",{handle:this.resizeHandle,startTime:v,endTime:y,deltaTime:b})},finishRegionResize(i){if(!this.isResizingRegion)return;l.log("VideoAnnotation","Finishing region resize");const o=u?u.sharedState.getRegion(this.resizeRegionId):n.regions.find(h=>h.id===this.resizeRegionId);o&&u&&u.$dispatch("video-annotation:region-updated",{region:o}),this.isResizingRegion=!1,this.resizeRegionId=null,this.resizeHandle=null,this.resizeStartX=0,this.resizeOriginalStartTime=0,this.resizeOriginalEndTime=0,l.log("VideoAnnotation","Region resize finished")},testMenuToggle(){console.log("Menu toggle test - current showResolutionMenu:",this.showResolutionMenu),this.showResolutionMenu=!this.showResolutionMenu,console.log("Menu toggle test - new showResolutionMenu:",this.showResolutionMenu)},testRegionBar(){var i,o;l.log("VideoAnnotation","Testing region bar"),l.log("VideoAnnotation","showRegionBar:",this.showRegionBar),l.log("VideoAnnotation","showRegionToolbar:",this.showRegionToolbar),l.log("VideoAnnotation","isCreatingRegion:",this.isCreatingRegion),l.log("VideoAnnotation","config.features.enableAnnotations:",(i=a.features)==null?void 0:i.enableAnnotations),l.log("VideoAnnotation","config.annotations.enableVideoAnnotations:",(o=a.annotations)==null?void 0:o.enableVideoAnnotations),l.log("VideoAnnotation","isTouchDevice():",this.isTouchDevice()),n.showRegionBar=!0,this.isCreatingRegion=!0,this.showRegionToolbar=!0,l.log("VideoAnnotation","Forced region state - isCreatingRegion:",this.isCreatingRegion),l.log("VideoAnnotation","Forced region state - showRegionToolbar:",this.showRegionToolbar)},getSharedState(){return a.debug?n:null},debugRegions(){var i;l.log("VideoAnnotation","Debug Regions:",{regionsFromSharedState:n.regions,regionsLength:(i=n.regions)==null?void 0:i.length,duration:this.duration,sharedStateDuration:n.duration,hiddenRegions:Array.from(n.hiddenRegions),regionManagementAvailable:!!u,visibleRegions:this.getVisibleRegions()})},showComment(i){l.log("VideoAnnotation","Show comment for region:",i);const o=n.regions.find(h=>h.id===i);if(!o){console.warn("[VideoAnnotation] Region not found:",i);return}if(r&&o.startTime!==void 0&&r.seekTo(o.startTime),this.$dispatch("video-annotation:region-view",{regionId:i,region:o,startTime:o.startTime,endTime:o.endTime,title:o.title,description:o.description}),l.log("VideoAnnotation","Region Details:",{id:o.id,title:o.title,description:o.description,startTime:o.startTime,endTime:o.endTime,duration:(o.endTime-o.startTime).toFixed(2)+"s"}),o.title||o.description){const h=`${o.title||"Region"}: ${o.description||"No description"}`;l.log("VideoAnnotation","Region Info:",h)}},getModuleStatus(){return a.debug?{videoCore:r!=null&&r.publicAPI?"ready":"not initialized",progressBar:f!=null&&f.publicAPI?"ready":"not initialized",commentSystem:!!c,regionManagement:!!u,touchInterface:(S==null?void 0:S.getStatus())||"not initialized",contextDisplay:(p==null?void 0:p.getStatus())||"not initialized",eventHandler:!!C,sharedState:n.toJSON()}:null}}}export{q as default};
