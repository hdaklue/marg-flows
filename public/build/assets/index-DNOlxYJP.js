import B from"./wavesurfer.esm-Toh_7rjd.js";let W=class{constructor(){this.listeners={}}on(t,s,n){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(s),n==null?void 0:n.once){const e=()=>{this.un(t,e),this.un(t,s)};return this.on(t,e),e}return()=>this.un(t,s)}un(t,s){var n;(n=this.listeners[t])===null||n===void 0||n.delete(s)}once(t,s){return this.on(t,s,{once:!0})}unAll(){this.listeners={}}emit(t,...s){this.listeners[t]&&this.listeners[t].forEach(n=>n(...s))}},Z=class extends W{constructor(t){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=t}onInit(){}_init(t){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach(t=>t()),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}};function z(c,t,s,n,e=3,i=0,o=100){if(!c)return()=>{};const r=matchMedia("(pointer: coarse)").matches;let a=()=>{};const l=h=>{if(h.button!==i)return;h.preventDefault(),h.stopPropagation();let d=h.clientX,u=h.clientY,m=!1;const f=Date.now(),v=g=>{if(g.preventDefault(),g.stopPropagation(),r&&Date.now()-f<o)return;const p=g.clientX,R=g.clientY,x=p-d,C=R-u;if(m||Math.abs(x)>e||Math.abs(C)>e){const S=c.getBoundingClientRect(),{left:D,top:I}=S;m||(s==null||s(d-D,u-I),m=!0),t(x,C,p-D,R-I),d=p,u=R}},y=g=>{if(m){const p=g.clientX,R=g.clientY,x=c.getBoundingClientRect(),{left:C,top:S}=x;n==null||n(p-C,R-S)}a()},b=g=>{g.relatedTarget&&g.relatedTarget!==document.documentElement||y(g)},L=g=>{m&&(g.stopPropagation(),g.preventDefault())},w=g=>{m&&g.preventDefault()};document.addEventListener("pointermove",v),document.addEventListener("pointerup",y),document.addEventListener("pointerout",b),document.addEventListener("pointercancel",b),document.addEventListener("touchmove",w,{passive:!1}),document.addEventListener("click",L,{capture:!0}),a=()=>{document.removeEventListener("pointermove",v),document.removeEventListener("pointerup",y),document.removeEventListener("pointerout",b),document.removeEventListener("pointercancel",b),document.removeEventListener("touchmove",w),setTimeout(()=>{document.removeEventListener("click",L,{capture:!0})},10)}};return c.addEventListener("pointerdown",l),()=>{a(),c.removeEventListener("pointerdown",l)}}function O(c,t){const s=t.xmlns?document.createElementNS(t.xmlns,c):document.createElement(c);for(const[n,e]of Object.entries(t))if(n==="children"&&e)for(const[i,o]of Object.entries(e))o instanceof Node?s.appendChild(o):typeof o=="string"?s.appendChild(document.createTextNode(o)):s.appendChild(O(i,o));else n==="style"?Object.assign(s.style,e):n==="textContent"?s.textContent=e:s.setAttribute(n,e.toString());return s}function E(c,t,s){const n=O(c,t||{});return s==null||s.appendChild(n),n}let T=class extends W{constructor(t,s,n=0){var e,i,o,r,a,l,h,d,u,m;super(),this.totalDuration=s,this.numberOfChannels=n,this.element=null,this.minLength=0,this.maxLength=1/0,this.contentEditable=!1,this.subscriptions=[],this.isRemoved=!1,this.subscriptions=[],this.id=t.id||`region-${Math.random().toString(32).slice(2)}`,this.start=this.clampPosition(t.start),this.end=this.clampPosition((e=t.end)!==null&&e!==void 0?e:t.start),this.drag=(i=t.drag)===null||i===void 0||i,this.resize=(o=t.resize)===null||o===void 0||o,this.resizeStart=(r=t.resizeStart)===null||r===void 0||r,this.resizeEnd=(a=t.resizeEnd)===null||a===void 0||a,this.color=(l=t.color)!==null&&l!==void 0?l:"rgba(0, 0, 0, 0.1)",this.minLength=(h=t.minLength)!==null&&h!==void 0?h:this.minLength,this.maxLength=(d=t.maxLength)!==null&&d!==void 0?d:this.maxLength,this.channelIdx=(u=t.channelIdx)!==null&&u!==void 0?u:-1,this.contentEditable=(m=t.contentEditable)!==null&&m!==void 0?m:this.contentEditable,this.element=this.initElement(),this.setContent(t.content),this.setPart(),this.renderPosition(),this.initMouseEvents()}clampPosition(t){return Math.max(0,Math.min(this.totalDuration,t))}setPart(){var t;const s=this.start===this.end;(t=this.element)===null||t===void 0||t.setAttribute("part",`${s?"marker":"region"} ${this.id}`)}addResizeHandles(t){const s={position:"absolute",zIndex:"2",width:"6px",height:"100%",top:"0",cursor:"ew-resize",wordBreak:"keep-all"},n=E("div",{part:"region-handle region-handle-left",style:Object.assign(Object.assign({},s),{left:"0",borderLeft:"2px solid rgba(0, 0, 0, 0.5)",borderRadius:"2px 0 0 2px"})},t),e=E("div",{part:"region-handle region-handle-right",style:Object.assign(Object.assign({},s),{right:"0",borderRight:"2px solid rgba(0, 0, 0, 0.5)",borderRadius:"0 2px 2px 0"})},t);this.subscriptions.push(z(n,i=>this.onResize(i,"start"),()=>null,()=>this.onEndResizing(),1),z(e,i=>this.onResize(i,"end"),()=>null,()=>this.onEndResizing(),1))}removeResizeHandles(t){const s=t.querySelector('[part*="region-handle-left"]'),n=t.querySelector('[part*="region-handle-right"]');s&&t.removeChild(s),n&&t.removeChild(n)}initElement(){if(this.isRemoved)return null;const t=this.start===this.end;let s=0,n=100;this.channelIdx>=0&&this.channelIdx<this.numberOfChannels&&(n=100/this.numberOfChannels,s=n*this.channelIdx);const e=E("div",{style:{position:"absolute",top:`${s}%`,height:`${n}%`,backgroundColor:t?"none":this.color,borderLeft:t?"2px solid "+this.color:"none",borderRadius:"2px",boxSizing:"border-box",transition:"background-color 0.2s ease",cursor:this.drag?"grab":"default",pointerEvents:"all"}});return!t&&this.resize&&this.addResizeHandles(e),e}renderPosition(){if(!this.element)return;const t=this.start/this.totalDuration,s=(this.totalDuration-this.end)/this.totalDuration;this.element.style.left=100*t+"%",this.element.style.right=100*s+"%"}toggleCursor(t){var s;this.drag&&(!((s=this.element)===null||s===void 0)&&s.style)&&(this.element.style.cursor=t?"grabbing":"grab")}initMouseEvents(){const{element:t}=this;t&&(t.addEventListener("click",s=>this.emit("click",s)),t.addEventListener("mouseenter",s=>this.emit("over",s)),t.addEventListener("mouseleave",s=>this.emit("leave",s)),t.addEventListener("dblclick",s=>this.emit("dblclick",s)),t.addEventListener("pointerdown",()=>this.toggleCursor(!0)),t.addEventListener("pointerup",()=>this.toggleCursor(!1)),this.subscriptions.push(z(t,s=>this.onMove(s),()=>this.toggleCursor(!0),()=>{this.toggleCursor(!1),this.drag&&this.emit("update-end")})),this.contentEditable&&this.content&&(this.content.addEventListener("click",s=>this.onContentClick(s)),this.content.addEventListener("blur",()=>this.onContentBlur())))}_onUpdate(t,s){var n;if(!(!((n=this.element)===null||n===void 0)&&n.parentElement))return;const{width:e}=this.element.parentElement.getBoundingClientRect(),i=t/e*this.totalDuration,o=s&&s!=="start"?this.start:this.start+i,r=s&&s!=="end"?this.end:this.end+i,a=r-o;o>=0&&r<=this.totalDuration&&o<=r&&a>=this.minLength&&a<=this.maxLength&&(this.start=o,this.end=r,this.renderPosition(),this.emit("update",s))}onMove(t){this.drag&&this._onUpdate(t)}onResize(t,s){this.resize&&(this.resizeStart||s!=="start")&&(this.resizeEnd||s!=="end")&&this._onUpdate(t,s)}onEndResizing(){this.resize&&this.emit("update-end")}onContentClick(t){t.stopPropagation(),t.target.focus(),this.emit("click",t)}onContentBlur(){this.emit("update-end")}_setTotalDuration(t){this.totalDuration=t,this.renderPosition()}play(t){this.emit("play",t&&this.end!==this.start?this.end:void 0)}getContent(t=!1){var s;return t?this.content||void 0:this.element instanceof HTMLElement?((s=this.content)===null||s===void 0?void 0:s.innerHTML)||void 0:""}setContent(t){var s;if(this.element)if((s=this.content)===null||s===void 0||s.remove(),t){if(typeof t=="string"){const n=this.start===this.end;this.content=E("div",{style:{padding:`0.2em ${n?.2:.4}em`,display:"inline-block"},textContent:t})}else this.content=t;this.contentEditable&&(this.content.contentEditable="true"),this.content.setAttribute("part","region-content"),this.element.appendChild(this.content),this.emit("content-changed")}else this.content=void 0}setOptions(t){var s,n;if(this.element){if(t.color&&(this.color=t.color,this.element.style.backgroundColor=this.color),t.drag!==void 0&&(this.drag=t.drag,this.element.style.cursor=this.drag?"grab":"default"),t.start!==void 0||t.end!==void 0){const e=this.start===this.end;this.start=this.clampPosition((s=t.start)!==null&&s!==void 0?s:this.start),this.end=this.clampPosition((n=t.end)!==null&&n!==void 0?n:e?this.start:this.end),this.renderPosition(),this.setPart()}if(t.content&&this.setContent(t.content),t.id&&(this.id=t.id,this.setPart()),t.resize!==void 0&&t.resize!==this.resize){const e=this.start===this.end;this.resize=t.resize,this.resize&&!e?this.addResizeHandles(this.element):this.removeResizeHandles(this.element)}t.resizeStart!==void 0&&(this.resizeStart=t.resizeStart),t.resizeEnd!==void 0&&(this.resizeEnd=t.resizeEnd)}}remove(){this.isRemoved=!0,this.emit("remove"),this.subscriptions.forEach(t=>t()),this.element&&(this.element.remove(),this.element=null)}};class P extends Z{constructor(t){super(t),this.regions=[],this.regionsContainer=this.initRegionsContainer()}static create(t){return new P(t)}onInit(){if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");this.wavesurfer.getWrapper().appendChild(this.regionsContainer);let t=[];this.subscriptions.push(this.wavesurfer.on("timeupdate",s=>{const n=this.regions.filter(e=>e.start<=s&&(e.end===e.start?e.start+.05:e.end)>=s);n.forEach(e=>{t.includes(e)||this.emit("region-in",e)}),t.forEach(e=>{n.includes(e)||this.emit("region-out",e)}),t=n}))}initRegionsContainer(){return E("div",{style:{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",zIndex:"5",pointerEvents:"none"}})}getRegions(){return this.regions}avoidOverlapping(t){t.content&&setTimeout(()=>{const s=t.content,n=s.getBoundingClientRect(),e=this.regions.map(i=>{if(i===t||!i.content)return 0;const o=i.content.getBoundingClientRect();return n.left<o.left+o.width&&o.left<n.left+n.width?o.height:0}).reduce((i,o)=>i+o,0);s.style.marginTop=`${e}px`},10)}adjustScroll(t){var s,n;if(!t.element)return;const e=(n=(s=this.wavesurfer)===null||s===void 0?void 0:s.getWrapper())===null||n===void 0?void 0:n.parentElement;if(!e)return;const{clientWidth:i,scrollWidth:o}=e;if(o<=i)return;const r=e.getBoundingClientRect(),a=t.element.getBoundingClientRect(),l=a.left-r.left,h=a.right-r.left;l<0?e.scrollLeft+=l:h>i&&(e.scrollLeft+=h-i)}virtualAppend(t,s,n){const e=()=>{if(!this.wavesurfer)return;const i=this.wavesurfer.getWidth(),o=this.wavesurfer.getScroll(),r=s.clientWidth,a=this.wavesurfer.getDuration(),l=Math.round(t.start/a*r),h=l+(Math.round((t.end-t.start)/a*r)||1)>o&&l<o+i;h&&!n.parentElement?s.appendChild(n):!h&&n.parentElement&&n.remove()};setTimeout(()=>{if(!this.wavesurfer||!t.element)return;e();const i=this.wavesurfer.on("scroll",e),o=this.wavesurfer.on("zoom",e);this.subscriptions.push(t.once("remove",i),i),this.subscriptions.push(t.once("remove",o),o)},0)}saveRegion(t){if(!t.element)return;this.virtualAppend(t,this.regionsContainer,t.element),this.avoidOverlapping(t),this.regions.push(t);const s=[t.on("update",n=>{n||this.adjustScroll(t),this.emit("region-update",t,n)}),t.on("update-end",()=>{this.avoidOverlapping(t),this.emit("region-updated",t)}),t.on("play",n=>{var e;(e=this.wavesurfer)===null||e===void 0||e.play(t.start,n)}),t.on("click",n=>{this.emit("region-clicked",t,n)}),t.on("dblclick",n=>{this.emit("region-double-clicked",t,n)}),t.on("content-changed",()=>{this.emit("region-content-changed",t)}),t.once("remove",()=>{s.forEach(n=>n()),this.regions=this.regions.filter(n=>n!==t),this.emit("region-removed",t)})];this.subscriptions.push(...s),this.emit("region-created",t)}addRegion(t){var s,n;if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");const e=this.wavesurfer.getDuration(),i=(n=(s=this.wavesurfer)===null||s===void 0?void 0:s.getDecodedData())===null||n===void 0?void 0:n.numberOfChannels,o=new T(t,e,i);return this.emit("region-initialized",o),e?this.saveRegion(o):this.subscriptions.push(this.wavesurfer.once("ready",r=>{o._setTotalDuration(r),this.saveRegion(o)})),o}enableDragSelection(t,s=3){var n;const e=(n=this.wavesurfer)===null||n===void 0?void 0:n.getWrapper();if(!(e&&e instanceof HTMLElement))return()=>{};let i=null,o=0;return z(e,(r,a,l)=>{i&&i._onUpdate(r,l>o?"end":"start")},r=>{var a,l;if(o=r,!this.wavesurfer)return;const h=this.wavesurfer.getDuration(),d=(l=(a=this.wavesurfer)===null||a===void 0?void 0:a.getDecodedData())===null||l===void 0?void 0:l.numberOfChannels,{width:u}=this.wavesurfer.getWrapper().getBoundingClientRect(),m=r/u*h,f=(r+5)/u*h;i=new T(Object.assign(Object.assign({},t),{start:m,end:f}),h,d),this.emit("region-initialized",i),i.element&&this.regionsContainer.appendChild(i.element)},()=>{i&&(this.saveRegion(i),i=null)},s)}clearRegions(){this.regions.slice().forEach(t=>t.remove()),this.regions=[]}destroy(){this.clearRegions(),super.destroy(),this.regionsContainer.remove()}}let V=class{constructor(){this.listeners={}}on(t,s,n){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(s),n==null?void 0:n.once){const e=()=>{this.un(t,e),this.un(t,s)};return this.on(t,e),e}return()=>this.un(t,s)}un(t,s){var n;(n=this.listeners[t])===null||n===void 0||n.delete(s)}once(t,s){return this.on(t,s,{once:!0})}unAll(){this.listeners={}}emit(t,...s){this.listeners[t]&&this.listeners[t].forEach(n=>n(...s))}},H=class extends V{constructor(t){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=t}onInit(){}_init(t){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach(t=>t()),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}};function A(c,t){const s=t.xmlns?document.createElementNS(t.xmlns,c):document.createElement(c);for(const[n,e]of Object.entries(t))if(n==="children"&&e)for(const[i,o]of Object.entries(e))o instanceof Node?s.appendChild(o):typeof o=="string"?s.appendChild(document.createTextNode(o)):s.appendChild(A(i,o));else n==="style"?Object.assign(s.style,e):n==="textContent"?s.textContent=e:s.setAttribute(n,e.toString());return s}function $(c,t,s){return A(c,t||{})}const j={height:20,timeOffset:0,formatTimeCallback:c=>c/60>1?`${Math.floor(c/60)}:${`${(c=Math.round(c%60))<10?"0":""}${c}`}`:`${Math.round(1e3*c)/1e3}`};class k extends H{constructor(t){super(t||{}),this.unsubscribeNotches=[],this.options=Object.assign({},j,t),this.timelineWrapper=this.initTimelineWrapper()}static create(t){return new k(t)}onInit(){var t;if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");let s=this.wavesurfer.getWrapper();if(this.options.container instanceof HTMLElement)s=this.options.container;else if(typeof this.options.container=="string"){const n=document.querySelector(this.options.container);if(!n)throw Error(`No Timeline container found matching ${this.options.container}`);s=n}this.options.insertPosition?(s.firstElementChild||s).insertAdjacentElement(this.options.insertPosition,this.timelineWrapper):s.appendChild(this.timelineWrapper),this.subscriptions.push(this.wavesurfer.on("redraw",()=>this.initTimeline())),(!((t=this.wavesurfer)===null||t===void 0)&&t.getDuration()||this.options.duration)&&this.initTimeline()}destroy(){this.unsubscribeNotches.forEach(t=>t()),this.unsubscribeNotches=[],this.timelineWrapper.remove(),super.destroy()}initTimelineWrapper(){return $("div",{part:"timeline-wrapper",style:{pointerEvents:"none"}})}defaultTimeInterval(t){return t>=25?1:5*t>=25?5:15*t>=25?15:60*Math.ceil(.5/t)}defaultPrimaryLabelInterval(t){return t>=25?10:5*t>=25?6:4}defaultSecondaryLabelInterval(t){return t>=25?5:2}virtualAppend(t,s,n){let e=!1;const i=(a,l)=>{if(!this.wavesurfer)return;const h=n.clientWidth,d=t>=a&&t+h<l;d!==e&&(e=d,d?s.appendChild(n):n.remove())};if(!this.wavesurfer)return;const o=this.wavesurfer.getScroll(),r=o+this.wavesurfer.getWidth();i(o,r),this.unsubscribeNotches.push(this.wavesurfer.on("scroll",(a,l,h,d)=>{i(h,d)}))}initTimeline(){var t,s,n,e,i,o,r,a;this.unsubscribeNotches.forEach(w=>w()),this.unsubscribeNotches=[];const l=(n=(s=(t=this.wavesurfer)===null||t===void 0?void 0:t.getDuration())!==null&&s!==void 0?s:this.options.duration)!==null&&n!==void 0?n:0,h=(((e=this.wavesurfer)===null||e===void 0?void 0:e.getWrapper().scrollWidth)||this.timelineWrapper.scrollWidth)/l,d=(i=this.options.timeInterval)!==null&&i!==void 0?i:this.defaultTimeInterval(h),u=(o=this.options.primaryLabelInterval)!==null&&o!==void 0?o:this.defaultPrimaryLabelInterval(h),m=this.options.primaryLabelSpacing,f=(r=this.options.secondaryLabelInterval)!==null&&r!==void 0?r:this.defaultSecondaryLabelInterval(h),v=this.options.secondaryLabelSpacing,y=this.options.insertPosition==="beforebegin",b=$("div",{style:Object.assign({height:`${this.options.height}px`,overflow:"hidden",fontSize:this.options.height/2+"px",whiteSpace:"nowrap"},y?{position:"absolute",top:"0",left:"0",right:"0",zIndex:"2"}:{position:"relative"})});b.setAttribute("part","timeline"),typeof this.options.style=="string"?b.setAttribute("style",b.getAttribute("style")+this.options.style):typeof this.options.style=="object"&&Object.assign(b.style,this.options.style);const L=$("div",{style:{width:"0",height:"50%",display:"flex",flexDirection:"column",justifyContent:y?"flex-start":"flex-end",top:y?"0":"auto",bottom:y?"auto":"0",overflow:"visible",borderLeft:"1px solid currentColor",opacity:`${(a=this.options.secondaryLabelOpacity)!==null&&a!==void 0?a:.25}`,position:"absolute",zIndex:"1"}});for(let w=0,g=0;w<l;w+=d,g++){const p=L.cloneNode(),R=Math.round(100*w)%Math.round(100*u)==0||m&&g%m==0,x=Math.round(100*w)%Math.round(100*f)==0||v&&g%v==0;(R||x)&&(p.style.height="100%",p.style.textIndent="3px",p.textContent=this.options.formatTimeCallback(w),R&&(p.style.opacity="1"));const C=R?"primary":x?"secondary":"tick";p.setAttribute("part",`timeline-notch timeline-notch-${C}`);const S=Math.round(100*(w+this.options.timeOffset))/100*h;p.style.left=`${S}px`,this.virtualAppend(S,b,p)}this.timelineWrapper.innerHTML="",this.timelineWrapper.appendChild(b),this.emit("ready")}}class q{constructor(){this.listeners={}}on(t,s,n){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(s),n==null?void 0:n.once){const e=()=>{this.un(t,e),this.un(t,s)};return this.on(t,e),e}return()=>this.un(t,s)}un(t,s){var n;(n=this.listeners[t])===null||n===void 0||n.delete(s)}once(t,s){return this.on(t,s,{once:!0})}unAll(){this.listeners={}}emit(t,...s){this.listeners[t]&&this.listeners[t].forEach(n=>n(...s))}}class N extends q{constructor(t){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=t}onInit(){}_init(t){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach(t=>t()),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}}const F={scale:.5,deltaThreshold:5,exponentialZooming:!1,iterations:20};class M extends N{constructor(t){super(t||{}),this.wrapper=void 0,this.container=null,this.accumulatedDelta=0,this.pointerTime=0,this.oldX=0,this.endZoom=0,this.startZoom=0,this.onWheel=s=>{if(this.wavesurfer&&this.container&&!(Math.abs(s.deltaX)>=Math.abs(s.deltaY))&&(s.preventDefault(),this.accumulatedDelta+=-s.deltaY,this.startZoom===0&&this.options.exponentialZooming&&(this.startZoom=this.wavesurfer.getWrapper().clientWidth/this.wavesurfer.getDuration()),this.options.deltaThreshold===0||Math.abs(this.accumulatedDelta)>=this.options.deltaThreshold)){const n=this.wavesurfer.getDuration(),e=this.wavesurfer.options.minPxPerSec===0?this.wavesurfer.getWrapper().scrollWidth/n:this.wavesurfer.options.minPxPerSec,i=s.clientX-this.container.getBoundingClientRect().left,o=this.container.clientWidth,r=this.wavesurfer.getScroll();i===this.oldX&&this.oldX!==0||(this.pointerTime=(r+i)/e),this.oldX=i;const a=this.calculateNewZoom(e,this.accumulatedDelta),l=o/a*(i/o);a*n<o?(this.wavesurfer.zoom(o/n),this.container.scrollLeft=0):(this.wavesurfer.zoom(a),this.container.scrollLeft=(this.pointerTime-l)*a),this.accumulatedDelta=0}},this.calculateNewZoom=(s,n)=>{let e;if(this.options.exponentialZooming){const i=n>0?Math.pow(this.endZoom/this.startZoom,1/(this.options.iterations-1)):Math.pow(this.startZoom/this.endZoom,1/(this.options.iterations-1));e=Math.max(0,s*i)}else e=Math.max(0,s+n*this.options.scale);return Math.min(e,this.options.maxZoom)},this.options=Object.assign({},F,t)}static create(t){return new M(t)}onInit(){var t;this.wrapper=(t=this.wavesurfer)===null||t===void 0?void 0:t.getWrapper(),this.wrapper&&(this.container=this.wrapper.parentElement,this.container.addEventListener("wheel",this.onWheel),this.options.maxZoom===void 0&&(this.options.maxZoom=this.container.clientWidth),this.endZoom=this.options.maxZoom)}destroy(){this.wrapper&&this.wrapper.removeEventListener("wheel",this.onWheel),super.destroy()}}function J(c=null,t=[]){const s={features:{enableAnnotations:!0,enableComments:!0,enableRegions:!0,enableKeyboardShortcuts:!0,enableWaveformClick:!0,enableVolumeControls:!0,enableTimeDisplay:!0},ui:{waveColor:"#e5e7eb",progressColor:"#3b82f6",cursorColor:"#ef4444",theme:"auto"},annotations:{enableWaveformComments:!0,enableHapticFeedback:!0,regionColor:"rgba(168, 85, 247, 0.2)",regionBorderColor:"#a855f7"},zoom:{scale:.3,maxZoom:500,minZoom:50,wheelZoom:!0,touchZoom:!0},timing:{commentPrecision:.01,seekPrecision:.1}},n=c?{...s,...c}:s;return{wavesurfer:null,regionsPlugin:null,zoomPlugin:null,timelinePlugin:null,isLoaded:!1,isPlaying:!1,currentTime:0,duration:0,volume:1,isMuted:!1,previousVolume:1,playbackRate:1,showSpeedMenu:!1,showSpeedModal:!1,showVolumeModal:!1,showVolumeSlider:!1,showRegions:!0,isSelectingRegion:!1,selectedRegion:null,activeRegion:null,regionLoop:!1,hiddenRegions:new Set,currentZoom:150,comments:t||[],activeCommentId:null,isSafari:!1,windowWidth:window.innerWidth,mobileControlsExpanded:!1,config:n,init(){if(this.$el.dataset.audioInitialized){console.log("Audio annotation already initialized on this element");return}this.$el.dataset.audioInitialized="true",this.detectBrowser(),window.addEventListener("resize",()=>{this.windowWidth=window.innerWidth}),!this.isSafari&&this.$nextTick(()=>{this.setupWaveSurfer(),this.setupEventListeners();const e=this.$el.dataset.audioSrc;e&&!this.isLoaded&&this.loadAudio(e)})},detectBrowser(){this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)},setupWaveSurfer(){const e=this.$refs.waveform;if(!e){console.error("Waveform container not found");return}if(this.wavesurfer){console.log("WaveSurfer already initialized, skipping...");return}try{this.regionsPlugin=P.create(),this.zoomPlugin=M.create({scale:this.config.zoom.scale,maxZoom:this.config.zoom.maxZoom}),this.timelinePlugin=k.create({timeInterval:.1,primaryLabelInterval:1,secondaryLabelInterval:.25,style:{fontSize:this.windowWidth<768?"8px":"10px",color:"#9ca3af",fontFamily:"ui-sans-serif, system-ui, sans-serif"}}),this.wavesurfer=B.create({container:e,waveColor:this.config.ui.waveColor,progressColor:this.config.ui.progressColor,cursorColor:this.config.ui.cursorColor,barWidth:2,barRadius:1,responsive:!0,minPxPerSec:150,height:100,normalize:!0,dragToSeek:!0,plugins:[this.regionsPlugin,this.zoomPlugin,this.timelinePlugin]}),this.setupWaveSurferEvents()}catch(i){console.error("Failed to initialize WaveSurfer:",i)}},setupWaveSurferEvents(){if(this.wavesurfer){this.wavesurfer.on("decode",()=>{this.isLoaded=!0,this.duration=this.wavesurfer.getDuration(),this.renderCommentRegions(),setTimeout(()=>{this.ensureAllRegionsHaveHandlers()},300)}),this.wavesurfer.on("play",()=>{this.isPlaying=!0}),this.wavesurfer.on("pause",()=>{this.isPlaying=!1}),this.wavesurfer.on("timeupdate",e=>{this.currentTime=e}),this.wavesurfer.on("volume",e=>{this.volume=e,e===0&&!this.isMuted?this.isMuted=!0:e>0&&this.isMuted&&(this.isMuted=!1)}),this.config.features.enableWaveformClick&&this.wavesurfer.on("click",e=>{const i=e*this.duration;this.seekTo(i)}),this.regionsPlugin.on("region-created",e=>{this.handleRegionCreated(e)}),this.regionsPlugin.on("region-clicked",e=>{this.handleRegionClicked(e)}),this.regionsPlugin.on("region-mouseenter",e=>{console.log("Region mouseenter:",e.id)});{let e=new Set;this.regionsPlugin.on("region-in",i=>{e.has(i.id)||(e.add(i.id),this.handleRegionEnterViewport(i),i.id&&i.id.startsWith("comment-")&&(this.activeRegion=i))}),this.regionsPlugin.on("region-out",i=>{e.has(i.id)&&(e.delete(i.id),this.handleRegionLeaveViewport(i),this.activeRegion===i&&this.regionLoop&&i.id&&i.id.startsWith("comment-")?setTimeout(()=>{this.activeRegion===i&&this.regionLoop&&i.play()},50):this.activeRegion===i&&(this.activeRegion=null))})}this.wavesurfer.on("interaction",()=>{this.activeRegion=null}),this.wavesurfer.on("zoom",e=>{this.currentZoom=Math.round(e),this.$dispatch("audio-annotation:zoom-changed",{zoom:this.currentZoom})})}},setupEventListeners(){this.$el.addEventListener("audio-annotation:add-comment",e=>{this.addComment(e.detail)}),this.$el.addEventListener("audio-annotation:seek-comment",e=>{this.seekToComment(e.detail.commentId)}),this.$el.addEventListener("audio-annotation:hide-region",e=>{const{id:i}=e.detail;i&&this.hideRegionById(i)}),this.$el.addEventListener("audio-annotation:add-region",e=>{const i=e.detail;i&&this.addExternalRegion(i)}),setTimeout(()=>{const e=this.$refs.waveform;if(e){const i=e.querySelector("div");i&&(i.addEventListener("scroll",()=>{this.updateBubblePositions()}),new ResizeObserver(()=>{this.updateBubblePositions()}).observe(i))}},1e3),document.addEventListener("wheel",e=>{if(e.shiftKey&&this.wavesurfer&&this.isLoaded){e.preventDefault();const i=e.deltaY,o=.05;if(i<0){const r=Math.min(this.volume+o,1);this.setVolume(r)}else{const r=Math.max(this.volume-o,0);this.setVolume(r)}}},{passive:!1})},togglePlay(){!this.wavesurfer||!this.isLoaded||(this.isPlaying?this.wavesurfer.pause():this.wavesurfer.play())},seekTo(e){if(!this.wavesurfer||!this.isLoaded)return;const i=Math.max(0,Math.min(e,this.duration));this.wavesurfer.seekTo(i/this.duration)},seekForward(){const e=Math.min(this.currentTime+this.config.timing.seekPrecision,this.duration);this.seekTo(e)},seekBackward(){const e=Math.max(this.currentTime-this.config.timing.seekPrecision,0);this.seekTo(e)},setVolume(e){if(!this.wavesurfer)return;const i=Math.max(0,Math.min(1,e));this.wavesurfer.setVolume(i),this.volume=i,this.isMuted=i===0},toggleMute(){if(this.wavesurfer)if(this.isMuted){const e=this.previousVolume>0?this.previousVolume:.5;this.wavesurfer.setVolume(e),this.volume=e,this.isMuted=!1}else this.previousVolume=this.volume,this.wavesurfer.setVolume(0),this.isMuted=!0},setPlaybackRate(e){this.wavesurfer&&(this.playbackRate=e,this.wavesurfer.setPlaybackRate(e))},toggleSpeedMenu(){this.showSpeedMenu=!this.showSpeedMenu},toggleSpeedModal(){this.showSpeedModal=!this.showSpeedModal},toggleVolumeModal(){this.showVolumeModal=!this.showVolumeModal},setSpeedAndCloseModal(e){this.setPlaybackRate(e),this.showSpeedModal=!1,this.showSpeedMenu=!1},getVolumePercentage(){return Math.round(this.volume*100)},toggleRegions(){this.showRegions=!this.showRegions,this.showRegions?this.renderCommentRegions():this.hideCommentRegions()},toggleRegionLoop(){this.regionLoop=!this.regionLoop,console.log(`Region looping ${this.regionLoop?"enabled":"disabled"}`)},toggleRegionVisibility(e){var r,a;const i=e.toString(),o=this.regionsPlugin.getRegions().find(l=>l.id===`comment-${e}`);if(o)if(this.hiddenRegions.has(i)){this.hiddenRegions.delete(i),o.element&&(o.element.style.display="block");const l=(r=this.$refs.bubbleOverlay)==null?void 0:r.querySelector(`.comment-bubble-container[data-comment-id="${e}"]`);l&&(l.style.display="flex"),console.log(`Showing region for comment: ${e}`)}else{this.hiddenRegions.add(i),o.element&&(o.element.style.display="none");const l=(a=this.$refs.bubbleOverlay)==null?void 0:a.querySelector(`.comment-bubble-container[data-comment-id="${e}"]`);l&&(l.style.display="none"),console.log(`Hidden region for comment: ${e}`)}},isRegionHidden(e){return this.hiddenRegions.has(e.toString())},hideRegionById(e){const i=this.regionsPlugin.getRegions().find(o=>o.id===`comment-${e}`);i&&(i.remove(),console.log(`Region removed for comment: ${e}`),this.removeBubbleFromOverlay(e),this.comments=this.comments.filter(o=>o.commentId.toString()!==e.toString()))},addExternalRegion(e){if(!this.regionsPlugin||!this.isLoaded){console.warn("Audio not loaded yet, cannot add region");return}const{commentId:i,timestamp:o,duration:r=2,body:a,name:l,avatar:h="https://ui-avatars.com/api/?name="+encodeURIComponent(l)+"&background=a855f7&color=fff"}=e;if(this.regionsPlugin.getRegions().find(v=>v.id===`comment-${i}`)){console.log(`Region already exists for comment: ${i}`);return}const u={commentId:i,timestamp:o,duration:r,body:a,name:l,avatar:h},m=this.comments.findIndex(v=>v.commentId.toString()===i.toString());m>=0?this.comments[m]=u:this.comments.push(u);const f=this.regionsPlugin.addRegion({start:o,end:o+r,color:"rgba(168, 85, 247, 0.15)",drag:!1,resize:!1,id:`comment-${i}`,content:""});f.commentData=u,f.commentIndex=this.comments.length-1,this.scheduleRegionSetup(f,u),console.log(`External region added for comment: ${i}`)},showAllHiddenRegions(){this.hiddenRegions.clear(),this.renderCommentRegions(),console.log("All hidden regions restored")},hideCommentRegions(){this.regionsPlugin&&this.regionsPlugin.clearRegions()},getSpeedOptions(){return[{value:.25,label:"0.25x"},{value:.5,label:"0.5x"},{value:.75,label:"0.75x"},{value:1,label:"1x"},{value:1.25,label:"1.25x"},{value:1.5,label:"1.5x"},{value:2,label:"2x"}]},addComment(e){if(this.isPlaying&&this.wavesurfer.pause(),e&&e.start!==void 0&&e.end!==void 0){const i={commentId:Date.now(),timestamp:e.start,duration:e.end-e.start,body:e.body||`Comment at ${this.formatTimeRange(e.start,e.end)}`,name:e.name||"User",avatar:e.avatar||"https://ui-avatars.com/api/?name=User&background=a855f7&color=fff"};this.comments.push(i),this.renderCommentRegions();return}this.startRegionSelection()},startRegionSelection(){this.hideCommentRegions(),this.isSelectingRegion=!0,this.showRegions=!1;const e=this.currentTime,i=2;this.selectedRegion=this.regionsPlugin.addRegion({start:e,end:e+i,color:"rgba(34, 197, 94, 0.25)",drag:!0,resize:!0,id:"region-selection",content:""}),this.selectedRegion&&this.selectedRegion.element&&this.selectedRegion.element.classList.add("region-selecting")},finishRegionSelection(){if(!this.selectedRegion)return;const e=this.selectedRegion.start,i=this.selectedRegion.end;this.regionsPlugin.clearRegions(),this.selectedRegion=null,this.isSelectingRegion=!1,this.$dispatch("audio-annotation:add-comment",{start:e,end:i,timestamp:e,duration:i-e}),this.showRegions=!0,this.renderCommentRegions()},cancelRegionSelection(){this.selectedRegion&&(this.regionsPlugin.clearRegions(),this.selectedRegion=null),this.isSelectingRegion=!1,this.showRegions=!0,this.renderCommentRegions()},seekToComment(e){const i=this.comments.find(o=>o.commentId===e);i&&(this.seekTo(i.timestamp),this.activateCommentRegion(e))},renderCommentRegions(){if(!this.regionsPlugin||!this.isLoaded)return;if(!this.showRegions||this.isSelectingRegion){this.regionsPlugin.getRegions().forEach(r=>{r.element&&(r.element.style.display="none")});const o=this.$refs.bubbleOverlay;o&&o.querySelectorAll(".comment-bubble-container").forEach(a=>a.style.display="none");return}const e=this.regionsPlugin.getRegions(),i=new Set(e.map(o=>o.id));this.comments.forEach((o,r)=>{var d;const a=`comment-${o.commentId}`;if(i.has(a)){const u=e.find(f=>f.id===a);u&&u.element&&(this.isRegionHidden(o.commentId)||(u.element.style.display="block"));const m=(d=this.$refs.bubbleOverlay)==null?void 0:d.querySelector(`.comment-bubble-container[data-comment-id="${o.commentId}"]`);m&&(this.isRegionHidden(o.commentId)||(m.style.display="flex"));return}const l=o.duration||2,h=this.regionsPlugin.addRegion({start:o.timestamp,end:o.timestamp+l,color:"rgba(168, 85, 247, 0.15)",drag:!1,resize:!1,id:a,content:""});h.commentData=o,h.commentIndex=r,this.scheduleRegionSetup(h,o)})},scheduleRegionSetup(e,i,o=0){if(o>=10){console.warn(`Failed to setup handlers for region ${e.id} after 10 attempts`);return}e.element?this.setupRegionHandlers(e,i):setTimeout(()=>{this.scheduleRegionSetup(e,i,o+1)},100)},setupRegionHandlers(e,i){if(e._handlersSetup){console.log("Handlers already setup for region:",e.id);return}if(e._handlersSetup=!0,!e.element){console.warn("Region element still not ready for:",e.id);return}console.log("Setting up handlers for region:",i.commentId,"Element:",e.element);const o=`${i.name}: ${i.body.substring(0,50)}${i.body.length>50?"...":""}`;e.element.setAttribute("data-tooltip",o),e.element.setAttribute("title",o),this.isRegionHidden(i.commentId)&&e.element&&(e.element.style.display="none"),e.element.addEventListener("click",r=>{r.stopPropagation(),this.handleRegionClicked(e)}),e.element.setAttribute("data-comment-id",i.commentId)},handleRegionCreated(e){if(e.id&&e.id.startsWith("comment-")){const i=e.commentData;i&&this.setupRegionHandlers(e,i)}},createBubbleInOverlay(e,i){const o=this.$refs.bubbleOverlay;if(!o)return;if(o.querySelector(`[data-comment-id="${i.commentId}"]`)){console.log("Bubble already exists for comment:",i.commentId);return}const a=this.$refs.waveform.getBoundingClientRect(),h=e.element.getBoundingClientRect().left-a.left,d=document.createElement("div");d.className="comment-bubble-overlay",d.textContent="💬",d.setAttribute("data-comment-id",i.commentId),d.style.cssText=`
                position: absolute;
                top: 0;
                left: ${h}px;
                width: 20px;
                height: 20px;
                background: rgba(168, 85, 247, 0.9);
                color: white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                border: 2px solid white;
                box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3);
                z-index: 25;
                transition: all 0.2s ease-in-out;
                cursor: pointer;
                pointer-events: all;
            `,d.addEventListener("click",u=>{u.stopPropagation(),console.log("Bubble clicked for comment:",i.commentId),this.isPlaying&&this.wavesurfer.pause(),this.$dispatch("audio-annotation:view-comment",{commentId:i.commentId})}),d.addEventListener("mouseenter",()=>{d.style.transform="scale(1.1)",d.style.boxShadow="0 4px 12px rgba(168, 85, 247, 0.5)"}),d.addEventListener("mouseleave",()=>{d.style.transform="scale(1)",d.style.boxShadow="0 2px 8px rgba(168, 85, 247, 0.3)"}),o.appendChild(d)},handleRegionEnterViewport(e){if(e.id&&e.id.startsWith("comment-")&&e.commentData){console.log("Region entered viewport:",e.id);const i=this.$refs.bubbleOverlay;i&&(i.querySelector(`[data-comment-id="${e.commentData.commentId}"]`)||this.createBubbleInOverlay(e,e.commentData))}},handleRegionLeaveViewport(e){e.id&&e.id.startsWith("comment-")&&(console.log("Region left viewport:",e.id),e.commentData&&this.isPlaying&&this.removeBubbleFromOverlay(e.commentData.commentId))},removeBubbleFromOverlay(e){const i=this.$refs.bubbleOverlay;if(i){const o=i.querySelector(`[data-comment-id="${e}"]`);o&&(o.remove(),console.log("Bubble removed for comment:",e))}},updateBubblePositions(){const e=this.$refs.bubbleOverlay;if(!e)return;const i=document.querySelectorAll('[part*="region comment-"]'),o=this.$refs.waveform.getBoundingClientRect();i.forEach(a=>{var d;const h=(d=a.getAttribute("part").match(/comment-(.+)/))==null?void 0:d[1];if(h){const u=e.querySelector(`[data-comment-id="${h}"]`),f=a.getBoundingClientRect().left-o.left;if(u)u.style.left=`${f}px`;else{const v=this.comments.find(y=>y.commentId.toString()===h);v&&this.createBubbleForComment(v,f)}}}),e.querySelectorAll(".comment-bubble-overlay").forEach(a=>{const l=a.getAttribute("data-comment-id");document.querySelector(`[part*="comment-${l}"]`)||a.remove()})},createBubbleForComment(e,i){const o=this.$refs.bubbleOverlay;if(!o)return;const r=document.createElement("div");r.className="comment-bubble-overlay",r.textContent="💬",r.setAttribute("data-comment-id",e.commentId),r.style.cssText=`
                position: absolute;
                top: 0;
                left: ${i}px;
                width: 20px;
                height: 20px;
                background: rgba(168, 85, 247, 0.9);
                color: white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                border: 2px solid white;
                box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3);
                z-index: 25;
                transition: all 0.2s ease-in-out;
                cursor: pointer;
                pointer-events: all;
            `,r.addEventListener("click",a=>{a.stopPropagation(),console.log("Bubble clicked for comment:",e.commentId),this.isPlaying&&this.wavesurfer.pause(),this.$dispatch("audio-annotation:view-comment",{commentId:e.commentId})}),r.addEventListener("mouseenter",()=>{r.style.transform="scale(1.1)",r.style.boxShadow="0 4px 12px rgba(168, 85, 247, 0.5)"}),r.addEventListener("mouseleave",()=>{r.style.transform="scale(1)",r.style.boxShadow="0 2px 8px rgba(168, 85, 247, 0.3)"}),o.appendChild(r),console.log("Bubble created for comment during scroll:",e.commentId,"at position:",i)},activateCommentRegion(e){document.querySelectorAll('[part*="region comment-"]').forEach(r=>{r.classList.remove("region-active")});const i=document.querySelector(`[part*="comment-${e}"]`);i&&i.classList.add("region-active"),this.activeCommentId=e;const o=this.comments.find(r=>r.commentId===e);o&&this.$dispatch("audio-annotation:comment-activated",{comment:o})},handleRegionClicked(e){e.commentData&&(this.activeRegion=e,e.play(),this.activateCommentRegion(e.commentData.commentId),this.$dispatch("audio-annotation:comment-clicked",{comment:e.commentData}),console.log(`Playing region ${e.id} with loop: ${this.regionLoop}`))},handleKeydown(e){if(this.config.features.enableKeyboardShortcuts)switch(e.key){case" ":e.preventDefault(),this.togglePlay();break;case"ArrowLeft":e.preventDefault(),this.seekBackward();break;case"ArrowRight":e.preventDefault(),this.seekForward();break;case"c":case"C":e.shiftKey&&(e.preventDefault(),this.addComment({timestamp:this.currentTime}));break;case"=":case"+":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.zoomIn());break;case"-":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.zoomOut());break;case"0":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.zoomReset());break}},formatTime(e){const i=Math.floor(e/60),o=Math.floor(e%60),r=Math.floor(e%1*100);return`${i}:${o.toString().padStart(2,"0")}.${r.toString().padStart(2,"0")}`},formatTimeRange(e,i){return`${this.formatTime(e)} - ${this.formatTime(i)}`},loadAudio(e){!this.wavesurfer||!e||(this.isLoaded=!1,this.wavesurfer.load(e))},ensureAllRegionsHaveHandlers(){const e=this.regionsPlugin.getRegions();console.log(`Checking handlers for ${e.length} regions`),e.forEach(i=>{i.id&&i.id.startsWith("comment-")&&i.commentData&&!i._handlersSetup&&(console.log("Setting up missing handlers for region:",i.id),this.scheduleRegionSetup(i,i.commentData))})},clearAllBubbles(){const e=this.$refs.bubbleOverlay;if(e){const i=e.querySelectorAll(".comment-bubble-overlay");i.length>0&&(i.forEach(o=>o.remove()),console.log(`Cleared ${i.length} bubbles`))}},zoomIn(){if(!this.wavesurfer||!this.isLoaded)return;const e=Math.min(this.currentZoom+50,this.config.zoom.maxZoom);this.wavesurfer.zoom(e)},zoomOut(){if(!this.wavesurfer||!this.isLoaded)return;const e=Math.max(this.currentZoom-50,this.config.zoom.minZoom);this.wavesurfer.zoom(e)},zoomToLevel(e){if(!this.wavesurfer||!this.isLoaded)return;const i=Math.max(this.config.zoom.minZoom,Math.min(e,this.config.zoom.maxZoom));this.wavesurfer.zoom(i)},zoomReset(){!this.wavesurfer||!this.isLoaded||this.wavesurfer.zoom(150)},getZoomPercentage(){const e=this.config.zoom.maxZoom-this.config.zoom.minZoom,i=this.currentZoom-this.config.zoom.minZoom;return Math.round(i/e*100)},toggleMobileControls(){this.mobileControlsExpanded=!this.mobileControlsExpanded},destroy(){this.timelinePlugin&&(this.timelinePlugin.destroy(),this.timelinePlugin=null),this.wavesurfer&&(this.wavesurfer.destroy(),this.wavesurfer=null)}}}export{J as default};
