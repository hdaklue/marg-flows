function M(g,x=[],d=null,u=null,m=null){function f(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)})}function C(t,e){let i;return function(...s){i||(t.apply(this,s),i=!0,setTimeout(()=>i=!1,e))}}return{testWrapper:null,imageUrl:"",imageReady:!0,initFinished:!1,comments:[],isSelecting:!1,isDragging:!1,allCommentsHidden:!1,selectionStart:{x:0,y:0,xPx:null,yPx:null},selectionBox:{x:0,y:0,width:0,height:0},selectedCommentIds:[],showCommentFilter:!1,visibleComments:[],filterMode:!1,touchStartTime:0,longPressTimer:null,touchMoved:!1,isMobile:!1,zoomLevel:1,minZoom:1,maxZoom:9,mainContainerWidth:0,mainContainerHeight:0,innerWrapperWidth:0,innerWrapperHeight:0,panX:0,panY:0,arrowKeyStep:50,callbacks:{onDeleteComment:null,onCommentClick:null},metadata:{},imageNaturalWidth:0,imageNaturalHeight:0,viewportWidth:0,viewportHeight:0,get hasActiveFilter(){return this.allCommentsHidden?!1:this.selectedCommentIds.length<this.comments.length},get canZoomIn(){return this.zoomLevel<this.maxZoom},get canZoomOut(){return this.zoomLevel>this.minZoom},get isZoomed(){return this.zoomLevel>1},get imageDisplayWidth(){return this.innerWrapperWidth||this.imageNaturalWidth*this.zoomLevel},get imageDisplayHeight(){return this.innerWrapperHeight||this.imageNaturalHeight*this.zoomLevel},get currentZoomStep(){const t=this.mainContainerWidth||400,e=window.innerWidth;return e<640?Math.max(100,t*.15):e<768?Math.max(120,t*.18):e<1024?Math.max(150,t*.2):e<1280?Math.max(180,t*.22):Math.max(200,t*.25)},get responsiveMaxZoom(){const t=window.innerWidth;return t<640?4:t<768?5:t<1024?6:8},init(){this.isMobile=this.detectMobileDevice(),this.imageUrl=g,this.comments=x,this.selectedCommentIds=this.comments.map(t=>t.id),this.metadata=m||{},this.throttledUpdateSelection=C(this.updateSelection.bind(this),16),this.initializeWithFallback(d,u),m&&this.isValidMetadata(m)?this.initializeWithMetadata(m):this.initializeWithFallback(d,u),this.setupReactiveWatchers(),this.updateVisibleComments(),this.isMobile?this.$nextTick(()=>{this.initializeHammer()}):this.setupDesktopModeHandlers()},isValidMetadata(t){return t&&t.exists&&!t.hasError&&t.dimensions&&t.dimensions.width>0&&t.dimensions.height>0},initializeWithMetadata(t){this.imageNaturalWidth=t.dimensions.width,this.imageNaturalHeight=t.dimensions.height,this.updateViewportDimensions();const e=this.calculateContainerDimensions(this.imageNaturalWidth,this.imageNaturalHeight,this.viewportWidth,this.viewportHeight);this.mainContainerWidth=e.width,this.mainContainerHeight=e.height,this.innerWrapperWidth=e.width,this.innerWrapperHeight=e.height,this.imageReady=!0,this.initFinished=!0,this.initializeZoomState()},initializeWithFallback(t,e){if(t&&e&&(this.imageNaturalWidth=parseInt(t)||0,this.imageNaturalHeight=parseInt(e)||0,this.imageNaturalWidth>0&&this.imageNaturalHeight>0)){this.updateViewportDimensions();const i=this.calculateContainerDimensions(this.imageNaturalWidth,this.imageNaturalHeight,this.viewportWidth,this.viewportHeight);this.mainContainerWidth=i.width,this.mainContainerHeight=i.height,this.innerWrapperWidth=i.width,this.innerWrapperHeight=i.height,this.imageReady=!0,this.initFinished=!0,this.initializeZoomState();return}this.imageReady=!1,this.initFinished=!1,this.$nextTick(()=>{this.updateImageDimensions(),this.resetZoomState(),setTimeout(()=>this.initFinished=!0,100)})},setupReactiveWatchers(){this.$watch("initFinished",t=>this.imageReady=t),this.$watch("selectedCommentIds",()=>{this.filterMode&&this.updateVisibleComments()})},initializeZoomState(){this.zoomLevel=1,this.panX=0,this.panY=0},updateViewportDimensions(){this.viewportWidth=Math.round(window.innerWidth*.95),this.viewportHeight=Math.round(window.innerHeight*.9)},calculateContainerDimensions(t,e,i,s){if(t<=0||e<=0)return{width:i,height:s,widthPercent:this.toPercentage(i,i),heightPercent:this.toPercentage(s,s)};const n=t/e;if(t<=i&&e<=s)return{width:t,height:e,widthPercent:this.toPercentage(t,i),heightPercent:this.toPercentage(e,s)};const a=Math.round(i/n);if(a<=s)return{width:i,height:a,widthPercent:this.toPercentage(i,i),heightPercent:this.toPercentage(a,s)};const h=Math.round(s*n);return{width:h,height:s,widthPercent:this.toPercentage(h,i),heightPercent:this.toPercentage(s,s)}},toPercentage(t,e){return e===0?0:parseFloat((t/e*100).toFixed(9))},destroy(){this.hammerInstance&&(this.hammerInstance.destroy(),this.hammerInstance=null),this.isMobile||this.removeDesktopModeHandlers(),this.selectionTimeout&&(clearTimeout(this.selectionTimeout),this.selectionTimeout=null),this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.updateSelection&&this.updateSelection.cancel&&this.updateSelection.cancel(),this.resetZoomState(),this.comments=[],this.visibleComments=[],this.selectedCommentIds=[],this.callbacks={}},handleEscape(){if(this.showingComment){this.closeComment();return}this.handleClose()},updateVisibleComments(){this.visibleComments=this.filterMode?this.comments.filter(t=>this.selectedCommentIds.includes(t.id)):this.comments.filter(t=>{var e;return(e=t.text)==null?void 0:e.trim()})},toggleCommentFilter(){this.showCommentFilter=!this.showCommentFilter,this.filterMode=!this.filterMode},toggleAllComments(){this.allCommentsHidden?this.showAllComments():this.hideAllComments()},hideAllComments(){this.selectedCommentIds=[],this.visibleComments=[],this.allCommentsHidden=!0},showAllComments(){this.visibleComments=this.comments,this.selectedCommentIds=this.comments.map(t=>t.id),this.allCommentsHidden=!1},reset(){this.comments=[],this.selectedCommentIds=[],this.activeCommentId=null,this.isSelecting=!1,this.isDragging=!1,this.allCommentsHidden=!1,this.visibleComments=[],this.filterMode=!1,this.showCommentFilter=!1,this.resetZoomState(),this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},resetZoomState(){this.zoomLevel=1,this.mainContainerWidth=0,this.mainContainerHeight=0,this.innerWrapperWidth=0,this.innerWrapperHeight=0,this.panX=0,this.panY=0},resetPan(){this.panX=0,this.panY=0},hammerInstance:null,initialPinchScale:1,lastPinchScale:1,pinchCenter:{x:0,y:0},gestureSequence:[],currentGesture:null,lastGestureEnd:0,gestureTransitionTime:150,showSelectionMode:!1,selectionTimeout:null,initialImagePan:{x:0,y:0},panStartPoint:{x:0,y:0},isSpacePressed:!1,isShiftPressed:!1,currentMode:"select",showModeIndicator:!1,detectMobileDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0||/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<768},initializeHammer(){!this.isMobile||!window.Hammer||!this.$refs.innerWrapper||(this.hammerInstance=new Hammer.Manager(this.$refs.innerWrapper,{recognizers:[[Hammer.Pinch,{enable:!0}],[Hammer.Pan,{direction:Hammer.DIRECTION_ALL,threshold:5,pointers:1}],[Hammer.Tap,{taps:1,threshold:10,time:150}],[Hammer.Press,{time:250}]]}),this.hammerInstance.get("pinch").recognizeWith("pan"),this.hammerInstance.get("tap").requireFailure("pan"),this.hammerInstance.on("panstart",this.handleHammerPanStart.bind(this)),this.hammerInstance.on("panmove",this.handleHammerPanMove.bind(this)),this.hammerInstance.on("panend",this.handleHammerPanEnd.bind(this)),this.hammerInstance.on("tap",this.handleHammerTap.bind(this)),this.hammerInstance.on("press",this.handleHammerPress.bind(this)),this.hammerInstance.on("pinchstart",this.handleHammerPinchStart.bind(this)),this.hammerInstance.on("pinchmove",this.handleHammerPinchMove.bind(this)),this.hammerInstance.on("pinchend",this.handleHammerPinchEnd.bind(this)))},handleHammerPanStart(t){Date.now()-this.lastGestureEnd<this.gestureTransitionTime||this.currentGesture!=="selecting"&&(this.currentGesture="panning",this.gestureSequence.push("pan"),this.initialImagePan={x:this.panX,y:this.panY},this.panStartPoint={x:t.center.x,y:t.center.y},this.disableSmoothTransitions())},handleHammerPanMove(t){this.currentGesture==="selecting"?this.updateSelectionArea(t):this.currentGesture==="panning"&&this.isZoomed&&this.handleImagePanning(t)},handleHammerPanEnd(t){this.currentGesture==="selecting"?this.completeSelection():this.currentGesture==="panning"&&(this.currentGesture=null,this.lastGestureEnd=Date.now(),this.enableSmoothTransitions())},handleHammerTap(t){if(!(Date.now()-this.lastGestureEnd<this.gestureTransitionTime))if(this.shouldStartSelection(t))this.startSelectionMode(t);else{const i=this.$refs.innerWrapper.getBoundingClientRect();this.handleClick(t.center.x,t.center.y,i)}},handleHammerPress(t){this.startSelectionMode(t,!0)},handleHammerPinchStart(t){this.currentGesture="pinching",this.gestureSequence.push("pinch"),this.cancelSelection(),this.initialPinchScale=t.scale,this.lastPinchScale=this.zoomLevel,this.pinchCenter={x:t.center.x,y:t.center.y},this.disableSmoothTransitions()},handleHammerPinchMove(t){if(this.currentGesture!=="pinching")return;const e=t.scale/this.initialPinchScale,i=Math.max(this.minZoom,Math.min(this.responsiveMaxZoom,this.lastPinchScale*e));this.zoomLevel=i,this.updateImageDimensionsAndCenter()},handleHammerPinchEnd(t){this.currentGesture=null,this.lastGestureEnd=Date.now(),this.enableSmoothTransitions(),this.initialPinchScale=1,this.lastPinchScale=this.zoomLevel},shouldStartSelection(t){this.$refs.innerWrapper.getBoundingClientRect();const e=this.getImageCoordinates(t.center.x,t.center.y);if(this.findCommentAtPoint(e.x,e.y,2.5))return!1;const s=this.gestureSequence.slice(-3),n=s.includes("pinch")||s.includes("pan");return this.isZoomed&&n},startSelectionMode(t,e=!1){this.currentGesture="selecting",this.gestureSequence.push("select"),this.showSelectionMode=!0,navigator.vibrate&&navigator.vibrate(e?[10,50,10]:[10,30,10]);const i=this.$refs.innerWrapper.getBoundingClientRect(),s=this.getImageCoordinates(t.center.x,t.center.y),n=parseFloat(s.x.toFixed(9)),a=parseFloat(s.y.toFixed(9));this.selectionStart={x:n,y:a,xPx:t.center.x-i.left,yPx:t.center.y-i.top},this.selectionBox={x:n,y:a,width:parseFloat(0 .toFixed(9)),height:parseFloat(0 .toFixed(9))},this.isSelecting=!0,this.isDragging=!0,this.selectionTimeout=setTimeout(()=>{this.currentGesture==="selecting"&&this.completeSelection()},5e3)},handleImagePanning(t){if(!this.isZoomed)return;const e=t.center.x-this.panStartPoint.x,i=t.center.y-this.panStartPoint.y;this.updatePanPosition(this.initialImagePan.x+e,this.initialImagePan.y+i)},updateSelectionArea(t){this.$refs.innerWrapper.getBoundingClientRect();const e=this.getImageCoordinates(t.center.x,t.center.y),i=parseFloat(e.x.toFixed(9)),s=parseFloat(e.y.toFixed(9)),n=this.selectionStart.x,a=this.selectionStart.y;this.selectionBox={x:parseFloat(Math.min(n,i).toFixed(9)),y:parseFloat(Math.min(a,s).toFixed(9)),width:parseFloat(Math.abs(i-n).toFixed(9)),height:parseFloat(Math.abs(s-a).toFixed(9))}},updatePanPosition(t,e){const i=Math.max(0,(this.innerWrapperWidth-this.mainContainerWidth)/2),s=Math.max(0,(this.innerWrapperHeight-this.mainContainerHeight)/2);this.panX=Math.max(-i,Math.min(i,t)),this.panY=Math.max(-s,Math.min(s,e))},handleDesktopPanning(t){if(!this.isZoomed)return;const e=t.clientX-this.panStartPoint.x,i=t.clientY-this.panStartPoint.y;this.updatePanPosition(this.initialImagePan.x+e,this.initialImagePan.y+i)},cancelSelection(){this.isSelecting=!1,this.isDragging=!1,this.showSelectionMode=!1,this.currentGesture=null,this.resetSelectionState(),this.selectionTimeout&&(clearTimeout(this.selectionTimeout),this.selectionTimeout=null)},completeSelection(){this.selectionBox.width>1&&this.selectionBox.height>1&&this.createAreaComment(),this.cancelSelection()},setupDesktopModeHandlers(){this.handleKeyDown=this.handleDesktopKeyDown.bind(this),this.handleKeyUp=this.handleDesktopKeyUp.bind(this),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp)},removeDesktopModeHandlers(){this.handleKeyDown&&(window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp))},handleDesktopKeyDown(t){t.code==="Space"&&!this.isSpacePressed&&(t.preventDefault(),this.isSpacePressed=!0,this.currentMode="pan",this.showModeIndicator=!0,setTimeout(()=>{this.isDragging||(this.showModeIndicator=!1)},2e3)),(t.code==="ShiftLeft"||t.code==="ShiftRight")&&(this.isShiftPressed=!0,this.currentMode="select",this.showModeIndicator=!0,setTimeout(()=>{this.isDragging||(this.showModeIndicator=!1)},2e3))},handleDesktopKeyUp(t){t.code==="Space"&&(this.isSpacePressed=!1,this.isDragging||(this.currentMode="select",this.showModeIndicator=!1)),(t.code==="ShiftLeft"||t.code==="ShiftRight")&&(this.isShiftPressed=!1,this.isDragging||(this.currentMode="select",this.showModeIndicator=!1))},getDesktopMode(){return this.isZoomed?this.isSpacePressed?"pan":this.isShiftPressed?"select":this.currentMode:"select"},handleClose(){if(this.showCommentFilter){this.showCommentFilter=!1,this.filterMode=!1;return}},handleBackdropClick(t){t.target===t.currentTarget&&this.handleClose()},startSelection(t){if(t.button!==0)return;this.disableSmoothTransitions();const e=this.$refs.innerWrapper.getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top;if(!this.isMobile&&this.getDesktopMode()==="pan"&&this.isZoomed){this.currentGesture="panning",this.initialImagePan={x:this.panX,y:this.panY},this.panStartPoint={x:t.clientX,y:t.clientY},this.isDragging=!0;return}const n=this.getImageCoordinates(t.clientX,t.clientY);this.selectionStart={x:parseFloat(n.x.toFixed(9)),y:parseFloat(n.y.toFixed(9)),xPx:i,yPx:s},this.isDragging=!0,this.isSelecting=!1},updateSelection(t){if(!this.isDragging)return;if(!this.isMobile&&this.currentGesture==="panning"){this.handleDesktopPanning(t);return}if(!this.selectionStart.xPx)return;const e=this.$refs.innerWrapper.getBoundingClientRect(),i=Math.max(0,Math.min(t.clientX-e.left,e.width)),s=Math.max(0,Math.min(t.clientY-e.top,e.height));if(Math.sqrt(Math.pow(i-this.selectionStart.xPx,2)+Math.pow(s-this.selectionStart.yPx,2))>(this.isMobile?8:5)&&(this.isSelecting=!0),!this.isSelecting)return;const a=this.getImageCoordinates(t.clientX,t.clientY),h=parseFloat(a.x.toFixed(9)),o=parseFloat(a.y.toFixed(9)),r=this.selectionStart.x,l=this.selectionStart.y;this.selectionBox={x:parseFloat(Math.min(r,h).toFixed(9)),y:parseFloat(Math.min(l,o).toFixed(9)),width:parseFloat(Math.abs(h-r).toFixed(9)),height:parseFloat(Math.abs(o-l).toFixed(9))}},endSelection(t){if(!this.isDragging)return;const e=this.$refs.innerWrapper.getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top;if(!this.isMobile&&this.currentGesture==="panning"){this.currentGesture=null,this.isDragging=!1,this.enableSmoothTransitions(),this.showModeIndicator=!1;return}this.isDragging=!1,this.enableSmoothTransitions(),this.isSelecting&&this.selectionBox.width>1&&this.selectionBox.height>1?this.createAreaComment():i>=0&&i<=e.width&&s>=0&&s<=e.height&&this.handleClick(t.clientX,t.clientY,e),this.resetSelectionState(),this.showModeIndicator=!1},handleTouchStart(t){if(this.isMobile&&this.hammerInstance)return;this.disableSmoothTransitions();const e=t.touches[0],i=this.$refs.innerWrapper.getBoundingClientRect(),s=e.clientX-i.left,n=e.clientY-i.top;this.touchStartTime=Date.now(),this.touchMoved=!1;const a=this.getImageCoordinates(e.clientX,e.clientY);this.selectionStart={x:parseFloat(a.x.toFixed(9)),y:parseFloat(a.y.toFixed(9)),xPx:s,yPx:n},this.isDragging=!0,this.isSelecting=!1,this.longPressTimer=setTimeout(()=>{!this.touchMoved&&this.isDragging&&(navigator.vibrate&&navigator.vibrate([10,50,10]),this.isSelecting=!0)},300)},handleTouchMove(t){if(this.isMobile&&this.hammerInstance||!this.isDragging)return;const e=t.touches[0],i=this.$refs.innerWrapper.getBoundingClientRect(),s=Math.max(0,Math.min(e.clientX-i.left,i.width)),n=Math.max(0,Math.min(e.clientY-i.top,i.height));if(Math.sqrt(Math.pow(s-this.selectionStart.xPx,2)+Math.pow(n-this.selectionStart.yPx,2))>12&&(this.touchMoved=!0,this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.isSelecting=!0),!this.isSelecting)return;const h=this.getImageCoordinates(e.clientX,e.clientY),o=parseFloat(h.x.toFixed(9)),r=parseFloat(h.y.toFixed(9)),l=this.selectionStart.x,c=this.selectionStart.y;this.selectionBox={x:parseFloat(Math.min(l,o).toFixed(9)),y:parseFloat(Math.min(c,r).toFixed(9)),width:parseFloat(Math.abs(o-l).toFixed(9)),height:parseFloat(Math.abs(r-c).toFixed(9))}},handleTouchEnd(t){if(this.isMobile&&this.hammerInstance||!this.isDragging)return;this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.enableSmoothTransitions();const e=this.$refs.innerWrapper.getBoundingClientRect(),i=Date.now()-this.touchStartTime;if(this.isSelecting&&this.selectionBox.width>1&&this.selectionBox.height>1)this.createAreaComment();else if(!this.touchMoved&&i<300){const s=t.changedTouches[0];this.handleClick(s.clientX,s.clientY,e)}this.isDragging=!1,this.resetSelectionState()},handleClick(t,e,i){if(!this.isZoomed){const l=this.getImageCoordinates(t,e),c=this.isMobile?2.5:1.5,p=this.findCommentAtPoint(l.x,l.y,c);if(p)return this.selectComment(p)}const s=this.getImageCoordinates(t,e),n=parseFloat((this.isMobile?3:2).toFixed(9)),a=parseFloat((n/2).toFixed(9)),h=parseFloat((100-n).toFixed(9)),o=parseFloat((100-n).toFixed(9)),r={x:parseFloat(Math.max(0,Math.min(h,s.x-a)).toFixed(9)),y:parseFloat(Math.max(0,Math.min(o,s.y-a)).toFixed(9)),width:n,height:n,type:"point",imageUrl:this.imageUrl,isMobile:this.isMobile,zoomLevel:this.zoomLevel};this.dispatchCommentEvent(r)},createAreaComment(){const t=parseFloat(Math.max(0,Math.min(100,this.selectionBox.x)).toFixed(9)),e=parseFloat(Math.max(0,Math.min(100,this.selectionBox.y)).toFixed(9)),i=parseFloat((100-t).toFixed(9)),s=parseFloat((100-e).toFixed(9)),n=parseFloat(Math.max(0,Math.min(this.selectionBox.width,i)).toFixed(9)),a=parseFloat(Math.max(0,Math.min(this.selectionBox.height,s)).toFixed(9)),h={x:t,y:e,width:n,height:a,type:"area",imageUrl:this.imageUrl,isMobile:this.isMobile,zoomLevel:this.zoomLevel};this.dispatchCommentEvent(h)},dispatchCommentEvent(t){window.dispatchEvent(new CustomEvent("open-comment-modal",{detail:t,bubbles:!0}))},resetSelectionState(){this.selectionStart={x:parseFloat(0 .toFixed(9)),y:parseFloat(0 .toFixed(9)),xPx:null,yPx:null},this.selectionBox={x:parseFloat(0 .toFixed(9)),y:parseFloat(0 .toFixed(9)),width:parseFloat(0 .toFixed(9)),height:parseFloat(0 .toFixed(9))},this.isSelecting=!1},findCommentAtPoint(t,e,i=0){return this.visibleComments.find(s=>{const n=s.x-i,a=s.x+s.width+i,h=s.y-i,o=s.y+s.height+i;return t>=n&&t<=a&&e>=h&&e<=o})},selectComment(t){console.log("Comment selected:",t),this.callbacks.onCommentClick&&this.callbacks.onCommentClick(t)},setCallbacks(t={}){const e=["onDeleteComment","onCommentClick"];Object.keys(t).forEach(i=>{e.includes(i)&&typeof t[i]=="function"&&(this.callbacks[i]=t[i])})},getComments(){return this.comments},addComment(t){const e={id:t.id||f(),...t};this.comments.find(i=>i.id===e.id)||(this.comments.push(e),this.selectedCommentIds.includes(e.id)||this.selectedCommentIds.push(e.id),this.updateVisibleComments())},async removeComment(t){try{const e=[...this.comments],i=[...this.selectedCommentIds];this.comments=this.comments.filter(s=>s.id!==t),this.selectedCommentIds=this.selectedCommentIds.filter(s=>s!==t),this.updateVisibleComments(),this.callbacks.onDeleteComment&&await this.callbacks.onDeleteComment(t)}catch(e){console.error("Error deleting comment:",e),this.comments=originalComments,this.selectedCommentIds=originalSelectedIds,this.updateVisibleComments(),alert("Failed to delete comment. Please try again.")}},zoomIn(t=1.2){this.enableSmoothTransitions();const e=Math.min(this.zoomLevel*t,this.maxZoom);this.setZoom(e)},zoomOut(t=1.2){this.enableSmoothTransitions();const e=Math.max(this.zoomLevel/t,this.minZoom);this.setZoom(e)},resetZoom(){this.setZoom(1),this.resetPan()},setZoom(t){this.zoomLevel=t,this.updateImageDimensionsAndCenter()},centerImage(){if(this.innerWrapperWidth<=this.mainContainerWidth)this.panX=0;else{const t=Math.max(0,(this.innerWrapperWidth-this.mainContainerWidth)/2);this.panX=Math.max(-t,Math.min(t,this.panX))}if(this.innerWrapperHeight<=this.mainContainerHeight)this.panY=0;else{const t=Math.max(0,(this.innerWrapperHeight-this.mainContainerHeight)/2);this.panY=Math.max(-t,Math.min(t,this.panY))}},enableSmoothTransitions(){this.$refs.innerWrapper&&(this.$refs.innerWrapper.style.transition="transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)")},disableSmoothTransitions(){this.$refs.innerWrapper&&(this.$refs.innerWrapper.style.transition="none")},updateImageDimensionsAndCenter(){if(this.mainContainerWidth===0||this.mainContainerHeight===0){this.updateImageDimensions();return}this.updateInnerWrapperDimensions(),this.constrainPanPosition()},constrainPanPosition(){const t=Math.max(0,(this.innerWrapperWidth-this.mainContainerWidth)/2),e=Math.max(0,(this.innerWrapperHeight-this.mainContainerHeight)/2);this.innerWrapperWidth<=this.mainContainerWidth?this.panX=0:this.panX=Math.max(-t,Math.min(t,this.panX)),this.innerWrapperHeight<=this.mainContainerHeight?this.panY=0:this.panY=Math.max(-e,Math.min(e,this.panY))},updateImageDimensions(){this.$nextTick(()=>{const t=this.$refs.scrollContainer,e=this.$refs.mainContainer,i=this.$refs.innerWrapper,s=this.$refs.image;if(!(!t||!e||!i)){if(this.mainContainerWidth===0){this.calculateContainerDimensionsFromViewport(t,s);return}this.updateInnerWrapperDimensions()}})},calculateContainerDimensionsFromViewport(t,e){const i=t.clientWidth,s=t.clientHeight;let n=0,a=0;this.imageNaturalWidth>0&&this.imageNaturalHeight>0?(n=this.imageNaturalWidth,a=this.imageNaturalHeight):e&&e.naturalWidth>0&&e.naturalHeight>0?(n=e.naturalWidth,a=e.naturalHeight,this.imageNaturalWidth=n,this.imageNaturalHeight=a):(i/s>4/3?(n=Math.round(s*4/3),a=s):(n=i,a=Math.round(i*3/4)),this.imageNaturalWidth=n,this.imageNaturalHeight=a),this.updateViewportDimensions();const h=this.calculateContainerDimensions(n,a,i,s);this.mainContainerWidth=h.width,this.mainContainerHeight=h.height,this.innerWrapperWidth=h.width,this.innerWrapperHeight=h.height},updateInnerWrapperDimensions(){if(this.mainContainerWidth===0||this.mainContainerHeight===0)return;const e=1+(this.zoomLevel-1)*this.currentZoomStep/Math.max(this.mainContainerWidth,this.mainContainerHeight);this.innerWrapperWidth=Math.round(this.mainContainerWidth*e),this.innerWrapperHeight=Math.round(this.mainContainerHeight*e)},get currentMainContainerWidth(){return this.mainContainerWidth||"auto"},get currentMainContainerHeight(){return this.mainContainerHeight||"auto"},get currentInnerWrapperWidth(){return this.innerWrapperWidth||this.mainContainerWidth||0},get currentInnerWrapperHeight(){return this.innerWrapperHeight||this.mainContainerHeight||0},handleWheel(t){t.preventDefault();const e=t.deltaY,i=1.1;e<0&&this.canZoomIn?this.zoomIn(i):e>0&&this.canZoomOut&&this.zoomOut(i)},handleArrowKeys(t){if(!this.isZoomed)return;t.preventDefault();const e=this.arrowKeyStep,i=Math.max(0,(this.innerWrapperWidth-this.mainContainerWidth)/2),s=Math.max(0,(this.innerWrapperHeight-this.mainContainerHeight)/2);switch(t.key){case"ArrowUp":this.panY=Math.min(s,this.panY+e);break;case"ArrowDown":this.panY=Math.max(-s,this.panY-e);break;case"ArrowLeft":this.panX=Math.min(i,this.panX+e);break;case"ArrowRight":this.panX=Math.max(-i,this.panX-e);break}},getImageCoordinates(t,e){const i=this.$refs.innerWrapper,s=this.$refs.image;if(!i||!s)return{x:parseFloat(0 .toFixed(9)),y:parseFloat(0 .toFixed(9))};i.getBoundingClientRect();const n=s.getBoundingClientRect();if(n.width<=0||n.height<=0)return{x:parseFloat(0 .toFixed(9)),y:parseFloat(0 .toFixed(9))};const a=t-n.left,h=e-n.top,o=a/n.width*100,r=h/n.height*100;return{x:parseFloat(Math.max(0,Math.min(100,o)).toFixed(9)),y:parseFloat(Math.max(0,Math.min(100,r)).toFixed(9))}},onImageLoad(){const t=this.$refs.image;t&&t.naturalWidth>0&&t.naturalHeight>0&&(!this.imageNaturalWidth||!this.imageNaturalHeight)&&(this.imageNaturalWidth=t.naturalWidth,this.imageNaturalHeight=t.naturalHeight,this.mainContainerWidth===0&&this.$nextTick(()=>{this.updateImageDimensions()})),(!this.imageReady||!this.initFinished)&&(this.imageReady=!0,this.initFinished=!0)}}}export{M as default};
