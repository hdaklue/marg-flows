Array.prototype.find||(Array.prototype.find=function(b){if(this===null)throw new TypeError("Array.prototype.find called on null or undefined");if(typeof b!="function")throw new TypeError("predicate must be a function");for(var e=Object(this),i=e.length>>>0,t=arguments[1],n,r=0;r<i;r++)if(n=e[r],b.call(t,n,r,e))return n});if(window&&typeof window.CustomEvent!="function"){let b=function(e,i){i=i||{bubbles:!1,cancelable:!1,detail:void 0};var t=document.createEvent("CustomEvent");return t.initCustomEvent(e,i.bubbles,i.cancelable,i.detail),t};typeof window.Event<"u"&&(b.prototype=window.Event.prototype),window.CustomEvent=b}class M{constructor(e){this.tribute=e,this.tribute.events=this}static keys(){return[{key:9,value:"TAB"},{key:8,value:"DELETE"},{key:13,value:"ENTER"},{key:27,value:"ESCAPE"},{key:32,value:"SPACE"},{key:38,value:"UP"},{key:40,value:"DOWN"}]}bind(e){e.boundKeydown=this.keydown.bind(e,this),e.boundKeyup=this.keyup.bind(e,this),e.boundInput=this.input.bind(e,this),e.addEventListener("keydown",e.boundKeydown,!1),e.addEventListener("keyup",e.boundKeyup,!1),e.addEventListener("input",e.boundInput,!1)}unbind(e){e.removeEventListener("keydown",e.boundKeydown,!1),e.removeEventListener("keyup",e.boundKeyup,!1),e.removeEventListener("input",e.boundInput,!1),delete e.boundKeydown,delete e.boundKeyup,delete e.boundInput}keydown(e,i){e.shouldDeactivate(i)&&(e.tribute.isActive=!1,e.tribute.hideMenu());let t=this;e.commandEvent=!1,M.keys().forEach(n=>{n.key===i.keyCode&&(e.commandEvent=!0,e.callbacks()[n.value.toLowerCase()](i,t))})}input(e,i){e.inputEvent=!0,e.keyup.call(this,e,i)}click(e,i){let t=e.tribute;if(t.menu&&t.menu.contains(i.target)){let n=i.target;for(i.preventDefault(),i.stopPropagation();n.nodeName.toLowerCase()!=="li";)if(n=n.parentNode,!n||n===t.menu)throw new Error("cannot find the <li> container for the click");t.selectItemAtIndex(n.getAttribute("data-index"),i),t.hideMenu()}else t.current.element&&!t.current.externalTrigger&&(t.current.externalTrigger=!1,setTimeout(()=>t.hideMenu()))}keyup(e,i){if(e.inputEvent&&(e.inputEvent=!1),e.updateSelection(this),i.keyCode!==27){if(!e.tribute.allowSpaces&&e.tribute.hasTrailingSpace){e.tribute.hasTrailingSpace=!1,e.commandEvent=!0,e.callbacks().space(i,this);return}if(!e.tribute.isActive)if(e.tribute.autocompleteMode)e.callbacks().triggerChar(i,this,"");else{let t=e.getKeyCode(e,this,i);if(isNaN(t)||!t)return;let n=e.tribute.triggers().find(r=>r.charCodeAt(0)===t);typeof n<"u"&&e.callbacks().triggerChar(i,this,n)}e.tribute.current.mentionText.length<e.tribute.current.collection.menuShowMinLength||((e.tribute.current.trigger||e.tribute.autocompleteMode)&&e.commandEvent===!1||e.tribute.isActive&&i.keyCode===8)&&e.tribute.showMenuFor(this,!0)}}shouldDeactivate(e){if(!this.tribute.isActive)return!1;if(this.tribute.current.mentionText.length===0){let i=!1;return M.keys().forEach(t=>{e.keyCode===t.key&&(i=!0)}),!i}return!1}getKeyCode(e,i,t){let n=e.tribute,r=n.range.getTriggerInfo(!1,n.hasTrailingSpace,!0,n.allowSpaces,n.autocompleteMode);return r?r.mentionTriggerChar.charCodeAt(0):!1}updateSelection(e){this.tribute.current.element=e;let i=this.tribute.range.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);i&&(this.tribute.current.selectedPath=i.mentionSelectedPath,this.tribute.current.mentionText=i.mentionText,this.tribute.current.selectedOffset=i.mentionSelectedOffset)}callbacks(){return{triggerChar:(e,i,t)=>{let n=this.tribute;n.current.trigger=t;let r=n.collection.find(s=>s.trigger===t);n.current.collection=r,n.current.mentionText.length>=n.current.collection.menuShowMinLength&&n.inputEvent&&n.showMenuFor(i,!0)},enter:(e,i)=>{this.tribute.isActive&&this.tribute.current.filteredItems&&(e.preventDefault(),e.stopPropagation(),setTimeout(()=>{this.tribute.selectItemAtIndex(this.tribute.menuSelected,e),this.tribute.hideMenu()},0))},escape:(e,i)=>{this.tribute.isActive&&(e.preventDefault(),e.stopPropagation(),this.tribute.isActive=!1,this.tribute.hideMenu())},tab:(e,i)=>{this.callbacks().enter(e,i)},space:(e,i)=>{this.tribute.isActive&&(this.tribute.spaceSelectsMatch?this.callbacks().enter(e,i):this.tribute.allowSpaces||(e.stopPropagation(),setTimeout(()=>{this.tribute.hideMenu(),this.tribute.isActive=!1},0)))},up:(e,i)=>{if(this.tribute.isActive&&this.tribute.current.filteredItems){e.preventDefault(),e.stopPropagation();let t=this.tribute.current.filteredItems.length,n=this.tribute.menuSelected;t>n&&n>0?(this.tribute.menuSelected--,this.setActiveLi()):n===0&&(this.tribute.menuSelected=t-1,this.setActiveLi(),this.tribute.menu.scrollTop=this.tribute.menu.scrollHeight)}},down:(e,i)=>{if(this.tribute.isActive&&this.tribute.current.filteredItems){e.preventDefault(),e.stopPropagation();let t=this.tribute.current.filteredItems.length-1,n=this.tribute.menuSelected;t>n?(this.tribute.menuSelected++,this.setActiveLi()):t===n&&(this.tribute.menuSelected=0,this.setActiveLi(),this.tribute.menu.scrollTop=0)}},delete:(e,i)=>{this.tribute.isActive&&this.tribute.current.mentionText.length<1?this.tribute.hideMenu():this.tribute.isActive&&this.tribute.showMenuFor(i)}}}setActiveLi(e){let i=this.tribute.menu.querySelectorAll("li"),t=i.length>>>0;e&&(this.tribute.menuSelected=parseInt(e));for(let n=0;n<t;n++){let r=i[n];if(n===this.tribute.menuSelected){r.classList.add(this.tribute.current.collection.selectClass);let s=r.getBoundingClientRect(),o=this.tribute.menu.getBoundingClientRect();if(s.bottom>o.bottom){let l=s.bottom-o.bottom;this.tribute.menu.scrollTop+=l}else if(s.top<o.top){let l=o.top-s.top;this.tribute.menu.scrollTop-=l}}else r.classList.remove(this.tribute.current.collection.selectClass)}}getFullHeight(e,i){let t=e.getBoundingClientRect().height;if(i){let n=e.currentStyle||window.getComputedStyle(e);return t+parseFloat(n.marginTop)+parseFloat(n.marginBottom)}return t}}class A{constructor(e){this.tribute=e,this.tribute.menuEvents=this,this.menu=this.tribute.menu}bind(e){this.menuClickEvent=this.tribute.events.click.bind(null,this),this.menuContainerScrollEvent=this.debounce(()=>{this.tribute.isActive&&this.tribute.showMenuFor(this.tribute.current.element,!1)},300,!1),this.windowResizeEvent=this.debounce(()=>{this.tribute.isActive&&this.tribute.range.positionMenuAtCaret(!0)},300,!1),this.tribute.range.getDocument().addEventListener("MSPointerDown",this.menuClickEvent,!1),this.tribute.range.getDocument().addEventListener("mousedown",this.menuClickEvent,!1),window.addEventListener("resize",this.windowResizeEvent),this.menuContainer?this.menuContainer.addEventListener("scroll",this.menuContainerScrollEvent,!1):window.addEventListener("scroll",this.menuContainerScrollEvent)}unbind(e){this.tribute.range.getDocument().removeEventListener("mousedown",this.menuClickEvent,!1),this.tribute.range.getDocument().removeEventListener("MSPointerDown",this.menuClickEvent,!1),window.removeEventListener("resize",this.windowResizeEvent),this.menuContainer?this.menuContainer.removeEventListener("scroll",this.menuContainerScrollEvent,!1):window.removeEventListener("scroll",this.menuContainerScrollEvent)}debounce(e,i,t){var n;return()=>{var r=this,s=arguments,o=()=>{n=null,t||e.apply(r,s)},l=t&&!n;clearTimeout(n),n=setTimeout(o,i),l&&e.apply(r,s)}}}class L{constructor(e){this.tribute=e,this.tribute.range=this}getDocument(){let e;return this.tribute.current.collection&&(e=this.tribute.current.collection.iframe),e?e.contentWindow.document:document}positionMenuAtCaret(e){let i=this.tribute.current,t,n=this.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);if(typeof n<"u"){if(!this.tribute.positionMenu){this.tribute.menu.style.cssText="display: block;";return}this.isContentEditable(i.element)?t=this.getContentEditableCaretPosition(n.mentionPosition):t=this.getTextAreaOrInputUnderlinePosition(this.tribute.current.element,n.mentionPosition),this.tribute.menu.style.cssText=`top: ${t.top}px;
                                     left: ${t.left}px;
                                     right: ${t.right}px;
                                     bottom: ${t.bottom}px;
                                     position: absolute;
                                     display: block;`,t.left==="auto"&&(this.tribute.menu.style.left="auto"),t.top==="auto"&&(this.tribute.menu.style.top="auto"),e&&this.scrollIntoView(),window.setTimeout(()=>{let r={width:this.tribute.menu.offsetWidth,height:this.tribute.menu.offsetHeight},s=this.isMenuOffScreen(t,r),o=window.innerWidth>r.width&&(s.left||s.right),l=window.innerHeight>r.height&&(s.top||s.bottom);(o||l)&&(this.tribute.menu.style.cssText="display: none",this.positionMenuAtCaret(e))},0)}else this.tribute.menu.style.cssText="display: none"}get menuContainerIsBody(){return this.tribute.menuContainer===document.body||!this.tribute.menuContainer}selectElement(e,i,t){let n,r=e;if(i)for(var s=0;s<i.length;s++){if(r=r.childNodes[i[s]],r===void 0)return;for(;r.length<t;)t-=r.length,r=r.nextSibling;r.childNodes.length===0&&!r.length&&(r=r.previousSibling)}let o=this.getWindowSelection();n=this.getDocument().createRange(),n.setStart(r,t),n.setEnd(r,t),n.collapse(!0);try{o.removeAllRanges()}catch{}o.addRange(n),e.focus()}replaceTriggerText(e,i,t,n,r){let s=this.getTriggerInfo(!0,t,i,this.tribute.allowSpaces,this.tribute.autocompleteMode);if(s!==void 0){let o=this.tribute.current,l=new CustomEvent("tribute-replaced",{detail:{item:r,instance:o,context:s,event:n}});if(this.isContentEditable(o.element)){let u=typeof this.tribute.replaceTextSuffix=="string"?this.tribute.replaceTextSuffix:"Â ";e+=u;let a=s.mentionPosition+s.mentionText.length;this.tribute.autocompleteMode||(a+=s.mentionTriggerChar.length),this.pasteHtml(e,s.mentionPosition,a)}else{let u=this.tribute.current.element,a=typeof this.tribute.replaceTextSuffix=="string"?this.tribute.replaceTextSuffix:" ";e+=a;let d=s.mentionPosition,c=s.mentionPosition+s.mentionText.length+a.length;this.tribute.autocompleteMode||(c+=s.mentionTriggerChar.length-1),u.value=u.value.substring(0,d)+e+u.value.substring(c,u.value.length),u.selectionStart=d+e.length,u.selectionEnd=d+e.length}o.element.dispatchEvent(new CustomEvent("input",{bubbles:!0})),o.element.dispatchEvent(l)}}pasteHtml(e,i,t){let n,r;r=this.getWindowSelection(),n=this.getDocument().createRange(),n.setStart(r.anchorNode,i),n.setEnd(r.anchorNode,t),n.deleteContents();let s=this.getDocument().createElement("div");s.innerHTML=e;let o=this.getDocument().createDocumentFragment(),l,u;for(;l=s.firstChild;)u=o.appendChild(l);n.insertNode(o),u&&(n=n.cloneRange(),n.setStartAfter(u),n.collapse(!0),r.removeAllRanges(),r.addRange(n))}getWindowSelection(){return this.tribute.collection.iframe?this.tribute.collection.iframe.contentWindow.getSelection():window.getSelection()}getNodePositionInParent(e){if(e.parentNode===null)return 0;for(var i=0;i<e.parentNode.childNodes.length;i++)if(e.parentNode.childNodes[i]===e)return i}getContentEditableSelectedPath(e){let i=this.getWindowSelection(),t=i.anchorNode,n=[],r;if(t!=null){let s,o=t.contentEditable;for(;t!==null&&o!=="true";)s=this.getNodePositionInParent(t),n.push(s),t=t.parentNode,t!==null&&(o=t.contentEditable);return n.reverse(),r=i.getRangeAt(0).startOffset,{selected:t,path:n,offset:r}}}getTextPrecedingCurrentSelection(){let e=this.tribute.current,i="";if(this.isContentEditable(e.element)){let t=this.getWindowSelection().anchorNode;if(t!=null){let n=t.textContent,r=this.getWindowSelection().getRangeAt(0).startOffset;n&&r>=0&&(i=n.substring(0,r))}}else{let t=this.tribute.current.element;if(t){let n=t.selectionStart;t.value&&n>=0&&(i=t.value.substring(0,n))}}return i}getLastWordInText(e){e=e.replace(/\u00A0/g," ");let i=e.split(/\s+/),t=i.length-1;return i[t].trim()}getTriggerInfo(e,i,t,n,r){let s=this.tribute.current,o,l,u;if(!this.isContentEditable(s.element))o=this.tribute.current.element;else{let c=this.getContentEditableSelectedPath(s);c&&(o=c.selected,l=c.path,u=c.offset)}let a=this.getTextPrecedingCurrentSelection(),d=this.getLastWordInText(a);if(r)return{mentionPosition:a.length-d.length,mentionText:d,mentionSelectedElement:o,mentionSelectedPath:l,mentionSelectedOffset:u};if(a!=null){let c=-1,p;if(this.tribute.collection.forEach(h=>{let m=h.trigger,f=h.requireLeadingSpace?this.lastIndexWithLeadingSpace(a,m):a.lastIndexOf(m);f>c&&(c=f,p=m,t=h.requireLeadingSpace)}),c>=0&&(c===0||!t||/[\xA0\s]/g.test(a.substring(c-1,c)))){let h=a.substring(c+p.length,a.length);p=a.substring(c,c+p.length);let m=h.substring(0,1),f=h.length>0&&(m===" "||m==="Â ");i&&(h=h.trim());let v=n?/[^\S ]/g:/[\xA0\s]/g;if(this.tribute.hasTrailingSpace=v.test(h),!f&&(e||!v.test(h)))return{mentionPosition:c,mentionText:h,mentionSelectedElement:o,mentionSelectedPath:l,mentionSelectedOffset:u,mentionTriggerChar:p}}}}lastIndexWithLeadingSpace(e,i){let t=e.split("").reverse().join(""),n=-1;for(let r=0,s=e.length;r<s;r++){let o=r===e.length-1,l=/\s/.test(t[r+1]),u=!0;for(let a=i.length-1;a>=0;a--)if(i[a]!==t[r-a]){u=!1;break}if(u&&(o||l)){n=e.length-1-r;break}}return n}isContentEditable(e){return e.nodeName!=="INPUT"&&e.nodeName!=="TEXTAREA"}isMenuOffScreen(e,i){let t=window.innerWidth,n=window.innerHeight,r=document.documentElement,s=(window.pageXOffset||r.scrollLeft)-(r.clientLeft||0),o=(window.pageYOffset||r.scrollTop)-(r.clientTop||0),l=typeof e.top=="number"?e.top:o+n-e.bottom-i.height,u=typeof e.right=="number"?e.right:e.left+i.width,a=typeof e.bottom=="number"?e.bottom:e.top+i.height,d=typeof e.left=="number"?e.left:s+t-e.right-i.width;return{top:l<Math.floor(o),right:u>Math.ceil(s+t),bottom:a>Math.ceil(o+n),left:d<Math.floor(s)}}getMenuDimensions(){let e={width:null,height:null};return this.tribute.menu.style.cssText=`top: 0px;
                                 left: 0px;
                                 position: fixed;
                                 display: block;
                                 visibility; hidden;`,e.width=this.tribute.menu.offsetWidth,e.height=this.tribute.menu.offsetHeight,this.tribute.menu.style.cssText="display: none;",e}getTextAreaOrInputUnderlinePosition(e,i,t){let n=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"],r=window.mozInnerScreenX!==null,s=this.getDocument().createElement("div");s.id="input-textarea-caret-position-mirror-div",this.getDocument().body.appendChild(s);let o=s.style,l=window.getComputedStyle?getComputedStyle(e):e.currentStyle;o.whiteSpace="pre-wrap",e.nodeName!=="INPUT"&&(o.wordWrap="break-word"),o.position="absolute",o.visibility="hidden",n.forEach(x=>{o[x]=l[x]}),r?(o.width=`${parseInt(l.width)-2}px`,e.scrollHeight>parseInt(l.height)&&(o.overflowY="scroll")):o.overflow="hidden",s.textContent=e.value.substring(0,i),e.nodeName==="INPUT"&&(s.textContent=s.textContent.replace(/\s/g,"Â "));let u=this.getDocument().createElement("span");u.textContent=e.value.substring(i)||".",s.appendChild(u);let a=e.getBoundingClientRect(),d=document.documentElement,c=(window.pageXOffset||d.scrollLeft)-(d.clientLeft||0),p=(window.pageYOffset||d.scrollTop)-(d.clientTop||0),h=0,m=0;this.menuContainerIsBody&&(h=a.top,m=a.left);let f={top:h+p+u.offsetTop+parseInt(l.borderTopWidth)+parseInt(l.fontSize)-e.scrollTop,left:m+c+u.offsetLeft+parseInt(l.borderLeftWidth)},v=window.innerWidth,y=window.innerHeight,w=this.getMenuDimensions(),T=this.isMenuOffScreen(f,w);T.right&&(f.right=v-f.left,f.left="auto");let E=this.tribute.menuContainer?this.tribute.menuContainer.offsetHeight:this.getDocument().body.offsetHeight;if(T.bottom){let x=this.tribute.menuContainer?this.tribute.menuContainer.getBoundingClientRect():this.getDocument().body.getBoundingClientRect(),g=E-(y-x.top);f.bottom=g+(y-a.top-u.offsetTop),f.top="auto"}return T=this.isMenuOffScreen(f,w),T.left&&(f.left=v>w.width?c+v-w.width:c,delete f.right),T.top&&(f.top=y>w.height?p+y-w.height:p,delete f.bottom),this.getDocument().body.removeChild(s),f}getContentEditableCaretPosition(e){let i,t=this.getWindowSelection();i=this.getDocument().createRange(),i.setStart(t.anchorNode,e),i.setEnd(t.anchorNode,e),i.collapse(!1);let n=i.getBoundingClientRect(),r=document.documentElement,s=(window.pageXOffset||r.scrollLeft)-(r.clientLeft||0),o=(window.pageYOffset||r.scrollTop)-(r.clientTop||0),l=n.left,u=n.top,a={left:l+s,top:u+n.height+o},d=window.innerWidth,c=window.innerHeight,p=this.getMenuDimensions(),h=this.isMenuOffScreen(a,p);h.right&&(a.left="auto",a.right=d-n.left-s);let m=this.tribute.menuContainer?this.tribute.menuContainer.offsetHeight:this.getDocument().body.offsetHeight;if(h.bottom){let f=this.tribute.menuContainer?this.tribute.menuContainer.getBoundingClientRect():this.getDocument().body.getBoundingClientRect(),v=m-(c-f.top);a.top="auto",a.bottom=v+(c-n.top)}return h=this.isMenuOffScreen(a,p),h.left&&(a.left=d>p.width?s+d-p.width:s,delete a.right),h.top&&(a.top=c>p.height?o+c-p.height:o,delete a.bottom),this.menuContainerIsBody||(a.left=a.left?a.left-this.tribute.menuContainer.offsetLeft:a.left,a.top=a.top?a.top-this.tribute.menuContainer.offsetTop:a.top),a}scrollIntoView(e){let i=20,t,n=100,r=this.menu;if(typeof r>"u")return;for(;t===void 0||t.height===0;)if(t=r.getBoundingClientRect(),t.height===0&&(r=r.childNodes[0],r===void 0||!r.getBoundingClientRect))return;let s=t.top,o=s+t.height;if(s<0)window.scrollTo(0,window.pageYOffset+t.top-i);else if(o>window.innerHeight){let l=window.pageYOffset+t.top-i;l-window.pageYOffset>n&&(l=window.pageYOffset+n);let u=window.pageYOffset-(window.innerHeight-o);u>l&&(u=l),window.scrollTo(0,u)}}}class I{constructor(e){this.tribute=e,this.tribute.search=this}simpleFilter(e,i){return i.filter(t=>this.test(e,t))}test(e,i){return this.match(e,i)!==null}match(e,i,t){t=t||{},i.length;let n=t.pre||"",r=t.post||"",s=t.caseSensitive&&i||i.toLowerCase();if(t.skip)return{rendered:i,score:0};e=t.caseSensitive&&e||e.toLowerCase();let o=this.traverse(s,e,0,0,[]);return o?{rendered:this.render(i,o.cache,n,r),score:o.score}:null}traverse(e,i,t,n,r){if(i.length===n)return{score:this.calculateScore(r),cache:r.slice()};if(e.length===t||i.length-n>e.length-t)return;let s=i[n],o=e.indexOf(s,t),l,u;for(;o>-1;){if(r.push(o),u=this.traverse(e,i,o+1,n+1,r),r.pop(),!u)return l;(!l||l.score<u.score)&&(l=u),o=e.indexOf(s,o+1)}return l}calculateScore(e){let i=0,t=1;return e.forEach((n,r)=>{r>0&&(e[r-1]+1===n?t+=t+1:t=1),i+=t}),i}render(e,i,t,n){var r=e.substring(0,i[0]);return i.forEach((s,o)=>{r+=t+e[s]+n+e.substring(s+1,i[o+1]?i[o+1]:e.length)}),r}filter(e,i,t){return t=t||{},i.reduce((n,r,s,o)=>{let l=r;t.extract&&(l=t.extract(r),l||(l=""));let u=this.match(e,l,t);return u!=null&&(n[n.length]={string:u.rendered,score:u.score,index:s,original:r}),n},[]).sort((n,r)=>{let s=r.score-n.score;return s||n.index-r.index})}}class S{constructor({values:e=null,iframe:i=null,selectClass:t="highlight",containerClass:n="tribute-container",itemClass:r="",trigger:s="@",autocompleteMode:o=!1,selectTemplate:l=null,menuItemTemplate:u=null,lookup:a="key",fillAttr:d="value",collection:c=null,menuContainer:p=null,noMatchTemplate:h=null,requireLeadingSpace:m=!0,allowSpaces:f=!1,replaceTextSuffix:v=null,positionMenu:y=!0,spaceSelectsMatch:w=!1,searchOpts:T={},menuItemLimit:E=null,menuShowMinLength:x=0}){if(this.autocompleteMode=o,this.menuSelected=0,this.current={},this.inputEvent=!1,this.isActive=!1,this.menuContainer=p,this.allowSpaces=f,this.replaceTextSuffix=v,this.positionMenu=y,this.hasTrailingSpace=!1,this.spaceSelectsMatch=w,this.autocompleteMode&&(s="",f=!1),e)this.collection=[{trigger:s,iframe:i,selectClass:t,containerClass:n,itemClass:r,selectTemplate:(l||S.defaultSelectTemplate).bind(this),menuItemTemplate:(u||S.defaultMenuItemTemplate).bind(this),noMatchTemplate:(g=>typeof g=="string"?g.trim()===""?null:g:typeof g=="function"?g.bind(this):h||(function(){return"<li>No Match Found!</li>"}).bind(this))(h),lookup:a,fillAttr:d,values:e,requireLeadingSpace:m,searchOpts:T,menuItemLimit:E,menuShowMinLength:x}];else if(c)this.autocompleteMode&&console.warn("Tribute in autocomplete mode does not work for collections"),this.collection=c.map(g=>({trigger:g.trigger||s,iframe:g.iframe||i,selectClass:g.selectClass||t,containerClass:g.containerClass||n,itemClass:g.itemClass||r,selectTemplate:(g.selectTemplate||S.defaultSelectTemplate).bind(this),menuItemTemplate:(g.menuItemTemplate||S.defaultMenuItemTemplate).bind(this),noMatchTemplate:(C=>typeof C=="string"?C.trim()===""?null:C:typeof C=="function"?C.bind(this):h||(function(){return"<li>No Match Found!</li>"}).bind(this))(h),lookup:g.lookup||a,fillAttr:g.fillAttr||d,values:g.values,requireLeadingSpace:g.requireLeadingSpace,searchOpts:g.searchOpts||T,menuItemLimit:g.menuItemLimit||E,menuShowMinLength:g.menuShowMinLength||x}));else throw new Error("[Tribute] No collection specified.");new L(this),new M(this),new A(this),new I(this)}get isActive(){return this._isActive}set isActive(e){if(this._isActive!=e&&(this._isActive=e,this.current.element)){let i=new CustomEvent(`tribute-active-${e}`);this.current.element.dispatchEvent(i)}}static defaultSelectTemplate(e){return typeof e>"u"?`${this.current.collection.trigger}${this.current.mentionText}`:this.range.isContentEditable(this.current.element)?'<span class="tribute-mention">'+(this.current.collection.trigger+e.original[this.current.collection.fillAttr])+"</span>":this.current.collection.trigger+e.original[this.current.collection.fillAttr]}static defaultMenuItemTemplate(e){return e.string}static inputTypes(){return["TEXTAREA","INPUT"]}triggers(){return this.collection.map(e=>e.trigger)}attach(e){if(!e)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if(typeof jQuery<"u"&&e instanceof jQuery&&(e=e.get()),e.constructor===NodeList||e.constructor===HTMLCollection||e.constructor===Array){let t=e.length;for(var i=0;i<t;++i)this._attach(e[i])}else this._attach(e)}_attach(e){e.hasAttribute("data-tribute")&&console.warn("Tribute was already bound to "+e.nodeName),this.ensureEditable(e),this.events.bind(e),e.setAttribute("data-tribute",!0)}ensureEditable(e){if(S.inputTypes().indexOf(e.nodeName)===-1)if(e.contentEditable)e.contentEditable=!0;else throw new Error("[Tribute] Cannot bind to "+e.nodeName)}createMenu(e){let i=this.range.getDocument().createElement("div"),t=this.range.getDocument().createElement("ul");return i.className=e,i.appendChild(t),this.menuContainer?this.menuContainer.appendChild(i):this.range.getDocument().body.appendChild(i)}showMenuFor(e,i){if(this.isActive&&this.current.element===e&&this.current.mentionText===this.currentMentionTextSnapshot)return;this.currentMentionTextSnapshot=this.current.mentionText,this.menu||(this.menu=this.createMenu(this.current.collection.containerClass),e.tributeMenu=this.menu,this.menuEvents.bind(this.menu)),this.isActive=!0,this.menuSelected=0,this.current.mentionText||(this.current.mentionText="");const t=n=>{if(!this.isActive)return;let r=this.search.filter(this.current.mentionText,n,{pre:this.current.collection.searchOpts.pre||"<span>",post:this.current.collection.searchOpts.post||"</span>",skip:this.current.collection.searchOpts.skip,extract:l=>{if(typeof this.current.collection.lookup=="string")return l[this.current.collection.lookup];if(typeof this.current.collection.lookup=="function")return this.current.collection.lookup(l,this.current.mentionText);throw new Error("Invalid lookup attribute, lookup must be string or function.")}});this.current.collection.menuItemLimit&&(r=r.slice(0,this.current.collection.menuItemLimit)),this.current.filteredItems=r;let s=this.menu.querySelector("ul");if(this.range.positionMenuAtCaret(i),!r.length){let l=new CustomEvent("tribute-no-match",{detail:this.menu});this.current.element.dispatchEvent(l),typeof this.current.collection.noMatchTemplate=="function"&&!this.current.collection.noMatchTemplate()||!this.current.collection.noMatchTemplate?this.hideMenu():typeof this.current.collection.noMatchTemplate=="function"?s.innerHTML=this.current.collection.noMatchTemplate():s.innerHTML=this.current.collection.noMatchTemplate;return}s.innerHTML="";let o=this.range.getDocument().createDocumentFragment();r.forEach((l,u)=>{let a=this.range.getDocument().createElement("li");a.setAttribute("data-index",u),a.className=this.current.collection.itemClass,a.addEventListener("mousemove",d=>{let[c,p]=this._findLiTarget(d.target);d.movementY!==0&&this.events.setActiveLi(p)}),this.menuSelected===u&&a.classList.add(this.current.collection.selectClass),a.innerHTML=this.current.collection.menuItemTemplate(l),o.appendChild(a)}),s.appendChild(o)};typeof this.current.collection.values=="function"?this.current.collection.values(this.current.mentionText,t):t(this.current.collection.values)}_findLiTarget(e){if(!e)return[];const i=e.getAttribute("data-index");return i?[e,i]:this._findLiTarget(e.parentNode)}showMenuForCollection(e,i){e!==document.activeElement&&this.placeCaretAtEnd(e),this.current.collection=this.collection[i||0],this.current.externalTrigger=!0,this.current.element=e,e.isContentEditable?this.insertTextAtCursor(this.current.collection.trigger):this.insertAtCaret(e,this.current.collection.trigger),this.showMenuFor(e)}placeCaretAtEnd(e){if(e.focus(),typeof window.getSelection<"u"&&typeof document.createRange<"u"){var i=document.createRange();i.selectNodeContents(e),i.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(i)}else if(typeof document.body.createTextRange<"u"){var n=document.body.createTextRange();n.moveToElementText(e),n.collapse(!1),n.select()}}insertTextAtCursor(e){var i,t;i=window.getSelection(),t=i.getRangeAt(0),t.deleteContents();var n=document.createTextNode(e);t.insertNode(n),t.selectNodeContents(n),t.collapse(!1),i.removeAllRanges(),i.addRange(t)}insertAtCaret(e,i){var t=e.scrollTop,n=e.selectionStart,r=e.value.substring(0,n),s=e.value.substring(e.selectionEnd,e.value.length);e.value=r+i+s,n=n+i.length,e.selectionStart=n,e.selectionEnd=n,e.focus(),e.scrollTop=t}hideMenu(){this.menu&&(this.menu.style.cssText="display: none;",this.isActive=!1,this.menuSelected=0,this.current={})}selectItemAtIndex(e,i){if(e=parseInt(e),typeof e!="number"||isNaN(e))return;let t=this.current.filteredItems[e],n=this.current.collection.selectTemplate(t);n!==null&&this.replaceText(n,i,t)}replaceText(e,i,t){this.range.replaceTriggerText(e,!0,!0,i,t)}_append(e,i,t){if(typeof e.values=="function")throw new Error("Unable to append to values, as it is a function.");t?e.values=i:e.values=e.values.concat(i)}append(e,i,t){let n=parseInt(e);if(typeof n!="number")throw new Error("please provide an index for the collection to update.");let r=this.collection[n];this._append(r,i,t)}appendCurrent(e,i){if(this.isActive)this._append(this.current.collection,e,i);else throw new Error("No active state. Please use append instead and pass an index.")}detach(e){if(!e)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if(typeof jQuery<"u"&&e instanceof jQuery&&(e=e.get()),e.constructor===NodeList||e.constructor===HTMLCollection||e.constructor===Array){let t=e.length;for(var i=0;i<t;++i)this._detach(e[i])}else this._detach(e)}_detach(e){this.events.unbind(e),e.tributeMenu&&this.menuEvents.unbind(e.tributeMenu),setTimeout(()=>{e.removeAttribute("data-tribute"),this.isActive=!1,e.tributeMenu&&e.tributeMenu.remove()})}}function k(b,e,i=500){return{content:"",tribute:null,mentionables:JSON.stringify(b),hashables:JSON.stringify(e),maxLength:i,currentLength:0,isOverLimit:!1,previousContent:"",isInitialized:!1,showValidationError:!1,validationMessage:"",showPasteWarning:!1,pasteMessage:"",remainingChars:i,init(){this.isInitialized||(this.setupTribute(),this.isInitialized=!0,this.$refs.textarea.innerHtml=null,this.$watch("content",t=>{this.currentLength=this.getTextLength(t),this.remainingChars=this.maxLength-this.currentLength,this.$dispatch("mentionable:text-update",{state:t})}),this.setupPasteValidation())},setupTribute(){const t=this.$refs.textarea?this.$refs.textarea.id:"unknown";if(!this.$refs.textarea){console.warn(`MentionableText[${t}]: textarea ref not found`);return}if(this.$refs.textarea.tribute||this.$refs.textarea.hasAttribute("data-tribute")){console.warn(`MentionableText[${t}]: Tribute already attached to this textarea`);return}const n=[];this.mentionables&&this.mentionables.length>0&&n.push({trigger:"@",values:JSON.parse(this.mentionables),lookup:"name",fillAttr:"email",selectTemplate:r=>`<span contenteditable="false"><span class="text-sm font-semibold text-sky-500 dark:text-sky-300">${r.original.name}</span></span > `,menuItemTemplate:r=>{const s=r.original,o=s.avatar?`< img src = "${s.avatar}" class="tribute-item-avatar" alt = "${s.name}" > `:`<div div class="tribute-item-avatar-placeholder" > ${s.name.charAt(0).toUpperCase()}</div > `,l=s.title?`<div div class="tribute-item-title" > ${s.title}</div > `:"";return`<div div style = "display: flex; align-items: center; gap: 0.5rem;" > ${o} <div class="tribute-item-content"><div class="tribute-item-name">${r.string}</div><div class="tribute-item-email">${s.email}</div>${l}</div></div > `},noMatchTemplate:()=>'<div style="padding: 8px; color: #666;">No users found</div>',searchOpts:{pre:"<span>",post:"</span>",skip:!1},requireLeadingSpace:!1,allowSpaces:!1,menuItemLimit:8,menuShowMinLength:0,replaceTextSuffix:"&#32;"}),this.hashables&&this.hashables.length>0&&n.push({trigger:"#",values:JSON.parse(this.hashables),lookup:"name",fillAttr:"name",selectTemplate:r=>`<span span contenteditable = "false" > <a class="text-sm text-indigo-600 underline dark:text-indigo-300 font-semibold" tabindex="-1" href='${r.original.url}'>#${r.original.name}</a></span > `,menuItemTemplate:r=>{const s=r.original;return`<div div style = "display: flex; align-items: center; gap: 0.5rem;" ><div class="tribute-item-hashtag-icon">#</div><div class="tribute-item-content"><div class="tribute-item-name">${r.string}</div>${s.url?`<div class="tribute-item-url">${s.url}</div>`:""}</div></div > `},noMatchTemplate:()=>'<div style="padding: 8px; color: #666;">No hashtags found</div>',searchOpts:{pre:"<span>",post:"</span>",skip:!1},requireLeadingSpace:!1,allowSpaces:!1,menuItemLimit:8,menuShowMinLength:0,autocompleteMode:!0,replaceTextSuffix:"&#32;"}),this.tribute=new S({collection:n,spaceSelectsMatch:!1,positionMenu:!0}),this.tribute.attach(this.$refs.textarea),this.$refs.textarea.setAttribute("data-tribute","true"),window.addEventListener("blur",()=>{this.tribute&&this.tribute.isActive&&this.tribute.hideMenu()}),this.$refs.textarea.addEventListener("blur",()=>{this.tribute&&this.tribute.isActive&&this.tribute.hideMenu()}),this.$refs.textarea.addEventListener("tribute-replaced",r=>{const s=r.detail.item;console.log(r.detail.instance.trigger),s.original&&(r.detail.instance.trigger==="@"?this.handelMentionAdded(s.original.id):r.detail.instance.trigger==="#"&&(console.log(s),this.handleHashableAdded(s.original.id)))}),this.setupTributeStyles()},handelMentionAdded(t){this.$dispatch("mentionable:mention-added",{id:t})},handleHashableAdded(t){this.$dispatch("mentionable:hash-added",{id:t})},getTextLength(t){var r;const n=document.createElement("div");return n.innerHTML=t,((r=n.textContent)==null?void 0:r.length)||0},setupPasteValidation(){this.$refs.textarea&&this.$refs.textarea.addEventListener("paste",t=>{t.preventDefault();const n=(t.clipboardData||window.clipboardData).getData("text"),r=this.getTextLength(this.content),s=n.length;if(r+s<=this.maxLength)document.execCommand("insertText",!1,n);else{const o=this.maxLength-r;if(o>0){const l=n.substring(0,o);document.execCommand("insertText",!1,l)}this.showPasteWarning=!0,this.pasteMessage=`Paste truncated. Only ${Math.max(0,o)} characters were added.`,setTimeout(()=>{this.showPasteWarning=!1},2e3),this.$dispatch("mentionable:paste-limited",{attempted:s,allowed:Math.max(0,o)})}})},setCursorToEnd(){if(!this.$refs.textarea)return;const t=document.createRange(),n=window.getSelection();t.selectNodeContents(this.$refs.textarea),t.collapse(!1),n.removeAllRanges(),n.addRange(t)},setupTributeStyles(){},initializeWithData(){this.isInitialized||(this.setupTribute(),this.isInitialized=!0)},reinitializeTribute(){this.isInitialized&&(this.tribute&&(this.tribute.detach(this.$refs.textarea),this.tribute=null),this.$refs.textarea&&(this.$refs.textarea.tribute=null,this.$refs.textarea.removeAttribute("data-tribute")),this.setupTribute())},getMentionedUsers(){const t=/@(\w+)/g,n=[];let r;for(;(r=t.exec(this.content))!==null;){const s=r[1],o=this.mentionables.find(l=>l.name===s);o&&!n.some(l=>l.id===o.id)&&n.push(o)}return n},getHashtags(){const t=/#(\w+)/g,n=[];let r;for(;(r=t.exec(this.content))!==null;){const s=r[1],o=this.hashables.find(l=>l.name===s);o&&!n.some(l=>l.name===o.name)&&n.push(o)}return n},destroy(){this.tribute&&(this.tribute.detach(this.$refs.textarea),this.tribute=null),this.$refs.textarea&&(this.$refs.textarea.tribute=null,this.$refs.textarea.removeAttribute("data-tribute"))}}}export{k as default};
