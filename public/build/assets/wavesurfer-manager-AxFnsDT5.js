import M from"./wavesurfer.esm-Toh_7rjd.js";function y(t,e,r,s){return new(r||(r=Promise))(function(n,i){function o(f){try{u(s.next(f))}catch(c){i(c)}}function a(f){try{u(s.throw(f))}catch(c){i(c)}}function u(f){var c;f.done?n(f.value):(c=f.value,c instanceof r?c:new r(function(m){m(c)})).then(o,a)}u((s=s.apply(t,[])).next())})}class R{constructor(){this.listeners={}}on(e,r,s){if(this.listeners[e]||(this.listeners[e]=new Set),this.listeners[e].add(r),s==null?void 0:s.once){const n=()=>{this.un(e,n),this.un(e,r)};return this.on(e,n),n}return()=>this.un(e,r)}un(e,r){var s;(s=this.listeners[e])===null||s===void 0||s.delete(r)}once(e,r){return this.on(e,r,{once:!0})}unAll(){this.listeners={}}emit(e,...r){this.listeners[e]&&this.listeners[e].forEach(s=>s(...r))}}class E extends R{constructor(e){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=e}onInit(){}_init(e){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=e,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach(e=>e()),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}}class S extends R{constructor(){super(...arguments),this.unsubscribe=()=>{}}start(){this.unsubscribe=this.on("tick",()=>{requestAnimationFrame(()=>{this.emit("tick")})}),this.emit("tick")}stop(){this.unsubscribe()}destroy(){this.unsubscribe()}}const T=["audio/webm","audio/wav","audio/mpeg","audio/mp4","audio/mp3"];class W extends E{constructor(e){var r,s,n,i,o,a;super(Object.assign(Object.assign({},e),{audioBitsPerSecond:(r=e.audioBitsPerSecond)!==null&&r!==void 0?r:128e3,scrollingWaveform:(s=e.scrollingWaveform)!==null&&s!==void 0&&s,scrollingWaveformWindow:(n=e.scrollingWaveformWindow)!==null&&n!==void 0?n:5,continuousWaveform:(i=e.continuousWaveform)!==null&&i!==void 0&&i,renderRecordedAudio:(o=e.renderRecordedAudio)===null||o===void 0||o,mediaRecorderTimeslice:(a=e.mediaRecorderTimeslice)!==null&&a!==void 0?a:void 0})),this.stream=null,this.mediaRecorder=null,this.dataWindow=null,this.isWaveformPaused=!1,this.lastStartTime=0,this.lastDuration=0,this.duration=0,this.timer=new S,this.subscriptions.push(this.timer.on("tick",()=>{const u=performance.now()-this.lastStartTime;this.duration=this.isPaused()?this.duration:this.lastDuration+u,this.emit("record-progress",this.duration)}))}static create(e){return new W(e||{})}renderMicStream(e){var r;const s=new AudioContext,n=s.createMediaStreamSource(e),i=s.createAnalyser();n.connect(i),this.options.continuousWaveform&&(i.fftSize=32);const o=i.frequencyBinCount,a=new Float32Array(o);let u=0;this.wavesurfer&&((r=this.originalOptions)!==null&&r!==void 0||(this.originalOptions=Object.assign({},this.wavesurfer.options)),this.wavesurfer.options.interact=!1,this.options.scrollingWaveform&&(this.wavesurfer.options.cursorWidth=0));const f=setInterval(()=>{var c,m,p,w;if(!this.isWaveformPaused){if(i.getFloatTimeDomainData(a),this.options.scrollingWaveform){const v=Math.floor((this.options.scrollingWaveformWindow||0)*s.sampleRate),h=Math.min(v,this.dataWindow?this.dataWindow.length+o:o),g=new Float32Array(v);if(this.dataWindow){const D=Math.max(0,v-this.dataWindow.length);g.set(this.dataWindow.slice(-h+o),D)}g.set(a,v-o),this.dataWindow=g}else if(this.options.continuousWaveform){if(!this.dataWindow){const h=this.options.continuousWaveformDuration?Math.round(100*this.options.continuousWaveformDuration):((m=(c=this.wavesurfer)===null||c===void 0?void 0:c.getWidth())!==null&&m!==void 0?m:0)*window.devicePixelRatio;this.dataWindow=new Float32Array(h)}let v=0;for(let h=0;h<o;h++){const g=Math.abs(a[h]);g>v&&(v=g)}if(u+1>this.dataWindow.length){const h=new Float32Array(2*this.dataWindow.length);h.set(this.dataWindow,0),this.dataWindow=h}this.dataWindow[u]=v,u++}else this.dataWindow=a;if(this.wavesurfer){const v=((w=(p=this.dataWindow)===null||p===void 0?void 0:p.length)!==null&&w!==void 0?w:0)/100;this.wavesurfer.load("",[this.dataWindow],this.options.scrollingWaveform?this.options.scrollingWaveformWindow:v).then(()=>{this.wavesurfer&&this.options.continuousWaveform&&(this.wavesurfer.setTime(this.getDuration()/1e3),this.wavesurfer.options.minPxPerSec||this.wavesurfer.setOptions({minPxPerSec:this.wavesurfer.getWidth()/this.wavesurfer.getDuration()}))}).catch(h=>{console.error("Error rendering real-time recording data:",h)})}}},10);return{onDestroy:()=>{clearInterval(f),n==null||n.disconnect(),s==null||s.close()},onEnd:()=>{this.isWaveformPaused=!0,clearInterval(f),this.stopMic()}}}startMic(e){return y(this,void 0,void 0,function*(){let r;try{r=yield navigator.mediaDevices.getUserMedia({audio:e==null||e})}catch(i){throw new Error("Error accessing the microphone: "+i.message)}const{onDestroy:s,onEnd:n}=this.renderMicStream(r);return this.subscriptions.push(this.once("destroy",s)),this.subscriptions.push(this.once("record-end",n)),this.stream=r,r})}stopMic(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null,this.mediaRecorder=null)}startRecording(e){return y(this,void 0,void 0,function*(){const r=this.stream||(yield this.startMic(e));this.dataWindow=null;const s=this.mediaRecorder||new MediaRecorder(r,{mimeType:this.options.mimeType||T.find(o=>MediaRecorder.isTypeSupported(o)),audioBitsPerSecond:this.options.audioBitsPerSecond});this.mediaRecorder=s,this.stopRecording();const n=[];s.ondataavailable=o=>{o.data.size>0&&n.push(o.data),this.emit("record-data-available",o.data)};const i=o=>{var a;const u=new Blob(n,{type:s.mimeType});this.emit(o,u),this.options.renderRecordedAudio&&(this.applyOriginalOptionsIfNeeded(),(a=this.wavesurfer)===null||a===void 0||a.load(URL.createObjectURL(u)))};s.onpause=()=>i("record-pause"),s.onstop=()=>i("record-end"),s.start(this.options.mediaRecorderTimeslice),this.lastStartTime=performance.now(),this.lastDuration=0,this.duration=0,this.isWaveformPaused=!1,this.timer.start(),this.emit("record-start")})}getDuration(){return this.duration}isRecording(){var e;return((e=this.mediaRecorder)===null||e===void 0?void 0:e.state)==="recording"}isPaused(){var e;return((e=this.mediaRecorder)===null||e===void 0?void 0:e.state)==="paused"}isActive(){var e;return((e=this.mediaRecorder)===null||e===void 0?void 0:e.state)!=="inactive"}stopRecording(){var e;this.isActive()&&((e=this.mediaRecorder)===null||e===void 0||e.stop(),this.timer.stop())}pauseRecording(){var e,r;this.isRecording()&&(this.isWaveformPaused=!0,(e=this.mediaRecorder)===null||e===void 0||e.requestData(),(r=this.mediaRecorder)===null||r===void 0||r.pause(),this.timer.stop(),this.lastDuration=this.duration)}resumeRecording(){var e;this.isPaused()&&(this.isWaveformPaused=!1,(e=this.mediaRecorder)===null||e===void 0||e.resume(),this.timer.start(),this.lastStartTime=performance.now(),this.emit("record-resume"))}static getAvailableAudioDevices(){return y(this,void 0,void 0,function*(){return navigator.mediaDevices.enumerateDevices().then(e=>e.filter(r=>r.kind==="audioinput"))})}destroy(){this.applyOriginalOptionsIfNeeded(),super.destroy(),this.stopRecording(),this.stopMic()}applyOriginalOptionsIfNeeded(){this.wavesurfer&&this.originalOptions&&(this.wavesurfer.setOptions(this.originalOptions),delete this.originalOptions)}}let d=null,l=new Map;const P=10,b=async(t,e,r,s,n=!1)=>{const i=M.create({container:t,waveColor:s.waveColor,progressColor:s.progressColor,cursorColor:s.cursorColor,barWidth:2,barGap:1,responsive:!0,height:32,normalize:!0,backend:"WebAudio",...s});i.on("ready",()=>{r&&r(i)}),i.on("error",a=>{console.error("Wavesurfer error:",a)});let o=null;if(n&&(o=i.registerPlugin(W.create({renderRecordedAudio:!1,scrollingWaveform:!1,continuousWaveform:!0,continuousWaveformDuration:s.maxDuration||180,mediaRecorderOptions:{mimeType:"audio/webm;codecs=opus"}}))),e)try{await i.load(e),n||(i._isLoaded=!0)}catch(a){throw console.error("Failed to load audio:",a),a}else n||(i._audioUrl=null,i._isLoaded=!1);return{wavesurfer:i,recordPlugin:o}},O=t=>{var e;if(l.size>=P&&!l.has(t)){const r=l.keys().next().value;if(r&&r!==d){console.log(`ðŸ—‘ï¸ LRU Cache: Destroying oldest player instance: ${r} (limit: ${P})`);const s=l.get(r);try{(e=s.wavesurfer)==null||e.destroy()}catch(n){console.warn("Error destroying oldest player:",n)}l.delete(r)}}},C=t=>{if(l.has(t)){const e=l.get(t);l.delete(t),l.set(t,e)}},A={destroyAll(){for(const[t,e]of l)try{e.wavesurfer&&e.wavesurfer.destroy()}catch(r){console.warn("Error destroying player:",r)}l.clear(),d=null},async togglePlay(t,e,r,s,n){let i=l.get(t);if(console.log(`ðŸŽµ togglePlay called for ${t}, exists: ${!!i}, active: ${d}`),d===t&&i){console.log(`â–¶ï¸ Toggling play/pause for active player ${t}`),i.wavesurfer.playPause();return}if(d&&l.has(d)){const o=l.get(d);try{o.wavesurfer.isPlaying()&&o.wavesurfer.pause()}catch(a){console.warn("Error pausing current player:",a)}}if(i||O(t),i)console.log(`â™»ï¸ Reusing existing instance for ${t}`),C(t);else{console.log(`ðŸ”„ Creating new WaveSurfer instance for ${t}`);const{wavesurfer:o}=await b(e,r,s,n,!1);i={wavesurfer:o,container:e,audioUrl:r},l.set(t,i)}d=t;try{console.log(`ðŸŽ¬ Playing ${t}`),await i.wavesurfer.play()}catch(o){console.warn("Error playing audio:",o)}},isPlaying(){if(!d||!l.has(d))return!1;const t=l.get(d);return t.wavesurfer?t.wavesurfer.isPlaying():!1},getCurrentTime(){if(!d||!l.has(d))return 0;const t=l.get(d);return t.wavesurfer?t.wavesurfer.getCurrentTime():0},getDuration(){if(!d||!l.has(d))return 0;const t=l.get(d);return t.wavesurfer?t.wavesurfer.getDuration():0},getActiveInstanceKey(){return d},destroy(t){var r;const e=l.get(t);if(e){try{e.wavesurfer&&e.wavesurfer.isPlaying()&&e.wavesurfer.pause(),(r=e.wavesurfer)==null||r.destroy()}catch(s){console.warn("Error destroying wavesurfer instance:",s)}l.delete(t),d===t&&(d=null)}},getActiveInstances(){return Array.from(l.keys())}},x={instances:new Map,stopAllRecording(){for(const[t,e]of this.instances)if(e.recordPlugin)try{e.recordPlugin.isRecording()&&e.recordPlugin.stopRecording()}catch(r){console.warn(`Error stopping recording for ${t}:`,r)}},async init(t,e,r=null,s=null,n={}){this.instances.has(t)&&this.destroy(t);const i={waveColor:"#71717a",progressColor:"#10b981",cursorColor:"#059669",interact:!1,maxDuration:180,...n},{wavesurfer:o,recordPlugin:a}=await b(e,r,s,i,!0);return this.instances.set(t,{wavesurfer:o,recordPlugin:a,container:e}),{wavesurfer:o,recordPlugin:a}},getRecord(t){const e=this.instances.get(t);return(e==null?void 0:e.recordPlugin)||null},getWavesurfer(t){const e=this.instances.get(t);return(e==null?void 0:e.wavesurfer)||null},togglePlay(t){const e=this.instances.get(t);e!=null&&e.wavesurfer&&e.wavesurfer.playPause()},isPlaying(t){const e=this.instances.get(t);return e!=null&&e.wavesurfer?e.wavesurfer.isPlaying():!1},getCurrentTime(t){const e=this.instances.get(t);return e!=null&&e.wavesurfer?e.wavesurfer.getCurrentTime():0},getDuration(t){const e=this.instances.get(t);return e!=null&&e.wavesurfer?e.wavesurfer.getDuration():0},destroy(t){const e=this.instances.get(t);if(e){try{e.recordPlugin&&e.recordPlugin.unAll(),e.wavesurfer&&(e.wavesurfer.unAll(),e.wavesurfer.destroy())}catch(r){console.warn("Error destroying recorder wavesurfer:",r)}this.instances.delete(t)}},destroyAll(){for(const[t]of this.instances)this.destroy(t)}};window.addEventListener("wv-manager:player:destroy",()=>{console.log("listening inside the manager"),A.destroyAll()});window.addEventListener("wv-manager:recorder:destroy",()=>{console.log("listening inside the manager"),x.destroyAll()});window.playerManager=A;export{A as p,x as r};
