function g(){function c(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)})}function d(t,e){let i;return function(...n){i||(t.apply(this,n),i=!0,setTimeout(()=>i=!1,e))}}return{isOpen:!1,currentImage:"",designId:null,comments:[],isSelecting:!1,isDragging:!1,allCommentsHidden:!1,_openedViaEvent:!1,selectionStart:{x:0,y:0,xPx:null,yPx:null},selectionBox:{x:0,y:0,width:0,height:0},selectedCommentIds:[],showCommentFilter:!1,visibleComments:[],filterMode:!1,touchStartTime:0,longPressTimer:null,touchMoved:!1,isMobile:!1,zoomLevel:1,minZoom:1,maxZoom:9,mainContainerWidth:0,mainContainerHeight:0,innerWrapperWidth:0,innerWrapperHeight:0,panX:0,panY:0,arrowKeyStep:50,callbacks:{onDeleteComment:null,onCommentClick:null,onModalOpen:null,onModalClose:null},get hasActiveFilter(){return this.allCommentsHidden?!1:this.selectedCommentIds.length<this.comments.length},get canZoomIn(){return this.zoomLevel<this.responsiveMaxZoom},get canZoomOut(){return this.zoomLevel>this.minZoom},get isZoomed(){return this.zoomLevel>1},get imageDisplayWidth(){return this.imageNaturalWidth*this.zoomLevel},get imageDisplayHeight(){return this.imageNaturalHeight*this.zoomLevel},get currentZoomStep(){const t=window.innerWidth;return t<640?Math.max(100,this.mainContainerWidth*.15):t<768?Math.max(120,this.mainContainerWidth*.18):t<1024?Math.max(150,this.mainContainerWidth*.2):t<1280?Math.max(180,this.mainContainerWidth*.22):Math.max(200,this.mainContainerWidth*.25)},get responsiveMaxZoom(){const t=window.innerWidth;return t<640?4:t<768?5:t<1024?6:8},init(t={}){this.isMobile=this.detectMobileDevice(),this.throttledUpdateSelection=d(this.updateSelection.bind(this),16),t&&Object.keys(t).length>0&&this.setCallbacks(t),this.$watch("selectedCommentIds",()=>{this.filterMode&&this.updateVisibleComments()}),this.handleOpenEvent=e=>{this._openedViaEvent=!0;const{imageUrl:i,comments:n,designId:s}=e.detail;this.openModal(i,n||[],s),this.setCallbacks({onDeleteComment:async o=>{if(window.Livewire)return new Promise((a,h)=>{Livewire.emit("deleteComment",{designId:s,commentId:o}),a()})},onCommentClick:o=>{console.log("Comment clicked:",o)}})},window.addEventListener("open-design-review",this.handleOpenEvent)},destroy(){this.handleOpenEvent&&(window.removeEventListener("open-design-review",this.handleOpenEvent),this.handleOpenEvent=null),this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.updateSelection&&this.updateSelection.cancel&&this.updateSelection.cancel(),this.resetZoomState(),this.comments=[],this.visibleComments=[],this.selectedCommentIds=[],this.callbacks={}},handleEscape(){if(this.showingComment){this.closeComment();return}this.handleClose()},updateVisibleComments(){this.visibleComments=this.filterMode?this.comments.filter(t=>this.selectedCommentIds.includes(t.id)):this.comments.filter(t=>{var e;return(e=t.text)==null?void 0:e.trim()})},toggleCommentFilter(){this.showCommentFilter=!this.showCommentFilter,this.filterMode=!this.filterMode},toggleAllComments(){this.allCommentsHidden?this.showAllComments():this.hideAllComments()},hideAllComments(){this.selectedCommentIds=[],this.visibleComments=[],this.allCommentsHidden=!0},showAllComments(){this.visibleComments=this.comments,this.selectedCommentIds=this.comments.map(t=>t.id),this.allCommentsHidden=!1},openModal(t,e=[],i){this._openedViaEvent&&(console.warn("Design Review: Modal opened via both direct method and event. Using direct method parameters."),this._openedViaEvent=!1),this.currentImage=t,this.designId=i,this.comments=e,this.selectedCommentIds=this.comments.map(n=>n.id),this.isOpen=!0,this.updateVisibleComments(),this.$nextTick(()=>{this.updateImageDimensions()}),this.callbacks.onModalOpen&&this.callbacks.onModalOpen(this.currentImage)},closeModal(){this.isOpen=!1,this.reset(),this.callbacks.onModalClose&&this.callbacks.onModalClose()},reset(){this.comments=[],this.selectedCommentIds=[],this.activeCommentId=null,this.isSelecting=!1,this.isDragging=!1,this.allCommentsHidden=!1,this.visibleComments=[],this.filterMode=!1,this.showCommentFilter=!1,this.resetZoomState(),this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},resetZoomState(){this.zoomLevel=1,this.mainContainerWidth=0,this.mainContainerHeight=0,this.innerWrapperWidth=0,this.innerWrapperHeight=0,this.panX=0,this.panY=0},resetPan(){this.panX=0,this.panY=0},moveUp(){if(!this.isZoomed)return;this.enableSmoothTransitions();const t=Math.max(0,(this.innerWrapperHeight-this.mainContainerHeight)/2);this.panY=Math.min(t,this.panY+this.arrowKeyStep)},moveDown(){if(!this.isZoomed)return;this.enableSmoothTransitions();const t=Math.max(0,(this.innerWrapperHeight-this.mainContainerHeight)/2);this.panY=Math.max(-t,this.panY-this.arrowKeyStep)},moveLeft(){if(!this.isZoomed)return;this.enableSmoothTransitions();const t=Math.max(0,(this.innerWrapperWidth-this.mainContainerWidth)/2);this.panX=Math.min(t,this.panX+this.arrowKeyStep)},moveRight(){if(!this.isZoomed)return;this.enableSmoothTransitions();const t=Math.max(0,(this.innerWrapperWidth-this.mainContainerWidth)/2);this.panX=Math.max(-t,this.panX-this.arrowKeyStep)},detectMobileDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0||/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<768},handleClose(){if(this.showCommentFilter){this.showCommentFilter=!1,this.filterMode=!1;return}this.closeModal()},handleBackdropClick(t){t.target===t.currentTarget&&this.handleClose()},startSelection(t){if(t.button!==0)return;this.disableSmoothTransitions();const e=this.$refs.innerWrapper.getBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top,s=this.getImageCoordinates(t.clientX,t.clientY);this.selectionStart={x:s.x,y:s.y,xPx:i,yPx:n},this.isDragging=!0,this.isSelecting=!1},updateSelection(t){if(!this.isDragging||!this.selectionStart.xPx)return;const e=this.$refs.innerWrapper.getBoundingClientRect(),i=Math.max(0,Math.min(t.clientX-e.left,e.width)),n=Math.max(0,Math.min(t.clientY-e.top,e.height));if(Math.sqrt(Math.pow(i-this.selectionStart.xPx,2)+Math.pow(n-this.selectionStart.yPx,2))>(this.isMobile?8:5)&&(this.isSelecting=!0),!this.isSelecting)return;const o=this.getImageCoordinates(t.clientX,t.clientY);this.selectionBox={x:Math.min(this.selectionStart.x,o.x),y:Math.min(this.selectionStart.y,o.y),width:Math.abs(o.x-this.selectionStart.x),height:Math.abs(o.y-this.selectionStart.y)}},endSelection(t){if(!this.isDragging)return;const e=this.$refs.innerWrapper.getBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top;this.isDragging=!1,this.enableSmoothTransitions(),this.isSelecting&&this.selectionBox.width>1&&this.selectionBox.height>1?this.createAreaComment():i>=0&&i<=e.width&&n>=0&&n<=e.height&&this.handleClick(t.clientX,t.clientY,e),this.resetSelectionState()},handleTouchStart(t){this.disableSmoothTransitions();const e=t.touches[0],i=this.$refs.innerWrapper.getBoundingClientRect(),n=e.clientX-i.left,s=e.clientY-i.top;this.touchStartTime=Date.now(),this.touchMoved=!1;const o=this.getImageCoordinates(e.clientX,e.clientY);this.selectionStart={x:o.x,y:o.y,xPx:n,yPx:s},this.isDragging=!0,this.isSelecting=!1,this.longPressTimer=setTimeout(()=>{!this.touchMoved&&this.isDragging&&(navigator.vibrate&&navigator.vibrate([10,50,10]),this.isSelecting=!0)},300)},handleTouchMove(t){if(!this.isDragging)return;const e=t.touches[0],i=this.$refs.innerWrapper.getBoundingClientRect(),n=Math.max(0,Math.min(e.clientX-i.left,i.width)),s=Math.max(0,Math.min(e.clientY-i.top,i.height));if(Math.sqrt(Math.pow(n-this.selectionStart.xPx,2)+Math.pow(s-this.selectionStart.yPx,2))>12&&(this.touchMoved=!0,this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.isSelecting=!0),!this.isSelecting)return;const a=this.getImageCoordinates(e.clientX,e.clientY);this.selectionBox={x:Math.min(this.selectionStart.x,a.x),y:Math.min(this.selectionStart.y,a.y),width:Math.abs(a.x-this.selectionStart.x),height:Math.abs(a.y-this.selectionStart.y)}},handleTouchEnd(t){if(!this.isDragging)return;this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.enableSmoothTransitions();const e=this.$refs.innerWrapper.getBoundingClientRect(),i=Date.now()-this.touchStartTime;if(this.isSelecting&&this.selectionBox.width>1&&this.selectionBox.height>1)this.createAreaComment();else if(!this.touchMoved&&i<300){const n=t.changedTouches[0];this.handleClick(n.clientX,n.clientY,e)}this.isDragging=!1,this.resetSelectionState()},handleClick(t,e,i){if(!this.isZoomed){const h=this.getImageCoordinates(t,e),l=this.isMobile?2.5:1.5,r=this.findCommentAtPoint(h.x,h.y,l);if(r)return this.selectComment(r)}const n=this.getImageCoordinates(t,e),s=this.isMobile?3:2,o=s/2,a={x:Math.max(0,Math.min(100-s,n.x-o)),y:Math.max(0,Math.min(100-s,n.y-o)),width:s,height:s,type:"point",designId:this.designId,imageUrl:this.currentImage,isMobile:this.isMobile,zoomLevel:this.zoomLevel};this.dispatchCommentEvent(a)},createAreaComment(){const t={x:Math.max(0,Math.min(100,this.selectionBox.x)),y:Math.max(0,Math.min(100,this.selectionBox.y)),width:Math.min(this.selectionBox.width,100-this.selectionBox.x),height:Math.min(this.selectionBox.height,100-this.selectionBox.y),type:"area",designId:this.designId,imageUrl:this.currentImage,isMobile:this.isMobile,zoomLevel:this.zoomLevel};this.dispatchCommentEvent(t)},dispatchCommentEvent(t){window.dispatchEvent(new CustomEvent("open-comment-modal",{detail:t,bubbles:!0}))},cancelSelection(){this.isDragging=!1,this.isSelecting=!1,this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.resetSelectionState()},resetSelectionState(){this.selectionStart={x:0,y:0,xPx:null,yPx:null},this.selectionBox={x:0,y:0,width:0,height:0},this.isSelecting=!1},findCommentAtPoint(t,e,i=0){return this.visibleComments.find(n=>{const s=n.x-i,o=n.x+n.width+i,a=n.y-i,h=n.y+n.height+i;return t>=s&&t<=o&&e>=a&&e<=h})},selectComment(t){console.log("Comment selected:",t),this.callbacks.onCommentClick&&this.callbacks.onCommentClick(t)},setCallbacks(t={}){const e=["onDeleteComment","onCommentClick","onModalOpen","onModalClose"];Object.keys(t).forEach(i=>{e.includes(i)&&typeof t[i]=="function"&&(this.callbacks[i]=t[i])})},getComments(){return this.comments},addComment(t){const e={id:t.id||c(),...t};this.comments.find(i=>i.id===e.id)||(this.comments.push(e),this.selectedCommentIds.includes(e.id)||this.selectedCommentIds.push(e.id),this.updateVisibleComments())},async removeComment(t){try{const e=[...this.comments],i=[...this.selectedCommentIds];this.comments=this.comments.filter(n=>n.id!==t),this.selectedCommentIds=this.selectedCommentIds.filter(n=>n!==t),this.updateVisibleComments(),this.callbacks.onDeleteComment&&await this.callbacks.onDeleteComment(t)}catch(e){console.error("Error deleting comment:",e),this.comments=originalComments,this.selectedCommentIds=originalSelectedIds,this.updateVisibleComments(),alert("Failed to delete comment. Please try again.")}},zoomIn(t=1.2){this.enableSmoothTransitions();const e=Math.min(this.zoomLevel*t,this.maxZoom);this.setZoom(e)},zoomOut(t=1.2){this.enableSmoothTransitions();const e=Math.max(this.zoomLevel/t,this.minZoom);this.setZoom(e)},resetZoom(){this.setZoom(1),this.resetPan()},setZoom(t){this.zoomLevel=t,this.updateImageDimensionsAndCenter()},centerImage(){if(this.innerWrapperWidth<=this.mainContainerWidth)this.panX=0;else{const t=Math.max(0,(this.innerWrapperWidth-this.mainContainerWidth)/2);this.panX=Math.max(-t,Math.min(t,this.panX))}if(this.innerWrapperHeight<=this.mainContainerHeight)this.panY=0;else{const t=Math.max(0,(this.innerWrapperHeight-this.mainContainerHeight)/2);this.panY=Math.max(-t,Math.min(t,this.panY))}},enableSmoothTransitions(){this.$refs.innerWrapper&&(this.$refs.innerWrapper.style.transition="transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)")},disableSmoothTransitions(){this.$refs.innerWrapper&&(this.$refs.innerWrapper.style.transition="none")},updateImageDimensionsAndCenter(){const e=1+(this.zoomLevel-1)*this.currentZoomStep/Math.max(this.mainContainerWidth,this.mainContainerHeight);if(this.mainContainerWidth>0){if(this.innerWrapperWidth=this.mainContainerWidth*e,this.innerWrapperHeight=this.mainContainerHeight*e,this.innerWrapperWidth<=this.mainContainerWidth)this.panX=0;else{const i=Math.max(0,(this.innerWrapperWidth-this.mainContainerWidth)/2);this.panX=Math.max(-i,Math.min(i,this.panX))}if(this.innerWrapperHeight<=this.mainContainerHeight)this.panY=0;else{const i=Math.max(0,(this.innerWrapperHeight-this.mainContainerHeight)/2);this.panY=Math.max(-i,Math.min(i,this.panY))}}else this.updateImageDimensions()},updateImageDimensions(){this.$nextTick(()=>{const t=this.$refs.scrollContainer,e=this.$refs.mainContainer,i=this.$refs.innerWrapper,n=this.$refs.image;if(!t||!e||!i||!n){console.log("Missing refs:",{viewport:!!t,mainContainer:!!e,innerWrapper:!!i,image:!!n});return}if(n.naturalWidth===0||n.naturalHeight===0){console.log("Image not loaded yet, waiting...");return}if(this.mainContainerWidth===0){const a=t.clientWidth,h=t.clientHeight,l=n.naturalWidth/n.naturalHeight;let r,m;r=a,m=a/l,m>h&&(m=h,r=h*l),this.mainContainerWidth=r,this.mainContainerHeight=m,this.innerWrapperWidth=r,this.innerWrapperHeight=m,console.log("Container dimensions set:",{viewport:{width:a,height:h},mainContainer:{width:this.mainContainerWidth,height:this.mainContainerHeight},innerWrapper:{width:this.innerWrapperWidth,height:this.innerWrapperHeight},aspectRatio:l,expectedAspectRatio:n.naturalWidth/n.naturalHeight,calculatedAspectRatio:r/m,naturalSize:{width:n.naturalWidth,height:n.naturalHeight},calculations:{fitWidth:a,fitHeight:a/l,finalWidth:r,finalHeight:m}}),this.$nextTick(()=>{console.log("Image should be visible now"),console.log("DOM elements:",{viewport:{width:t.offsetWidth,height:t.offsetHeight,display:getComputedStyle(t).display},mainContainer:{width:this.$refs.mainContainer.offsetWidth,height:this.$refs.mainContainer.offsetHeight,display:getComputedStyle(this.$refs.mainContainer).display},innerWrapper:{width:this.$refs.innerWrapper.offsetWidth,height:this.$refs.innerWrapper.offsetHeight,display:getComputedStyle(this.$refs.innerWrapper).display},image:{width:n.offsetWidth,height:n.offsetHeight,naturalWidth:n.naturalWidth,naturalHeight:n.naturalHeight,display:getComputedStyle(n).display}})});return}const s=(this.zoomLevel-1)*this.currentZoomStep,o=1+s/Math.max(this.mainContainerWidth,this.mainContainerHeight);this.innerWrapperWidth=this.mainContainerWidth*o,this.innerWrapperHeight=this.mainContainerHeight*o,console.log("Inner wrapper updated:",{zoomLevel:this.zoomLevel,scaleFactor:o,additionalPixels:s,mainContainer:{width:this.mainContainerWidth,height:this.mainContainerHeight},innerWrapper:{width:this.innerWrapperWidth,height:this.innerWrapperHeight}})})},get currentMainContainerWidth(){return console.log("Getting main container width:",this.mainContainerWidth),this.mainContainerWidth||"auto"},get currentMainContainerHeight(){return console.log("Getting main container height:",this.mainContainerHeight),this.mainContainerHeight||"auto"},get currentInnerWrapperWidth(){const t=this.innerWrapperWidth||this.mainContainerWidth;return console.log("Getting inner wrapper width:",t),t},get currentInnerWrapperHeight(){const t=this.innerWrapperHeight||this.mainContainerHeight;return console.log("Getting inner wrapper height:",t),t},handleWheel(t){t.preventDefault();const e=t.deltaY,i=1.1;e<0&&this.canZoomIn?this.zoomIn(i):e>0&&this.canZoomOut&&this.zoomOut(i)},handleArrowKeys(t){if(!this.isZoomed)return;t.preventDefault();const e=this.arrowKeyStep,i=Math.max(0,(this.innerWrapperWidth-this.mainContainerWidth)/2),n=Math.max(0,(this.innerWrapperHeight-this.mainContainerHeight)/2);switch(t.key){case"ArrowUp":this.panY=Math.min(n,this.panY+e);break;case"ArrowDown":this.panY=Math.max(-n,this.panY-e);break;case"ArrowLeft":this.panX=Math.min(i,this.panX+e);break;case"ArrowRight":this.panX=Math.max(-i,this.panX-e);break}console.log("Pan updated:",{panX:this.panX,panY:this.panY,maxPanX:i,maxPanY:n})},getImageCoordinates(t,e){const i=this.$refs.innerWrapper,n=this.$refs.image;if(!i||!n)return{x:0,y:0};i.getBoundingClientRect();const s=n.getBoundingClientRect(),o=t-s.left,a=e-s.top,h=o/s.width*100,l=a/s.height*100;return{x:Math.max(0,Math.min(100,h)),y:Math.max(0,Math.min(100,l))}},onImageLoad(){this.updateImageDimensions()}}}export{g as default};
