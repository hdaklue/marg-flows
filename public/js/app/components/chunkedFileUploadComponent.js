function u(n){return{uploading:!1,uploadingFiles:[],uploadedFiles:[],error:null,state:n.state,abortControllers:new Map,updatingState:!1,config:{acceptedFileTypes:n.acceptedFileTypes||[],chunkSize:n.chunkSize||5*1024*1024,chunkUploadUrl:n.chunkUploadUrl,chunkDeleteUrl:n.chunkDeleteUrl,chunkCancelUrl:n.chunkCancelUrl,isChunked:n.isChunked||!1,isDisabled:n.isDisabled||!1,isMultiple:n.isMultiple||!1,maxFiles:n.maxFiles||1,maxParallelUploads:n.maxParallelUploads||3,maxSize:n.maxSize,minSize:n.minSize,placeholder:n.placeholder,statePath:n.statePath,uploadingMessage:n.uploadingMessage||"Uploading...",storage:n.storage||{disk:"public",finalDir:"uploads"}},init(){this.loadExistingFiles(),this.$watch("state",()=>this.loadExistingFiles()),this.setupDragAndDrop(),window.addEventListener("beforeunload",()=>this.cleanup())},loadExistingFiles(){if(!this.state||this.updatingState)return;let e=Array.isArray(this.state)?this.state:[this.state];(this.uploadedFiles.length===0||e.length!==this.uploadedFiles.length)&&(this.uploadedFiles=e.map((s,i)=>({key:this.generateFileKey(),name:s,size:0,url:this.buildFileUrl(s),type:null})))},setupDragAndDrop(){let e=this.$el,s=this.$el.querySelector(".fi-fo-file-upload-dropzone");!e||!s||(["dragenter","dragover","dragleave","drop"].forEach(i=>{e.addEventListener(i,this.preventDefaults,!1)}),["dragenter","dragover"].forEach(i=>{e.addEventListener(i,()=>this.highlight(s),!1)}),["dragleave","drop"].forEach(i=>{e.addEventListener(i,()=>this.unhighlight(s),!1)}),e.addEventListener("drop",this.handleDrop.bind(this),!1))},preventDefaults(e){e.preventDefault(),e.stopPropagation()},highlight(e){e.classList.add("drag-over")},unhighlight(e){e.classList.remove("drag-over")},handleDrop(e){let i=e.dataTransfer.files;this.handleFiles(Array.from(i))},handleFileSelect(e){let s=Array.from(e.target.files);this.handleFiles(s),e.target.value=""},handleFiles(e){if(e.length===0)return;this.error=null;let s=this.validateFiles(e);if(!s.valid){this.error=s.error;return}this.startUploads(e)},validateFiles(e){let s=this.uploadedFiles.length+e.length;if(this.config.maxFiles&&s>this.config.maxFiles)return{valid:!1,error:`Maximum ${this.config.maxFiles} files allowed. You have ${this.uploadedFiles.length} files and are trying to add ${e.length} more.`};for(let i of e){if(this.config.maxSize&&i.size>this.parseSize(this.config.maxSize))return{valid:!1,error:`File "${i.name}" (${this.formatFileSize(i.size)}) exceeds maximum size of ${this.config.maxSize}`};if(this.config.minSize&&i.size<this.parseSize(this.config.minSize))return{valid:!1,error:`File "${i.name}" (${this.formatFileSize(i.size)}) is smaller than minimum size of ${this.config.minSize}`};if(this.config.acceptedFileTypes.length>0&&!this.config.acceptedFileTypes.some(t=>t.includes("/")?t.endsWith("/*")?i.type.startsWith(t.slice(0,-1)):i.type===t:i.name.toLowerCase().endsWith(t.toLowerCase())))return{valid:!1,error:`File "${i.name}" is not an accepted file type. Accepted types: ${this.config.acceptedFileTypes.join(", ")}`}}return{valid:!0}},async startUploads(e){this.uploading=!0;let s=e.map(t=>({id:this.generateFileKey(),file:t,name:t.name,size:t.size,type:t.type,progress:0,status:"pending",speed:null,uploadedBytes:0,chunks:[],uploadedChunks:0,totalChunks:this.config.isChunked?Math.ceil(t.size/this.config.chunkSize):1,startTime:null,lastProgressTime:null}));this.uploadingFiles=[...this.uploadingFiles,...s];let i=new Array(this.config.maxParallelUploads).fill(null),a=s.map(async t=>{await this.waitForSlot(i,t.id);try{await this.uploadFile(t);let l=this.uploadingFiles.findIndex(o=>o.id===t.id);l!==-1&&(this.uploadingFiles[l].status="completed",this.uploadingFiles[l].progress=100,this.uploadedFiles.push({key:t.id,name:t.name,size:t.size,type:t.type,url:this.uploadingFiles[l].url}))}catch(l){if(l.name!=="AbortError"){let o=this.uploadingFiles.findIndex(r=>r.id===t.id);o!==-1&&(this.uploadingFiles[o].status="error",this.uploadingFiles[o].error=l.message),console.error("Upload error:",l)}}finally{let l=i.findIndex(o=>o===t.id);l!==-1&&(i[l]=null)}});await Promise.allSettled(a),this.uploadingFiles=this.uploadingFiles.filter(t=>t.status!=="completed"),this.uploading=this.uploadingFiles.some(t=>t.status==="uploading"||t.status==="pending"),this.updateLivewireState()},async waitForSlot(e,s){return new Promise(i=>{let a=()=>{let t=e.findIndex(l=>l===null);t!==-1?(e[t]=s,i()):setTimeout(a,100)};a()})},async uploadFile(e){let s=this.uploadingFiles.findIndex(i=>i.id===e.id);s!==-1&&(this.uploadingFiles[s].status="uploading",this.uploadingFiles[s].startTime=Date.now(),this.uploadingFiles[s].lastProgressTime=this.uploadingFiles[s].startTime),this.config.isChunked&&e.file.size>this.config.chunkSize?await this.uploadFileInChunks(e):await this.uploadFileDirectly(e)},async uploadFileInChunks(e){let s=e.file,i=Math.ceil(s.size/this.config.chunkSize);e.totalChunks=i,e.chunks=new Array(i).fill(!1);for(let a=0;a<i;a++){if(this.abortControllers.has(e.id))throw new Error("Upload cancelled");let t=a*this.config.chunkSize,l=Math.min(t+this.config.chunkSize,s.size),o=s.slice(t,l);await this.uploadChunk(e,o,a,i);let r=this.uploadingFiles.findIndex(d=>d.id===e.id);r!==-1&&(this.uploadingFiles[r].chunks[a]=!0,this.uploadingFiles[r].uploadedChunks=this.uploadingFiles[r].chunks.filter(Boolean).length,this.uploadingFiles[r].uploadedBytes=this.uploadingFiles[r].uploadedChunks*this.config.chunkSize,this.uploadingFiles[r].progress=Math.round(this.uploadingFiles[r].uploadedChunks/i*100),this.updateSpeed(this.uploadingFiles[r]))}},async uploadFileDirectly(e){let s=new FormData;s.append("file",e.file),s.append("fileKey",e.id),s.append("name",e.file.name);let i=new AbortController;this.abortControllers.set(e.id,i);try{let a=await fetch(this.config.chunkUploadUrl,{method:"POST",body:s,signal:i.signal,headers:{"X-CSRF-TOKEN":this.getCsrfToken(),Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);let t=await a.json();if(!t.success)throw new Error(t.message||"Upload failed");let l=this.uploadingFiles.findIndex(o=>o.id===e.id);l!==-1&&(this.uploadingFiles[l].url=t.url,this.uploadingFiles[l].progress=100,this.uploadingFiles[l].uploadedBytes=e.file.size,this.updateSpeed(this.uploadingFiles[l]))}finally{this.abortControllers.delete(e.id)}},async uploadChunk(e,s,i,a){let t=new FormData;t.append("file",s),t.append("fileKey",e.id),t.append("chunk",i),t.append("chunks",a),t.append("name",e.file.name);let l=new AbortController;this.abortControllers.set(`${e.id}_${i}`,l);try{let o=await fetch(this.config.chunkUploadUrl,{method:"POST",body:t,signal:l.signal,headers:{"X-CSRF-TOKEN":this.getCsrfToken(),Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);let r=await o.json();if(!r.success)throw new Error(r.message||"Upload failed");r.completed&&(e.url=r.url)}finally{this.abortControllers.delete(`${e.id}_${i}`)}},updateSpeed(e){let s=Date.now(),i=s-e.lastProgressTime,a=(s-e.startTime)/1e3;if(i>=500&&a>0){let t=e.uploadedBytes/a;e.speed=this.formatFileSize(t),e.lastProgressTime=s}else a>0&&!e.speed&&(e.speed="calculating...")},async cancelUpload(e){Array.from(this.abortControllers.entries()).filter(([i])=>i.startsWith(e)).map(([,i])=>i).forEach(i=>{try{i.abort()}catch(a){console.debug("Controller abort error (expected):",a)}});try{await fetch(this.config.chunkCancelUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":this.getCsrfToken()},body:JSON.stringify({fileKey:e})})}catch(i){console.error("Error cancelling upload:",i)}this.uploadingFiles=this.uploadingFiles.filter(i=>i.id!==e),this.uploading=this.uploadingFiles.some(i=>i.status==="uploading"||i.status==="pending")},async cancelAllUploads(){let e=this.uploadingFiles.filter(t=>t.status==="uploading"||t.status==="pending").length;if(e===0||!confirm(`Are you sure you want to cancel all ${e} upload${e>1?"s":""}?`))return;this.abortControllers.forEach(t=>{try{t.abort()}catch(l){console.debug("Controller abort error (expected):",l)}}),this.abortControllers.clear();let a=this.uploadingFiles.filter(t=>t.status==="uploading"||t.status==="pending").map(async t=>{try{await fetch(this.config.chunkCancelUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":this.getCsrfToken()},body:JSON.stringify({fileKey:t.id})})}catch(l){console.error("Error cancelling upload:",l)}});await Promise.allSettled(a),this.uploadingFiles=this.uploadingFiles.filter(t=>t.status!=="uploading"&&t.status!=="pending"),this.uploading=!1},async retryUpload(e){let s=this.uploadingFiles.findIndex(a=>a.id===e);if(s===-1)return;let i=this.uploadingFiles[s];if(i.status==="error"){this.uploadingFiles[s].status="pending",this.uploadingFiles[s].progress=0,this.uploadingFiles[s].error=null,this.uploadingFiles[s].uploadedBytes=0,this.uploadingFiles[s].uploadedChunks=0,this.uploadingFiles[s].chunks=[],this.uploadingFiles[s].speed=null,this.uploading=!0;try{await this.uploadFile(i);let a=this.uploadingFiles.findIndex(t=>t.id===e);a!==-1&&(this.uploadingFiles[a].status="completed",this.uploadingFiles[a].progress=100,this.uploadedFiles.push({key:i.id,name:i.name,size:i.size,type:i.type,url:this.uploadingFiles[a].url}))}catch(a){if(a.name!=="AbortError"){let t=this.uploadingFiles.findIndex(l=>l.id===e);t!==-1&&(this.uploadingFiles[t].status="error",this.uploadingFiles[t].error=a.message)}}this.uploading=this.uploadingFiles.some(a=>a.status==="uploading"||a.status==="pending")}},async removeFile(e){let s=this.uploadedFiles.find(a=>a.key===e);if(!(!s||!confirm(`Are you sure you want to delete "${s.name}"?`)))try{let a=s.url||"";if(a.includes("/storage/")){let o=a.indexOf("/storage/");a=a.substring(o+9)}let t=await fetch(this.config.chunkDeleteUrl,{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":this.getCsrfToken()},body:JSON.stringify({fileKey:e,path:a})});if(!t.ok){let o=await t.text();throw new Error(`HTTP ${t.status}: ${t.statusText} - ${o}`)}let l=await t.json();if(!l.success)throw new Error(l.message||"Failed to delete file");this.uploadedFiles=this.uploadedFiles.filter(o=>o.key!==e),this.updateLivewireState()}catch(a){console.error("Error deleting file:",a),this.error=`Failed to delete file: ${a.message}`,setTimeout(()=>{this.error=null},5e3)}},updateLivewireState(){this.updatingState=!0;let e=this.uploadedFiles.map(s=>s.url&&s.url.includes("/storage/")?s.url.replace("/storage/","").split("/").pop():s.name);this.state=e,setTimeout(()=>{this.updatingState=!1},100)},cleanup(){try{this.cancelAllUploads()}catch(e){console.debug("Cleanup error (expected during page unload):",e)}},generateFileKey(){return Date.now().toString(36)+Math.random().toString(36).substring(2)},formatFileSize(e){if(e===0)return"0 Bytes";let s=1024,i=["Bytes","KB","MB","GB","TB"],a=Math.floor(Math.log(e)/Math.log(s));return parseFloat((e/Math.pow(s,a)).toFixed(2))+" "+i[a]},parseSize(e){let s={B:1,BYTES:1,KB:1024,MB:1048576,GB:1073741824,TB:1099511627776},i=e.match(/^(\d+(?:\.\d+)?)\s*(\w+)$/i);if(i){let a=parseFloat(i[1]),t=i[2].toUpperCase();return a*(s[t]||1)}return parseInt(e)||0},getCsrfToken(){return document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},buildFileUrl(e){let s=this.config.storage;return s.disk==="public"?`/storage/${s.finalDir}/${e}`:`/storage/${s.finalDir}/${e}`}}}export{u as default};
